name: Deploy to GKE

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    container:
      image: google/cloud-sdk:latest
    env:
      PROJECT_ID: scanales-191111
      SERVICE_ACCOUNT_NAME: github-actions-deployer
      GKE_CLUSTER_NAME: eventflow-cluster
      GKE_ZONE: us-central1
      GKE_NAMESPACE: acofitec
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Write GCP credentials
        env:
          GCP_SERVICE_ACCOUNT_KEY_JSON: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY_JSON }}
        run: echo "$GCP_SERVICE_ACCOUNT_KEY_JSON" | base64 -d > "$HOME/key.json"

      - name: Authenticate to Google Cloud
        run: |
          gcloud auth activate-service-account --key-file="$HOME/key.json"
          gcloud config set project "$PROJECT_ID"
          gcloud config set compute/zone "$GKE_ZONE"

      - name: Configure kubectl
        run: |
          gcloud container clusters get-credentials "$GKE_CLUSTER_NAME" --zone "$GKE_ZONE" --project "$PROJECT_ID"

      - name: Apply Kubernetes manifests
        run: |
          kubectl apply -n "$GKE_NAMESPACE" -f deployment/
          kubectl rollout restart deployment eventflow -n "$GKE_NAMESPACE"
