name: Deploy to VPS (Podman)

on:
  workflow_call:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Prepare SSH key
        env:
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
        run: |
          if [ -z "${VPS_SSH_KEY:-}" ]; then
            echo "VPS_SSH_KEY secret is required"; exit 1; fi
          install -m 700 -d ~/.ssh
          echo "${VPS_SSH_KEY}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Deploy via Podman on VPS
        env:
          VPS_HOST: ${{ vars.VPS_HOST }}
          VPS_USER: ${{ vars.VPS_USER }}
          VPS_PORT: ${{ vars.VPS_PORT || '22' }}
          APP_PORT: ${{ vars.APP_PORT || '8080' }}
          REGISTRY: ${{ vars.REGISTRY || 'quay.io/sergio_canales_e' }}
          IMAGE_NAME: ${{ vars.IMAGE_NAME || 'homedir' }}
          REF: ${{ vars.IMAGE_REF }}
        run: |
          if [ -z "${VPS_HOST}" ] || [ -z "${VPS_USER}" ] || [ -z "${REF}" ]; then
            echo "VPS_HOST, VPS_USER, and IMAGE_REF vars are required"; exit 1; fi
          echo "Using registry: ${REGISTRY:-unset}, image: ${IMAGE_NAME:-unset}"
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -p "${VPS_PORT:-22}" "${VPS_USER}@${VPS_HOST}" <<EOF
          set -euo pipefail
          IMAGE="${REF}"
          CONTAINER_NAME=homedir
          APP_PORT="${APP_PORT:-8080}"
          podman pull "$IMAGE"
          if podman ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}\$"; then
            podman stop "${CONTAINER_NAME}" || true
            podman rm "${CONTAINER_NAME}" || true
          fi
          podman run -d --name "${CONTAINER_NAME}" --restart=always -p "\${APP_PORT}:8080" "$IMAGE"
          EOF
