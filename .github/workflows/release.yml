name: Production Release

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      release_level:
        description: 'Release Level (auto calculates if empty)'
        required: false
        default: ''
        type: choice
        options:
          - ''
          - patch
          - minor
          - major

jobs:
  release:
    name: Tag & Deploy
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for changelog/version calc

      - name: Calculate Next Version
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          default_bump: patch
          custom_release_rules: feat:minor,fix:patch,chore:patch,refactor:patch,perf:patch
          release_branches: main
          tag_prefix: v
          dry_run: false # We allow it to tag, or we can tag manually. Let's let it tag.
          # If we want manual control, we can set dry_run: true and tag manually in next step.
          # For "auto versioning", let this action handle it.

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build with Maven
        working-directory: quarkus-app
        # Use the calculated version (new_tag includes v, clean_version does not? new_version usually has no v if configured, let's check docs or use strip)
        # Action outputs: new_tag (v1.0.0), new_version (1.0.0)
        run: ./mvnw package -Drevision=${{ steps.tag_version.outputs.new_version }} -DskipTests

      - name: Login to Quay.io
        uses: docker/login-action@v3
        with:
          registry: quay.io
          username: ${{ vars.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_PASSWORD }}

      - name: Build and Push Docker Image
        working-directory: quarkus-app
        env:
          IMAGE_NAME: ${{ vars.REGISTRY }}/${{ vars.IMAGE_NAME }}
          TAG: ${{ steps.tag_version.outputs.new_version }}
        run: |
          docker build -f src/main/docker/Dockerfile.jvm \
            -t $IMAGE_NAME:latest \
            -t $IMAGE_NAME:$TAG .
            
          docker push $IMAGE_NAME:latest
          docker push $IMAGE_NAME:$TAG
