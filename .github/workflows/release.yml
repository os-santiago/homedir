name: Production Release

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      release_level:
        description: 'Release Level (auto calculates if empty)'
        required: false
        default: ''
        type: choice
        options:
          - ''
          - patch
          - minor
          - major

jobs:
  release:
    name: Tag & Deploy
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    env:
      DEPLOY_HOST: ${{ vars.DEPLOY_SSH_HOST != '' && vars.DEPLOY_SSH_HOST || vars.VPS_HOST }}
      DEPLOY_USER: ${{ vars.DEPLOY_SSH_USER != '' && vars.DEPLOY_SSH_USER || vars.VPS_USER }}
      DEPLOY_PORT: ${{ vars.DEPLOY_SSH_PORT != '' && vars.DEPLOY_SSH_PORT || vars.VPS_PORT }}
      DEPLOY_COMMAND: ${{ vars.DEPLOY_SSH_COMMAND }}
      HEALTHCHECK_URL: ${{ vars.DEPLOY_HEALTHCHECK_URL }}
      DEPLOY_SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY != '' && secrets.DEPLOY_SSH_PRIVATE_KEY || secrets.VPS_SSH_KEY }}
      DEPLOY_SSH_KNOWN_HOSTS: ${{ secrets.DEPLOY_SSH_KNOWN_HOSTS }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for changelog/version calc

      - name: Calculate Next Version
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ github.token }}
          default_bump: patch
          custom_release_rules: feat:minor,fix:patch,chore:patch,refactor:patch,perf:patch
          release_branches: main
          tag_prefix: v
          dry_run: false # We allow it to tag, or we can tag manually. Let's let it tag.
          # If we want manual control, we can set dry_run: true and tag manually in next step.
          # For "auto versioning", let this action handle it.

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build with Maven
        working-directory: quarkus-app
        # Use the calculated version (new_tag includes v, clean_version does not? new_version usually has no v if configured, let's check docs or use strip)
        # Action outputs: new_tag (v1.0.0), new_version (1.0.0)
        run: ./mvnw package -Drevision=${{ steps.tag_version.outputs.new_version }} -DskipTests

      - name: Login to Quay.io
        uses: docker/login-action@v3
        with:
          registry: quay.io
          username: ${{ vars.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_PASSWORD }}

      - name: Build and Push Docker Image
        working-directory: quarkus-app
        env:
          IMAGE_NAME: ${{ vars.REGISTRY }}/${{ vars.IMAGE_NAME }}
          TAG: ${{ steps.tag_version.outputs.new_version }}
        run: |
          docker build -f src/main/docker/Dockerfile.jvm \
            -t $IMAGE_NAME:latest \
            -t $IMAGE_NAME:$TAG .
            
          docker push $IMAGE_NAME:latest
          docker push $IMAGE_NAME:$TAG

      - name: Resolve deploy configuration
        id: deploy_config
        run: |
          set -euo pipefail
          enabled="false"
          if [ -n "${DEPLOY_HOST:-}" ] && [ -n "${DEPLOY_USER:-}" ] && [ -n "${DEPLOY_SSH_PRIVATE_KEY:-}" ]; then
            enabled="true"
          fi
          echo "enabled=${enabled}" >> "$GITHUB_OUTPUT"

      - name: Start SSH agent
        if: ${{ steps.deploy_config.outputs.enabled == 'true' }}
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ env.DEPLOY_SSH_PRIVATE_KEY }}

      - name: Prepare SSH known_hosts
        if: ${{ steps.deploy_config.outputs.enabled == 'true' }}
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          port="${DEPLOY_PORT:-22}"
          if [ -n "${DEPLOY_SSH_KNOWN_HOSTS:-}" ]; then
            printf '%s\n' "$DEPLOY_SSH_KNOWN_HOSTS" >> ~/.ssh/known_hosts
          else
            ssh-keyscan -p "$port" "$DEPLOY_HOST" >> ~/.ssh/known_hosts 2>/dev/null
          fi
          chmod 644 ~/.ssh/known_hosts

      - name: Deploy to VPS via SSH
        if: ${{ steps.deploy_config.outputs.enabled == 'true' }}
        env:
          RELEASE_TAG: v${{ steps.tag_version.outputs.new_version }}
        run: |
          set -euo pipefail
          port="${DEPLOY_PORT:-22}"
          cmd="${DEPLOY_COMMAND:-/usr/local/bin/homedir-update.sh}"
          ssh -p "$port" "${DEPLOY_USER}@${DEPLOY_HOST}" "DEPLOY_TRIGGER=github-actions ${cmd} ${RELEASE_TAG}"

      - name: Verify production healthcheck
        if: ${{ steps.deploy_config.outputs.enabled == 'true' }}
        run: |
          set -euo pipefail
          url="${HEALTHCHECK_URL:-https://homedir.opensourcesantiago.io/q/health}"
          for attempt in $(seq 1 18); do
            if curl -fsS "$url" >/dev/null; then
              echo "healthcheck passed: $url"
              exit 0
            fi
            sleep 10
          done
          echo "healthcheck failed: $url" >&2
          exit 1

      - name: Deploy fallback notice
        if: ${{ steps.deploy_config.outputs.enabled != 'true' }}
        run: |
          echo "SSH deploy is not configured. Deployment will rely on homedir-auto-deploy.timer fallback on the VPS."
