name: PR Quality - Suite

on:
  pull_request:

permissions:
  contents: read
  security-events: write

concurrency:
  group: qa-suite-${{ github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  paths:
    name: Detect changed areas
    runs-on: ubuntu-latest
    outputs:
      app_changed: ${{ steps.filter.outputs.app }}
      deps_changed: ${{ steps.filter.outputs.deps }}
    steps:
      - uses: actions/checkout@v5
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            app:
              - 'quarkus-app/**'
              - '!**/*.md'
            deps:
              - '**/pom.xml'

  style:
    name: style
    runs-on: ubuntu-latest
    needs: paths
    if: needs.paths.outputs.app_changed == 'true'
    steps:
      - uses: actions/checkout@v5
      - name: Validate submodule clean
        run: git submodule status
      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: '21'
          cache: maven
      - name: Run Spotless
        id: spotless
        working-directory: quarkus-app
        run: ./mvnw --batch-mode spotless:check
      - name: Enforce clean working tree after format
        run: |
          if ! git diff --quiet; then
            echo "? Hay cambios de formato pendientes. Ejecuta './mvnw -pl quarkus-app spotless:apply' y subelos." >&2
            git diff
            exit 1
          fi

  static:
    name: static
    needs: paths
    if: needs.paths.outputs.app_changed == 'true'
    uses: ./.github/workflows/pr-static-analysis.yml
    secrets: inherit

  arch:
    name: arch
    needs: paths
    if: needs.paths.outputs.app_changed == 'true'
    uses: ./.github/workflows/pr-architecture-rules.yml
    secrets: inherit

  tests_cov:
    name: tests_cov
    needs: paths
    if: needs.paths.outputs.app_changed == 'true'
    uses: ./.github/workflows/pr-tests-coverage.yml
    secrets: inherit

  deps:
    name: deps
    needs: paths
    if: needs.paths.outputs.deps_changed == 'true'
    uses: ./.github/workflows/pr-deps-hygiene.yml
    secrets: inherit

  summary:
    name: summary
    needs: [paths, style, static, arch, tests_cov, deps]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Quality Suite Summary
        run: |
          echo "## PR Quality - Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Style:       ${{ needs.style.result || (needs.paths.outputs.app_changed == 'true' && 'skipped' || 'not-applicable') }}" >> $GITHUB_STEP_SUMMARY
          echo "- Static:      ${{ needs.static.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Arch:        ${{ needs.arch.result   || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Tests/Cover: ${{ needs.tests_cov.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Deps:        ${{ needs.deps.result   || (needs.paths.outputs.deps_changed == 'true' && 'skipped' || 'not-applicable') }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Los reportes detallados estan adjuntos como artifacts de cada job._" >> $GITHUB_STEP_SUMMARY
