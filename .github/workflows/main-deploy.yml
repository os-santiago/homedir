name: Main Pipeline Orchestrator

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch or tag to orchestrate (defaults to main)'
        required: false
        default: main

permissions:
  actions: write
  contents: read

jobs:
  orchestrate:
    runs-on: ubuntu-latest
    env:
      TARGET_REF: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref_name }}
    steps:
      - name: Dispatch native build workflow
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const ref = process.env.TARGET_REF || context.ref;
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-native.yml',
              ref,
            });

            core.info(`Dispatched build-native.yml for ref ${ref}`);
            await core.summary
              .addHeading('Orchestration')
              .addRaw(`Native build dispatched for **${ref}**.`)
              .addRaw('Publish workflow will run after the native build succeeds.', true)
              .write();

      - name: Record orchestration details
        run: |
          echo "Ref dispatched: ${TARGET_REF:-${GITHUB_REF_NAME}}"
