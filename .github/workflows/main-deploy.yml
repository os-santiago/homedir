---
name: Promote by Digest

on:
  push:
    branches: [main]

env:
  REGISTRY: ${{ vars.REGISTRY || 'quay.io/sergio_canales_e' }}
  IMAGE_NAME: ${{ vars.IMAGE_NAME || 'homedir' }}
  VPS_HOST: ${{ vars.VPS_HOST }}
  VPS_USER: ${{ vars.VPS_USER }}
  VPS_PORT: ${{ vars.VPS_PORT || '22' }}
  APP_PORT: ${{ vars.APP_PORT || '8080' }}
  GH_TOKEN: ${{ github.token }}

jobs:
  build:
    uses: ./.github/workflows/build-native.yml
    secrets: inherit

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Login to Quay
        env:
          QUAY_USERNAME: ${{ vars.QUAY_USERNAME }}
          QUAY_PASSWORD: ${{ secrets.QUAY_PASSWORD }}
        run: |
          echo "${QUAY_PASSWORD}" | docker login "${REGISTRY}" -u "${QUAY_USERNAME}" --password-stdin

      - name: Resolve image digest
        id: ref
        run: |
          set -euo pipefail
          sudo apt-get update -y && sudo apt-get install -y jq skopeo
          prs=$(gh api repos/${{ github.repository }}/commits/${{ github.sha }}/pulls -H "Accept: application/vnd.github+json")
          pr=$(echo "$prs" | jq -r '.[0].number // empty')
          if [ -n "$pr" ]; then
            head=$(echo "$prs" | jq -r '.[0].head.sha')
            prtag="docker://${REGISTRY}/${IMAGE_NAME}:pr-${pr}-${head}"
            headtag="docker://${REGISTRY}/${IMAGE_NAME}:${head}"
          else
            head="${{ github.sha }}"
            headtag="docker://${REGISTRY}/${IMAGE_NAME}:${head}"
          fi
          if [ -n "$pr" ] && DIGEST=$(skopeo inspect --format '{{.Digest}}' "$prtag" 2>/dev/null); then
            :
          elif DIGEST=$(skopeo inspect --format '{{.Digest}}' "$headtag" 2>/dev/null); then
            :
          else
            echo "No image found for $prtag or $headtag" >&2
            exit 1
          fi
          echo "ref=${REGISTRY}/${IMAGE_NAME}@${DIGEST}" | tee /tmp/ref.txt
          echo "ref=${REGISTRY}/${IMAGE_NAME}@${DIGEST}" >> $GITHUB_OUTPUT
          echo "REF=${REGISTRY}/${IMAGE_NAME}@${DIGEST}" >> $GITHUB_ENV

      - name: Cosign verify (optional)
        if: steps.ref.outcome == 'success' && env.COSIGN_PUBLIC_KEY != ''
        env:
          COSIGN_PUBLIC_KEY: ${{ secrets.COSIGN_PUBLIC_KEY }}
        run: |
          cosign verify --key <(printf "%s" "${COSIGN_PUBLIC_KEY}") "$REF" || exit 1

      - name: Prepare SSH key
        env:
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
        run: |
          if [ -z "${VPS_SSH_KEY:-}" ]; then
            echo "VPS_SSH_KEY secret is required"; exit 1; fi
          install -m 700 -d ~/.ssh
          echo "${VPS_SSH_KEY}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Deploy via Podman on VPS
        env:
          VPS_HOST: ${{ env.VPS_HOST }}
          VPS_USER: ${{ env.VPS_USER }}
          VPS_PORT: ${{ env.VPS_PORT }}
          APP_PORT: ${{ env.APP_PORT }}
          REF: ${{ env.REF }}
          OIDC_CLIENT_ID: ${{ secrets.OIDC_CLIENT_ID }}
          OIDC_CLIENT_SECRET: ${{ secrets.OIDC_CLIENT_SECRET }}
        run: |
          if [ -z "${VPS_HOST}" ] || [ -z "${VPS_USER}" ]; then
            echo "VPS_HOST and VPS_USER must be set as repository variables"; exit 1; fi
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -p "${VPS_PORT:-22}" "${VPS_USER}@${VPS_HOST}" <<EOF
          set -euo pipefail
          IMAGE="${REF}"
          CONTAINER_NAME=homedir
          APP_PORT="${APP_PORT:-8080}"
          DATA_DIR=/opt/homedir/data
          mkdir -p "${DATA_DIR}"
          chown -R 1001:1001 "${DATA_DIR}" || true
          podman pull "$IMAGE"
          if podman ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}\$"; then
            podman stop "${CONTAINER_NAME}" || true
            podman rm "${CONTAINER_NAME}" || true
          fi
          podman run -d --name "${CONTAINER_NAME}" --restart=always \
            -p "\${APP_PORT}:8080" \
            -e eventflow.data.dir=/work/data \
            -e OIDC_CLIENT_ID="${OIDC_CLIENT_ID}" \
            -e OIDC_CLIENT_SECRET="${OIDC_CLIENT_SECRET}" \
            -v "\${DATA_DIR}:/work/data:Z" \
            "$IMAGE"
          EOF
