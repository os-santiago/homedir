---
name: Publish Image

on:
  workflow_dispatch:
    inputs:
      image_ref:
        description: 'Image reference to publish/promote (e.g., quay.io/org/app@sha256:...)'
        required: false
      target_tag:
        description: 'Tag to publish (default: latest)'
        required: false
        default: latest
  workflow_run:
    workflows: ["Build Native"]
    types:
      - completed

permissions:
  contents: read
  actions: read

jobs:
  publish:
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main')
    runs-on: ubuntu-latest
    env:
      REGISTRY: ${{ vars.REGISTRY || 'quay.io/sergio_canales_e' }}
      IMAGE_NAME: ${{ vars.IMAGE_NAME || 'homedir' }}
      TARGET_TAG: latest
      INPUT_IMAGE_REF: ${{ github.event_name == 'workflow_dispatch' && inputs.image_ref || '' }}
      INPUT_TARGET_TAG: ${{ github.event_name == 'workflow_dispatch' && inputs.target_tag || '' }}
    steps:
      - name: Download image ref from build workflow
        if: github.event_name == 'workflow_run'
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: pr-image-ref
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: /tmp/image-ref

      - name: Resolve image reference
        id: ref
        run: |
          set -euo pipefail
          REF_FILE="/tmp/image-ref/image-ref.txt"
          REF_INPUT="${INPUT_IMAGE_REF}"
          INPUT_TAG="${INPUT_TARGET_TAG}"
          TARGET_TAG="${TARGET_TAG:-latest}"

          if [ -n "$INPUT_TAG" ]; then
            TARGET_TAG="$INPUT_TAG"
          fi

          if [ -f "$REF_FILE" ]; then
            REF="$(sed 's/^REF=//' "$REF_FILE")"
            echo "Ref from artifact: $REF"
          elif [ -n "$REF_INPUT" ]; then
            REF="$REF_INPUT"
            echo "Ref from input: $REF"
          else
            HEAD_SHA="${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}"
            IMAGE_REPO="${REGISTRY:+${REGISTRY}/}${IMAGE_NAME}"
            echo "Resolving digest for ${HEAD_SHA} in ${IMAGE_REPO}"
            sudo apt-get update -y
            sudo apt-get install -y skopeo jq
            DIGEST="$(skopeo inspect --format '{{.Digest}}' "docker://${IMAGE_REPO}:${HEAD_SHA}")"
            REF="${IMAGE_REPO}@${DIGEST}"
          fi

          REF="${REF#docker://}"
          REF="${REF#docker:}"

          if [ -z "$REF" ]; then
            echo "Unable to resolve image reference" >&2
            exit 1
          fi

          echo "REF=$REF" >> $GITHUB_ENV
          echo "TARGET_TAG=${TARGET_TAG}" >> $GITHUB_ENV
          echo "IMAGE_REPO=${REGISTRY:+${REGISTRY}/}${IMAGE_NAME}" >> $GITHUB_ENV
          echo "ref=${REF}" >> $GITHUB_OUTPUT

      - name: Install skopeo
        run: |
          sudo apt-get update -y
          sudo apt-get install -y skopeo

      - name: Login to registry
        env:
          QUAY_USERNAME: ${{ vars.QUAY_USERNAME }}
          QUAY_PASSWORD: ${{ secrets.QUAY_PASSWORD }}
        run: |
          if [ -z "${REGISTRY:-}" ]; then
            echo "Registry not configured; skipping login and publish."
            exit 0
          fi
          echo "$QUAY_PASSWORD" | docker login "$REGISTRY" -u "$QUAY_USERNAME" --password-stdin

      - name: Publish image tag
        if: env.REGISTRY != ''
        env:
          REF: ${{ env.REF }}
          TARGET_TAG: ${{ env.TARGET_TAG }}
          IMAGE_REPO: ${{ env.IMAGE_REPO }}
        run: |
          set -euo pipefail
          SRC="docker://${REF}"
          DEST="docker://${IMAGE_REPO}:${TARGET_TAG}"
          skopeo copy "$SRC" "$DEST"
          echo "Published ${DEST}"

      - name: Publish main alias
        if: github.event_name == 'workflow_run' && env.REGISTRY != ''
        env:
          REF: ${{ env.REF }}
          IMAGE_REPO: ${{ env.IMAGE_REPO }}
        run: |
          set -euo pipefail
          skopeo copy "docker://${REF}" "docker://${IMAGE_REPO}:main"

      - name: Summarize publication
        run: |
          {
            echo "Published ref: ${REF}"
            echo "Target tag: ${TARGET_TAG}"
            echo "Image repo: ${IMAGE_REPO}"
          } >> $GITHUB_STEP_SUMMARY
