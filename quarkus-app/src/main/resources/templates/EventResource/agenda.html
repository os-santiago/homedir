{#include layout/base}
{#title}
{#if event}{event.title} - Agenda{#else}Agenda{/if}
{/title}
{#breadcrumbs}
  {#if event}
  <a href="/">Eventos</a><span class="sep">/</span><a href="/event/{event.id}">{event.title}</a><span class="sep">/</span><span>Agenda</span>
  {/if}
{/breadcrumbs}
{#main}
{#if event}
<section class="event-agenda">
  <h1 class="page-title">Agenda de {event.title}</h1>
  <nav class="sub-nav">
    {#for d in event.dayList}
      <a href="#day{d}">D√≠a {d}</a>
    {/for}
  </nav>
  {#for d in event.dayList}
  <div class="card agenda-day" id="day{d}">
    <h2 class="card-title">D√≠a {d}</h2>
    {#for sc in event.scenarios}
      {#if !event.getAgendaForDayAndScenario(d, sc.id).isEmpty()}
      <h3>{sc.name}</h3>
      <ul class="agenda-list">
        {#for t in event.getAgendaForDayAndScenario(d, sc.id)}
          <li class="agenda-item">
            <span class="icon">üó£Ô∏è</span>{t.startTimeStr} - {t.endTimeStr} |
            <a href="/talk/{t.id}">{t.name}</a>
            {#if t.speaker}&nbsp;- {t.speaker.name}{#if t.coSpeaker} & {t.coSpeaker.name}{/if}{/if}
            {#if app:isAuthenticated()}
            <button class="btn btn-secondary btn-small add-talk-btn" data-id="{t.id}"{#if userTalks.contains(t.id)} disabled{/if}>
              {#if userTalks.contains(t.id)}<span class="icon">‚úî</span> Agregada{#else}<span class="icon">‚ûï</span> Agregar a mis charlas{/if}
            </button>
            {/if}
            <span class="badge {app:talkStateClass(t)}">{app:talkState(t)}</span>
          </li>
        {/for}
      </ul>
      {/if}
    {/for}
  </div>
  {/for}
  <a href="/event/{event.id}" class="btn">Volver al evento</a>
</section>
<script>
(function() {
  document.querySelectorAll('.add-talk-btn').forEach(btn => {
    if (btn.disabled) {
      btn.classList.add('btn-secondary');
      return;
    }
    btn.addEventListener('click', async () => {
      if (btn.disabled) return;
      try {
        const res = await fetch('/private/profile/add/' + btn.dataset.id, {
          method: 'POST',
          headers: { 'Accept': 'application/json' }
        });
        if (res.ok) {
          const data = await res.json();
          if (data.status === 'added') {
            showNotification('success', 'Charla agregada. <a href="/private/profile">Ver en Mis Charlas</a>');
          } else if (data.status === 'exists') {
            showNotification('info', 'La charla ya estaba registrada. <a href="/private/profile">Ver en Mis Charlas</a>');
          }
          btn.disabled = true;
          btn.classList.add('btn-secondary');
          btn.innerHTML = '<span class="icon">‚úî</span> Agregada';
        } else {
          showNotification('error', 'Ocurri√≥ un error al registrar la charla');
        }
      } catch (e) {
        showNotification('error', 'Ocurri√≥ un error al registrar la charla');
      }
    });
  });
})();
</script>
{#else}
<p class="no-events">Evento no encontrado.</p>
{/if}
{/main}
{/include}
