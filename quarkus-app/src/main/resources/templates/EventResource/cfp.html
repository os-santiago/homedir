{#include layout/main activePage="eventos"}
{@java.lang.Boolean userAuthenticated}
{@java.lang.String userName}
{@com.scanales.eventflow.cfp.CfpFormCatalog cfpCatalog}
{@java.lang.Boolean cfpTestingModeEnabled}
{#title}
{#if event}
{i18n:events_cfp_page_title(event.title)}
{#else}
{i18n:events_cfp_not_found_title}
{/if}
{/title}

{#body}
{#if event}
<header class="page-header">
  <div class="section-header">
    <p class="section-subtitle">
      <a href="/event/{event.id}" class="hd-link">← {i18n:events_cfp_back_to_event}</a>
    </p>
    <p class="section-subtitle">{i18n:events_cfp_eyebrow}</p>
    <h1 class="public-title">{i18n:events_cfp_heading}</h1>
  </div>
  <p class="section-subtitle">{i18n:events_cfp_intro(event.title)}</p>
</header>

<section class="page-grid">
  <div class="cfp-view-switch" style="grid-column: 1 / -1;">
    <button id="cfpShowNewBtn" type="button" class="btn login-btn-nav cfp-view-btn is-active">{i18n:events_cfp_tab_new_proposal}</button>
    <button id="cfpShowMineBtn" type="button" class="btn login-btn-nav cfp-view-btn">{i18n:events_cfp_tab_my_proposals}</button>
  </div>

  <article id="cfpSectionNew" class="section-card" style="grid-column: 1 / -1;">
    <h2 style="margin-top: 0;">{i18n:events_cfp_submit_title}</h2>
    <p class="section-subtitle" style="margin-bottom: 1rem;">{i18n:events_cfp_submit_desc}</p>

    {#if cfpTestingModeEnabled}
    <div class="cfp-testing-banner" role="note" aria-label="{i18n:events_cfp_testing_aria}">
      <span class="cfp-testing-badge">{i18n:events_cfp_testing_badge}</span>
      <div>
        <p class="cfp-testing-title">{i18n:events_cfp_testing_title}</p>
        <p class="cfp-testing-desc">{i18n:events_cfp_testing_desc}</p>
      </div>
    </div>
    {/if}

    {#if userAuthenticated}
    <form id="cfpForm" data-user-scope="{userName}">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 0.9rem;">
        <div class="form-group" style="grid-column: 1 / -1;">
          <label class="form-label" for="cfpTitle">{i18n:events_cfp_form_title}</label>
          <input id="cfpTitle" name="title" class="form-input" maxlength="160" required>
        </div>
        <div class="form-group" style="grid-column: 1 / -1;">
          <label class="form-label" for="cfpSummary">{i18n:events_cfp_form_summary}</label>
          <textarea id="cfpSummary" name="summary" class="form-textarea" rows="2" maxlength="360"></textarea>
        </div>
        <div class="form-group" style="grid-column: 1 / -1;">
          <label class="form-label" for="cfpAbstract">{i18n:events_cfp_form_abstract}</label>
          <textarea id="cfpAbstract" name="abstractText" class="form-textarea" rows="6" maxlength="5000" required></textarea>
        </div>
        <div class="form-group">
          <label class="form-label" for="cfpLevel">{i18n:events_cfp_form_level}</label>
          <select id="cfpLevel" name="level" class="form-select" required>
            <option value="">{i18n:events_cfp_form_select_placeholder}</option>
            {#for option in cfpCatalog.levels}
            <option value="{option.value}">{option.label}</option>
            {/for}
          </select>
        </div>
        <div class="form-group">
          <label class="form-label" for="cfpFormat">{i18n:events_cfp_form_format}</label>
          <select id="cfpFormat" name="format" class="form-select" required>
            <option value="">{i18n:events_cfp_form_select_placeholder}</option>
            {#for option in cfpCatalog.formats}
            <option value="{option.value}" data-duration="{cfpDurationByFormat.get(option.value)}">{option.label}</option>
            {/for}
          </select>
        </div>
        <div class="form-group">
          <label class="form-label" for="cfpDuration">{i18n:events_cfp_form_duration}</label>
          <select id="cfpDuration" name="durationMin" class="form-select" required disabled>
            <option value="">{i18n:events_cfp_form_select_placeholder}</option>
            {#for option in cfpCatalog.durations}
            <option value="{option.value}">{option.label}</option>
            {/for}
          </select>
        </div>
        <div class="form-group">
          <label class="form-label" for="cfpLanguage">{i18n:events_cfp_form_language}</label>
          <select id="cfpLanguage" name="language" class="form-select" required>
            <option value="">{i18n:events_cfp_form_select_placeholder}</option>
            {#for option in cfpCatalog.languages}
            <option value="{option.value}">{option.label}</option>
            {/for}
          </select>
        </div>
        <div class="form-group" style="grid-column: 1 / -1;">
          <label class="form-label" for="cfpTrack">{i18n:events_cfp_form_track}</label>
          <select id="cfpTrack" name="track" class="form-select" required>
            <option value="">{i18n:events_cfp_form_select_placeholder}</option>
            {#for option in cfpCatalog.tracks}
            <option value="{option.value}">{option.label}</option>
            {/for}
          </select>
        </div>
        <div class="form-group" style="grid-column: 1 / -1;">
          <label class="form-label" for="cfpLinks">{i18n:events_cfp_form_links}</label>
          <input id="cfpLinks" name="links" class="form-input" placeholder="https://sessionize.com/your-session, https://github.com/...">
        </div>
      </div>
      <div class="form-actions">
        <button id="cfpSubmitBtn" type="button" class="btn btn-primary">{i18n:events_cfp_form_submit}</button>
        <button id="cfpAutofillBtn" type="button" class="btn login-btn-nav">{i18n:events_cfp_autofill_last}</button>
      </div>
      <p id="cfpQuotaHint" class="form-hint cfp-quota-hint"></p>
    </form>
    <p id="cfpFeedback" class="form-hint" hidden></p>
    {#else}
    <p class="section-subtitle">{i18n:events_cfp_login_required}</p>
    <a href="/private/login-callback?redirect=/event/{event.id}/cfp" class="btn-primary">{i18n:events_cfp_login_btn}</a>
    {/if}
  </article>

  <article id="cfpSectionMine" class="section-card cfp-section-hidden" style="grid-column: 1 / -1;">
    <div style="display: flex; justify-content: space-between; align-items: center; gap: 0.8rem; flex-wrap: wrap;">
      <div>
        <h2 style="margin: 0;">{i18n:events_cfp_my_submissions_title}</h2>
        {#if userAuthenticated}
        <p id="cfpCountLabel" class="form-hint cfp-count-label">0/2 {i18n:events_cfp_proposals_unit}</p>
        {/if}
      </div>
      {#if userAuthenticated}
      <button id="cfpReloadBtn" type="button" class="btn login-btn-nav">{i18n:events_cfp_refresh}</button>
      {/if}
    </div>
    <div class="cfp-status-guide">
      <p><span class="cfp-status-badge cfp-status-pending">{i18n:events_cfp_status_pending}</span> {i18n:events_cfp_status_desc_pending}</p>
      <p><span class="cfp-status-badge cfp-status-under_review">{i18n:events_cfp_status_under_review}</span> {i18n:events_cfp_status_desc_under_review}</p>
      <p><span class="cfp-status-badge cfp-status-accepted">{i18n:events_cfp_status_accepted}</span> {i18n:events_cfp_status_desc_accepted}</p>
      <p><span class="cfp-status-badge cfp-status-rejected">{i18n:events_cfp_status_rejected}</span> {i18n:events_cfp_status_desc_rejected}</p>
    </div>
    <div id="cfpMineList" class="cfp-submission-list" style="margin-top: 0.9rem;">
      {#if userAuthenticated}
      <p class="form-hint">{i18n:events_cfp_loading}</p>
      {#else}
      <p class="form-hint">{i18n:events_cfp_login_to_view}</p>
      {/if}
    </div>
  </article>
</section>

<div id="cfpSubmittingOverlay" class="cfp-submitting-overlay" hidden>
  <div class="section-card cfp-submitting-modal" role="status" aria-live="polite">
    <span class="cfp-submitting-spinner" aria-hidden="true"></span>
    <div>
      <p class="cfp-submitting-title">{i18n:events_cfp_submitting_title}</p>
      <p class="cfp-submitting-desc">{i18n:events_cfp_submitting_desc}</p>
    </div>
  </div>
</div>

<style>
  .cfp-view-switch {
    display: flex;
    gap: 0.6rem;
    flex-wrap: wrap;
  }

  .cfp-submitting-overlay {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1.25rem;
    background: rgba(10, 10, 10, 0.7);
    backdrop-filter: blur(6px);
  }

  /* Ensure HTML `hidden` works even if we define display:flex above. */
  .cfp-submitting-overlay[hidden] {
    display: none;
  }

  .cfp-submitting-modal {
    width: min(520px, 100%);
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 0.9rem;
    align-items: center;
    margin: 0;
  }

  .cfp-submitting-spinner {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    border: 3px solid rgba(255, 255, 255, 0.15);
    border-top-color: rgba(255, 213, 79, 0.85);
    border-right-color: rgba(255, 213, 79, 0.25);
    box-shadow: 0 0 18px rgba(255, 213, 79, 0.22);
    animation: cfpSpin 0.75s linear infinite, cfpPulse 1.2s ease-in-out infinite;
  }

  .cfp-submitting-title {
    margin: 0;
    font-weight: 800;
    letter-spacing: 0.02em;
  }

  .cfp-submitting-desc {
    margin: 0.25rem 0 0;
    opacity: 0.9;
    font-size: 0.92rem;
  }

  @keyframes cfpSpin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  @keyframes cfpPulse {
    0%, 100% { opacity: 0.65; filter: saturate(1); }
    50% { opacity: 1; filter: saturate(1.25); }
  }

  @media (prefers-reduced-motion: reduce) {
    .cfp-submitting-spinner {
      /* Keep a subtle indicator even in reduced-motion environments. */
      animation: cfpSpin 2.4s linear infinite;
    }
  }

  .cfp-view-btn.is-active {
    border-color: rgba(255, 213, 79, 0.7);
    background: rgba(255, 213, 79, 0.16);
  }

  .cfp-section-hidden {
    display: none;
  }

  .cfp-count-label {
    margin: 0.35rem 0 0;
  }

  .cfp-status-guide {
    margin-top: 0.9rem;
    display: grid;
    gap: 0.4rem;
  }

  .cfp-status-guide p {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.45rem;
    font-size: 0.85rem;
    opacity: 0.92;
  }
  .cfp-submission-item {
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: var(--radius-sm);
    padding: 0.8rem;
    background: rgba(255, 255, 255, 0.03);
    margin-bottom: 0.7rem;
  }

  .cfp-submission-head {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .cfp-status-badge {
    display: inline-flex;
    align-items: center;
    border-radius: 999px;
    padding: 0.15rem 0.55rem;
    border: 1px solid rgba(255, 255, 255, 0.24);
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .cfp-status-pending {
    border-color: rgba(255, 215, 0, 0.7);
    background: rgba(255, 215, 0, 0.14);
  }

  .cfp-status-under_review {
    border-color: rgba(120, 185, 255, 0.7);
    background: rgba(120, 185, 255, 0.14);
  }

  .cfp-status-accepted {
    border-color: rgba(114, 255, 159, 0.7);
    background: rgba(114, 255, 159, 0.14);
  }

  .cfp-status-rejected,
  .cfp-status-withdrawn {
    border-color: rgba(255, 126, 126, 0.75);
    background: rgba(255, 126, 126, 0.14);
  }

  .cfp-meta-line {
    margin-top: 0.4rem;
    font-size: 0.82rem;
    opacity: 0.8;
  }

  .cfp-quota-hint {
    margin-top: 0.3rem;
  }

  .cfp-submission-actions {
    margin-top: 0.7rem;
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .cfp-testing-banner {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 0.75rem;
    align-items: start;
    padding: 0.75rem;
    margin: 0 0 1rem 0;
    border-radius: var(--radius-sm);
    border: 1px solid rgba(255, 213, 79, 0.45);
    background: rgba(255, 213, 79, 0.08);
  }

  .cfp-testing-badge {
    display: inline-flex;
    align-items: center;
    border-radius: 999px;
    padding: 0.15rem 0.55rem;
    border: 1px solid rgba(255, 213, 79, 0.7);
    background: rgba(255, 213, 79, 0.14);
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    height: fit-content;
    margin-top: 0.1rem;
  }

  .cfp-testing-title {
    margin: 0;
    font-weight: 700;
  }

  .cfp-testing-desc {
    margin: 0.25rem 0 0;
    font-size: 0.9rem;
    opacity: 0.9;
  }
</style>

<script>
  (() => {
    const isAuth = {#if userAuthenticated}true{#else}false{/if};
    const sectionNew = document.getElementById("cfpSectionNew");
    const sectionMine = document.getElementById("cfpSectionMine");
    const showNewBtn = document.getElementById("cfpShowNewBtn");
    const showMineBtn = document.getElementById("cfpShowMineBtn");

    function setActiveSection(view) {
      const mineVisible = view === "mine";
      sectionNew?.classList.toggle("cfp-section-hidden", mineVisible);
      sectionMine?.classList.toggle("cfp-section-hidden", !mineVisible);
      showNewBtn?.classList.toggle("is-active", !mineVisible);
      showMineBtn?.classList.toggle("is-active", mineVisible);
    }

    showNewBtn?.addEventListener("click", () => setActiveSection("new"));
    showMineBtn?.addEventListener("click", () => setActiveSection("mine"));
    setActiveSection(window.location.hash === "#my-proposals" ? "mine" : "new");

    if (!isAuth) {
      return;
    }

    const eventId = "{event.id}";
    const form = document.getElementById("cfpForm");
    const userScopeRaw = form ? String(form.dataset.userScope || "") : "";
    const userScope = String(userScopeRaw || "").trim().toLowerCase();
    const storageScope = userScope || "authenticated";
    const draftStorageKey = "homedir.cfp.draft." + eventId + "." + storageScope;
    const lastStorageKey = "homedir.cfp.last." + eventId + "." + storageScope;

    const endpoint = "/api/events/" + encodeURIComponent(eventId) + "/cfp/submissions";
    const mineEndpoint = endpoint + "/mine?limit=20&offset=0";
    const configEndpoint = endpoint + "/config";
    const submitBtn = document.getElementById("cfpSubmitBtn");
    const autofillBtn = document.getElementById("cfpAutofillBtn");
    const reloadBtn = document.getElementById("cfpReloadBtn");
    const feedback = document.getElementById("cfpFeedback");
    const quotaHint = document.getElementById("cfpQuotaHint");
    const countLabel = document.getElementById("cfpCountLabel");
    const mineList = document.getElementById("cfpMineList");
    const formatSelect = document.getElementById("cfpFormat");
    const durationSelect = document.getElementById("cfpDuration");
    const languageSelect = document.getElementById("cfpLanguage");
    const submittingOverlay = document.getElementById("cfpSubmittingOverlay");

    let bodyOverflowBeforeSubmit = null;

    function setSubmitting(isSubmitting) {
      if (!submittingOverlay) {
        return;
      }
      const value = Boolean(isSubmitting);
      submittingOverlay.hidden = !value;

      if (value) {
        bodyOverflowBeforeSubmit = document.body.style.overflow;
        document.body.style.overflow = "hidden";
      } else if (bodyOverflowBeforeSubmit !== null) {
        document.body.style.overflow = bodyOverflowBeforeSubmit;
        bodyOverflowBeforeSubmit = null;
      }
      // Do not disable form controls here: disabled fields are excluded from FormData(),
      // which caused submissions to be sent without `title` and fail with invalid_title.
      if (submitBtn && value) {
        submitBtn.disabled = true;
      }
    }

    let proposalLimit = 2;
    let mineItems = [];
    let submitInFlight = false;

    const labels = {
      pending: "{i18n:events_cfp_status_pending}",
      under_review: "{i18n:events_cfp_status_under_review}",
      accepted: "{i18n:events_cfp_status_accepted}",
      rejected: "{i18n:events_cfp_status_rejected}",
      withdrawn: "{i18n:events_cfp_status_withdrawn}"
    };

    const errorLabels = {
      duplicate_title: "{i18n:events_cfp_error_duplicate_title}",
      proposal_limit_reached: "{i18n:events_cfp_error_limit_reached}"
    };

    function buildOptionMap(selectId) {
      const map = new Map();
      const select = document.getElementById(selectId);
      if (!select) {
        return map;
      }
      Array.from(select.options || []).forEach((option) => {
        if (option.value) {
          map.set(option.value, option.textContent ? option.textContent.trim() : option.value);
        }
      });
      return map;
    }

    function resolveLabel(map, value) {
      if (!value) {
        return "";
      }
      return map.get(value) || value;
    }

    const levelLabels = buildOptionMap("cfpLevel");
    const formatLabels = buildOptionMap("cfpFormat");
    const languageLabels = buildOptionMap("cfpLanguage");
    const trackLabels = buildOptionMap("cfpTrack");

    const durationByFormat = {};
    if (formatSelect) {
      Array.from(formatSelect.options || []).forEach((option) => {
        const key = String(option.value || "").trim();
        const raw = String(option.dataset?.duration || "").trim();
        const parsed = Number.parseInt(raw, 10);
        if (key && Number.isFinite(parsed)) {
          durationByFormat[key] = parsed;
        }
      });
    }

    function syncDurationFromFormat() {
      if (!durationSelect) {
        return;
      }
      const formatValue = formatSelect ? String(formatSelect.value || "") : "";
      const mappedDuration = durationByFormat[formatValue];
      if (!mappedDuration) {
        durationSelect.value = "";
        durationSelect.disabled = true;
        return;
      }
      durationSelect.value = String(mappedDuration);
      durationSelect.disabled = true;
    }

    function parseCsvInput(value) {
      if (!value) return [];
      return value
        .split(",")
        .map((item) => item.trim())
        .filter((item) => item.length > 0);
    }

    function showFeedback(message, isError) {
      if (!feedback) return;
      feedback.hidden = false;
      feedback.textContent = message;
      feedback.style.color = isError ? "var(--color-danger, #ff8b8b)" : "var(--color-accent, #ffd54f)";
    }

    function safeStorageGet(key) {
      try {
        return window.localStorage ? window.localStorage.getItem(key) : null;
      } catch (error) {
        return null;
      }
    }

    function safeStorageSet(key, value) {
      try {
        if (window.localStorage) {
          window.localStorage.setItem(key, value);
        }
      } catch (error) {
      }
    }

    function safeStorageRemove(key) {
      try {
        if (window.localStorage) {
          window.localStorage.removeItem(key);
        }
      } catch (error) {
      }
    }

    function formSnapshot() {
      if (!form) {
        return null;
      }
      const formData = new FormData(form);
      const duration = durationSelect ? Number.parseInt(String(durationSelect.value || ""), 10) : Number.NaN;
      const payload = {
        title: String(formData.get("title") || "").trim(),
        summary: String(formData.get("summary") || "").trim(),
        abstract_text: String(formData.get("abstractText") || "").trim(),
        level: String(formData.get("level") || "").trim(),
        format: String(formData.get("format") || "").trim(),
        duration_min: Number.isFinite(duration) ? duration : null,
        language: languageSelect ? String(languageSelect.value || "").trim() : String(formData.get("language") || "").trim(),
        track: String(formData.get("track") || "").trim(),
        links: parseCsvInput(String(formData.get("links") || ""))
      };
      return payload;
    }

    function saveDraftFromForm() {
      const snapshot = formSnapshot();
      if (!snapshot) {
        return;
      }
      safeStorageSet(draftStorageKey, JSON.stringify(snapshot));
    }

    function saveLastProposal(snapshot) {
      if (!snapshot) {
        return;
      }
      safeStorageSet(lastStorageKey, JSON.stringify(snapshot));
    }

    function applySnapshot(snapshot) {
      if (!snapshot || !form) {
        return false;
      }
      const setValue = (id, value) => {
        const field = document.getElementById(id);
        if (!field) {
          return;
        }
        field.value = value == null ? "" : String(value);
      };

      setValue("cfpTitle", snapshot.title || "");
      setValue("cfpSummary", snapshot.summary || "");
      setValue("cfpAbstract", snapshot.abstract_text || "");
      setValue("cfpLevel", snapshot.level || "");
      setValue("cfpFormat", snapshot.format || "");
      syncDurationFromFormat();
      setValue("cfpLanguage", snapshot.language || "");
      setValue("cfpTrack", snapshot.track || "");
      setValue("cfpLinks", Array.isArray(snapshot.links) ? snapshot.links.join(", ") : "");
      return true;
    }

    function restoreLastProposal() {
      const raw = safeStorageGet(lastStorageKey) || safeStorageGet(draftStorageKey);
      if (!raw) {
        showFeedback("{i18n:events_cfp_restore_empty}", true);
        return;
      }
      try {
        const parsed = JSON.parse(raw);
        if (!applySnapshot(parsed)) {
          showFeedback("{i18n:events_cfp_restore_empty}", true);
          return;
        }
        saveDraftFromForm();
        showFeedback("{i18n:events_cfp_restore_success}", false);
      } catch (error) {
        showFeedback("{i18n:events_cfp_restore_empty}", true);
      }
    }

    function clearDraft() {
      safeStorageRemove(draftStorageKey);
    }

    function formatDate(value) {
      if (!value) return "";
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return "";
      return date.toLocaleString();
    }

    function statusLabel(status) {
      return labels[status] || status || "";
    }

    function updateQuotaHint() {
      const submitted = mineItems ? mineItems.length : 0;
      const remaining = Math.max(0, proposalLimit - submitted);
      if (countLabel) {
        countLabel.textContent = submitted + "/" + proposalLimit + " {i18n:events_cfp_proposals_unit}";
      }
      if (quotaHint) {
        quotaHint.textContent =
          "{i18n:events_cfp_quota_prefix} " + proposalLimit + " · {i18n:events_cfp_quota_remaining} " + remaining + ".";
      }
      if (submitBtn) {
        submitBtn.disabled = remaining <= 0;
      }
    }

    async function loadConfig() {
      try {
        const response = await fetch(configEndpoint, { headers: { Accept: "application/json" } });
        if (!response.ok) {
          return;
        }
        const payload = await response.json();
        const configured = Number.parseInt(String(payload.max_per_user || ""), 10);
        if (Number.isFinite(configured) && configured > 0) {
          proposalLimit = configured;
        }
      } catch (error) {
      }
    }

    async function deleteSubmission(id) {
      if (!id) {
        return;
      }
      if (!window.confirm("{i18n:events_cfp_confirm_delete}")) {
        return;
      }
      try {
        const response = await fetch(endpoint + "/" + encodeURIComponent(id), {
          method: "DELETE",
          headers: { Accept: "application/json" }
        });
        if (!response.ok) {
          showFeedback("{i18n:events_cfp_error_delete}", true);
          return;
        }
        showFeedback("{i18n:events_cfp_success_delete}", false);
        await loadMine();
      } catch (error) {
        showFeedback("{i18n:events_cfp_error_delete}", true);
      }
    }

    function renderMine(items) {
      mineItems = Array.isArray(items) ? items : [];
      mineList.innerHTML = "";
      if (mineItems.length === 0) {
        const empty = document.createElement("p");
        empty.className = "form-hint";
        empty.textContent = "{i18n:events_cfp_empty_mine}";
        mineList.appendChild(empty);
        updateQuotaHint();
        return;
      }

      mineItems.forEach((item) => {
        const article = document.createElement("article");
        article.className = "cfp-submission-item";

        const head = document.createElement("div");
        head.className = "cfp-submission-head";
        const title = document.createElement("h3");
        title.style.margin = "0";
        title.textContent = item.title || "";
        head.appendChild(title);

        const badge = document.createElement("span");
        const status = item.status || "pending";
        badge.className = "cfp-status-badge cfp-status-" + status;
        badge.textContent = statusLabel(status);
        head.appendChild(badge);
        article.appendChild(head);

        if (item.summary) {
          const summary = document.createElement("p");
          summary.className = "cfp-meta-line";
          summary.textContent = item.summary;
          article.appendChild(summary);
        }

        const metaParts = [];
        const created = formatDate(item.created_at);
        if (created) metaParts.push(created);
        if (item.level) metaParts.push(resolveLabel(levelLabels, item.level));
        if (item.format) metaParts.push(resolveLabel(formatLabels, item.format));
        if (item.duration_min) metaParts.push(item.duration_min + " min");
        if (item.language) metaParts.push(resolveLabel(languageLabels, item.language));
        if (item.track) metaParts.push(resolveLabel(trackLabels, item.track));

        const meta = document.createElement("p");
        meta.className = "cfp-meta-line";
        meta.textContent = metaParts.join(" · ");
        article.appendChild(meta);

        const actions = document.createElement("div");
        actions.className = "cfp-submission-actions";
        const deleteBtn = document.createElement("button");
        deleteBtn.type = "button";
        deleteBtn.className = "btn login-btn-nav";
        deleteBtn.textContent = "{i18n:events_cfp_delete}";
        deleteBtn.addEventListener("click", () => deleteSubmission(item.id));
        actions.appendChild(deleteBtn);
        article.appendChild(actions);

        mineList.appendChild(article);
      });
      updateQuotaHint();
    }

    async function loadMine() {
      if (!mineList) return;
      try {
        mineList.innerHTML = '<p class="form-hint">{i18n:events_cfp_loading}</p>';
        const response = await fetch(mineEndpoint, { headers: { Accept: "application/json" } });
        if (!response.ok) {
          throw new Error("status_" + response.status);
        }
        const payload = await response.json();
        renderMine(payload.items || []);
      } catch (error) {
        mineList.innerHTML = '<p class="form-hint">{i18n:events_cfp_error_load}</p>';
        mineItems = [];
        updateQuotaHint();
      }
    }

    async function submitProposal(event) {
      if (event && typeof event.preventDefault === "function") {
        event.preventDefault();
      }
      if (event && typeof event.stopPropagation === "function") {
        event.stopPropagation();
      }
      if (event && typeof event.stopImmediatePropagation === "function") {
        event.stopImmediatePropagation();
      }

      if (!form) return;

      // Ensure we keep control on-page (no native submit navigation) and keep HTML validations.
      if (typeof form.checkValidity === "function" && !form.checkValidity()) {
        if (typeof form.reportValidity === "function") {
          form.reportValidity();
        }
        return;
      }

      if (mineItems.length >= proposalLimit) {
        showFeedback("{i18n:events_cfp_error_limit_reached}", true);
        updateQuotaHint();
        return;
      }

      const payload = formSnapshot();
      saveDraftFromForm();
      saveLastProposal(payload);

      if (submitInFlight) {
        return;
      }
      submitInFlight = true;

      setSubmitting(true);
      // Yield one frame to ensure the overlay renders before the network request.
      await new Promise((resolve) => window.requestAnimationFrame(resolve));

      try {
        const response = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json", Accept: "application/json" },
          body: JSON.stringify(payload)
        });
        if (!response.ok) {
          let message = "{i18n:events_cfp_error_submit}";
          try {
            const errPayload = await response.json();
            if (errPayload && errPayload.error) {
              message = errorLabels[errPayload.error] || (message + " (" + errPayload.error + ")");
            }
          } catch (e) {
          }
          showFeedback(message, true);
          return;
        }
        form.reset();
        syncDurationFromFormat();
        clearDraft();
        showFeedback("{i18n:events_cfp_success_submit}", false);
        setActiveSection("mine");
        await loadMine();
      } catch (error) {
        showFeedback("{i18n:events_cfp_error_submit}", true);
      } finally {
        submitInFlight = false;
        setSubmitting(false);
        updateQuotaHint();
      }
    }

    form?.querySelectorAll("input, textarea, select").forEach((element) => {
      element.addEventListener("input", saveDraftFromForm);
      element.addEventListener("change", saveDraftFromForm);
    });

    // Use capture so we can always prevent a native submit navigation (e.g. Enter key).
    form?.addEventListener("submit", submitProposal, { capture: true });
    submitBtn?.addEventListener("click", submitProposal);
    formatSelect?.addEventListener("change", () => {
      syncDurationFromFormat();
      saveDraftFromForm();
    });
    autofillBtn?.addEventListener("click", restoreLastProposal);
    reloadBtn?.addEventListener("click", loadMine);
    showMineBtn?.addEventListener("click", loadMine);
    window.addEventListener("beforeunload", saveDraftFromForm);

    syncDurationFromFormat();
    loadConfig().finally(() => {
      updateQuotaHint();
      loadMine().then(() => {
        const draftRaw = safeStorageGet(draftStorageKey);
        if (draftRaw) {
          try {
            const draft = JSON.parse(draftRaw);
            applySnapshot(draft);
          } catch (error) {
          }
        }
      });
    });
  })();
</script>
{#else}
<div class="page-container" style="display: flex; justify-content: center; align-items: center; min-height: 45vh;">
  <article class="section-card" style="text-align: center;">
    <span class="material-symbols-outlined" style="font-size: 3.2rem; opacity: 0.55;">event_busy</span>
    <h2>{i18n:events_cfp_not_found_title}</h2>
    <p>{i18n:events_cfp_not_found_desc}</p>
    <a href="/eventos" class="btn-primary">{i18n:nav_events}</a>
  </article>
</div>
{/if}
{/body}
{/include}
