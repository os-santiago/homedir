{#include layout/base}
{#title}
{#if event.id}
Editar Evento
{#else}
Nuevo Evento
{/if}
{/title}
{#breadcrumbs}<a href="/private/admin">Admin</a><span class="sep">/</span><a href="/private/admin/events">Eventos</a><span class="sep">/</span><span>{#if event.id}{event.title}{#else}Nuevo Evento{/if}</span>{/breadcrumbs}
{#main}
<section class="admin-page">
  <div class="admin-header">
    <div>
      <p class="section-subtitle">Evento</p>
      <h1 class="page-title">
      {#if event.id}
      Editar Evento
      {#else}
      Nuevo Evento
      {/if}
      </h1>
      {#if message}<p class="section-subtitle">{message}</p>{/if}
    </div>
  </div>
  <nav class="sub-nav">
    <a href="#event-info">Evento</a>
    {#if event.id}
    <a href="#scenarios">Escenarios</a>
    <a href="#talks">Charlas</a>
    <a href="#breaks">Breaks</a>
    <a href="#agenda">Agenda</a>
    {/if}
  </nav>
  <section id="event-info" class="admin-card admin-subsection">
    <h2 class="card-title">Datos del evento</h2>
    <form method="post" action="{#if event.id}/private/admin/events/{event.id}/edit{#else}/private/admin/events/new{/if}" class="admin-form">
      {#if event.id}
        <p class="item-id">ID: {event.id}</p>
      {/if}
      <div class="form-grid">
        <label for="title">Titulo
          <input id="title" name="title" type="text" value="{event.title}">
        </label>
        <label for="date">Fecha de realizaci√≥n
          <input id="date" name="date" type="date" value="{event.dateStr}">
        </label>
        <label for="timezone">Zona horaria
          <select id="timezone" name="timezone">
            {#for tz in app:commonTimezones()}
            <option value="{tz}"{#if tz == event.timezone} selected{/if}>{tz} ({app:zoneDetail(tz)})</option>
            {/for}
          </select>
        </label>
        <label for="days">D√≠as del evento
          <input id="days" name="days" type="number" min="1" max="10" value="{event.days}">
        </label>
        <label for="logoUrl">Logo URL
          <input id="logoUrl" name="logoUrl" type="url" value="{event.logoUrl}">
        </label>
        <label for="mapUrl">Mapa URL
          <input id="mapUrl" name="mapUrl" type="url" value="{event.mapUrl}">
        </label>
        <label for="website">Sitio Web
          <input id="website" name="website" type="url" value="{event.website}">
        </label>
        <label for="contactEmail">Correo de contacto
          <input id="contactEmail" name="contactEmail" type="email" value="{event.contactEmail}">
        </label>
        <label for="ticketsUrl">Link de entradas
          <input id="ticketsUrl" name="ticketsUrl" type="url" value="{event.ticketsUrl}">
        </label>
      </div>
      <label for="description">Descripcion
        <textarea id="description" name="description">{event.description}</textarea>
      </label>
      <p class="event-time-info">Horario calculado: {#if event.startTimeStr}{event.startTimeStr} - {event.endTimeStr}{#else}Sin charlas{/if}</p>
      <fieldset>
        <legend>Redes Sociales</legend>
        <div class="form-grid">
          <label for="twitter">Twitter/X
            <input id="twitter" name="twitter" type="url" value="{event.twitter}">
          </label>
          <label for="linkedin">LinkedIn
            <input id="linkedin" name="linkedin" type="url" value="{event.linkedin}">
          </label>
          <label for="instagram">Instagram
            <input id="instagram" name="instagram" type="url" value="{event.instagram}">
          </label>
        </div>
      </fieldset>
      <button type="submit" class="btn">Guardar</button>
    </form>
  </section>
  {#if event.id}
  <section id="scenarios" class="admin-card admin-subsection">
    <h2><span class="icon">üèüÔ∏è</span>Escenarios</h2>
    <div class="admin-table-wrapper">
      <table class="admin-table">
        <thead><tr><th>ID</th><th>Nombre</th><th>Acciones</th></tr></thead>
        <tbody>
        {#for sc in event.scenarios}
        <tr>
          <form method="post" action="/private/admin/events/{event.id}/scenario">
          <td>{sc.id}<input type="hidden" name="scenarioId" value="{sc.id}"></td>
          <td><input name="name" value="{sc.name}"></td>
          <td>
            <input name="features" value="{sc.features}" placeholder="Caracteristicas">
            <input name="location" value="{sc.location}" placeholder="Ubicacion">
            <button type="submit">Guardar</button>
          </form>
          <form method="post" action="/private/admin/events/{event.id}/scenario/{sc.id}/delete" style="display:inline" class="needs-confirm">
            <button type="submit">Eliminar</button>
          </form>
          </td>
        </tr>
        {/for}
        <tr>
          <form method="post" action="/private/admin/events/{event.id}/scenario">
          <td>Nuevo</td>
          <td><input name="name"></td>
          <td>
            <input name="features" placeholder="Caracteristicas">
            <input name="location" placeholder="Ubicacion">
            <button type="submit">Agregar</button>
          </td>
          </form>
        </tr>
        </tbody>
      </table>
    </div>
  </section>
  <section id="talks" class="admin-card admin-subsection">
    <h2><span class="icon">üó£Ô∏è</span>Charlas</h2>
    <div class="admin-table-wrapper">
      <table class="admin-table">
      <thead><tr><th>ID</th><th>Charla</th><th>Acciones</th></tr></thead>
      <tbody>
      {#for t in event.agenda}
      {#if !t.break}
      <tr>
      <form method="post" action="/private/admin/events/{event.id}/talk">
      <td>{t.id}<input type="hidden" name="talkId" value="{t.id}"></td>
      <td>{t.name}{#if !t.speakers.isEmpty()}<br><small>{t.getSpeakerNames()}</small>{/if}</td>
      <td>
      <select name="location">
      {#for sc in event.scenarios}
      <option value="{sc.id}"{#if sc.id == t.location} selected{/if}>{sc.name}</option>
      {/for}
      </select>
      <input name="startTime" type="time" value="{t.startTimeStr}">
      <select name="day">
      {#for d in event.dayList}
      <option value="{d}"{#if t.day == d} selected{/if}>D√≠a {d}</option>
      {/for}
      </select>
      <button type="submit">Guardar</button>
      </form>
      <form method="post" action="/private/admin/events/{event.id}/talk/{t.id}/delete" style="display:inline" class="needs-confirm">
      <button type="submit">Eliminar</button>
      </form>
      </td>
      </tr>
      {/if}
      {/for}
      <tr>
      <form method="post" action="/private/admin/events/{event.id}/talk">
      <td>Nuevo</td>
      <td>
        <select id="speakerSelect" name="speakerId">
          <option value="">Seleccione orador</option>
          {#for sp in speakers}
          <option value="{sp.id}">{sp.name}</option>
          {/for}
        </select>
        <select id="talkSelect" name="talkId">
          <option value="">Seleccione charla</option>
          {#for sp in speakers}
            {#for t in sp.talks}
            <option value="{t.id}" data-speaker="{sp.id}">{t.name}</option>
            {/for}
          {/for}
        </select>
      </td>
      <td>
      <select name="location">
      {#for sc in event.scenarios}
      <option value="{sc.id}">{sc.name}</option>
      {/for}
      </select>
      <input name="startTime" type="time">
      <select name="day">
      {#for d in event.dayList}
      <option value="{d}">D√≠a {d}</option>
      {/for}
      </select>
      <button type="submit">Agregar</button>
      </td>
      </form>
      </tr>
      </tbody>
      </table>
    </div>
    <script>
      (function(){
        const speakerSelect = document.getElementById('speakerSelect');
        const talkSelect = document.getElementById('talkSelect');
        function filterTalks(){
          const sid = speakerSelect.value;
          Array.from(talkSelect.options).forEach(opt => {
            if(!opt.value) return;
            opt.hidden = sid && opt.dataset.speaker !== sid;
          });
          talkSelect.value = '';
        }
        speakerSelect.addEventListener('change', filterTalks);
        filterTalks();
      })();
    </script>
  </section>
  <section id="breaks" class="admin-card admin-subsection">
    <h2><span class="icon">‚òï</span>Breaks</h2>
    <div class="admin-table-wrapper">
      <table class="admin-table">
        <thead><tr><th>ID</th><th>Break</th><th>Acciones</th></tr></thead>
        <tbody>
        {#for t in event.agenda}
        {#if t.break}
        <tr>
        <form method="post" action="/private/admin/events/{event.id}/break">
        <td>{t.id}<input type="hidden" name="breakId" value="{t.id}"></td>
        <td><input name="name" value="{t.name}"></td>
        <td>
          <input name="duration" type="number" min="1" value="{t.durationMinutes}">
          <select name="location">
          {#for sc in event.scenarios}
          <option value="{sc.id}"{#if sc.id == t.location} selected{/if}>{sc.name}</option>
          {/for}
          </select>
          <input name="startTime" type="time" value="{t.startTimeStr}">
          <select name="day">
          {#for d in event.dayList}
          <option value="{d}"{#if t.day == d} selected{/if}>D√≠a {d}</option>
          {/for}
          </select>
          <button type="submit">Guardar</button>
        </form>
        <form method="post" action="/private/admin/events/{event.id}/break/{t.id}/delete" style="display:inline" class="needs-confirm">
          <button type="submit">Eliminar</button>
        </form>
        </td>
        </tr>
        {/if}
        {/for}
        <tr>
        <form method="post" action="/private/admin/events/{event.id}/break">
        <td>Nuevo</td>
        <td><input name="name"></td>
        <td>
          <input name="duration" type="number" min="1">
          <select name="location">
          {#for sc in event.scenarios}
          <option value="{sc.id}">{sc.name}</option>
          {/for}
          </select>
          <input name="startTime" type="time">
          <select name="day">
          {#for d in event.dayList}
          <option value="{d}">D√≠a {d}</option>
          {/for}
          </select>
          <button type="submit">Agregar</button>
        </td>
        </form>
        </tr>
        </tbody>
      </table>
    </div>
  </section>
  <section id="agenda" class="admin-card admin-subsection">
    <h2><span class="icon">üóìÔ∏è</span>Agenda</h2>
    {#for d in event.dayList}
    <div class="agenda-day">
      <h3>D√≠a {d}</h3>
      {#for sc in event.scenarios}
        {#if !event.getAgendaForDayAndScenario(d, sc.id).isEmpty()}
        <h4>{sc.name}</h4>
        <ul class="agenda-list">
          {#for t in event.getAgendaForDayAndScenario(d, sc.id)}
            <li class="agenda-item"><span class="icon">{#if t.break}‚òï{#else}üó£Ô∏è{/if}</span>{t.startTimeStr} - {t.endTimeStr} | {t.name} <span class="badge {app:talkStateClass(t, event)}">{app:talkState(t, event)}</span></li>
          {/for}
        </ul>
        {/if}
      {/for}
    </div>
    {/for}
  </section>
  {/if}
  <div class="admin-card">
    <a href="/private/admin/events" class="btn btn-secondary">Volver a la administraci√≥n de Eventos</a>
  </div>
</section>
{/main}
{/include}
