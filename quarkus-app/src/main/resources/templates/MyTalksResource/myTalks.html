{#include layout/base}
{#title}Mis Charlas{/title}
{#main}
<h1>Mis Charlas</h1>
{#if events.isEmpty()}
<p>No has agregado ninguna charla.</p>
{#else}
{#for e in events}
  <h2 class="event-title">{e.event.title}</h2>
  {#for t in e.talks}
    <div class="talk-row" data-talk-id="{t.talk.id}" data-attended="{info.get(t.talk.id).attended}" data-rated="{info.get(t.talk.id).rating??}">
      <span class="talk-time">{t.talk.startTimeStr} - {t.talk.endTimeStr}</span>
      <span class="talk-title"><a href="/talk/{t.talk.id}">{t.talk.name}</a></span>
      <div class="speaker-avatars">
        {#for s in t.talk.speakers}
          <a href="/speaker/{s.id}" title="{s.name}">
            {#if app:validUrl(s.photoUrl)}
              <img src="{s.photoUrl}" alt="{s.name}" class="avatar">
            {#else}
              <span class="avatar placeholder">üë§</span>
            {/if}
          </a>
        {/for}
      </div>
      <span class="badge talk-state {app:talkStateClass(t.talk, t.event)}">{app:talkState(t.talk, t.event)}</span>
      <div class="talk-actions">
        <label class="attended-label" title="Asist√≠"><input type="checkbox" class="attended-checkbox" data-talk-id="{t.talk.id}" {#if info.get(t.talk.id).attended}checked{/if}></label>
        <select class="rating-select" data-talk-id="{t.talk.id}" title="Valorar">
          <option value="">‚òÖ</option>
          <option value="1" {#if info.get(t.talk.id).rating == 1}selected{/if}>1</option>
          <option value="2" {#if info.get(t.talk.id).rating == 2}selected{/if}>2</option>
          <option value="3" {#if info.get(t.talk.id).rating == 3}selected{/if}>3</option>
          <option value="4" {#if info.get(t.talk.id).rating == 4}selected{/if}>4</option>
          <option value="5" {#if info.get(t.talk.id).rating == 5}selected{/if}>5</option>
        </select>
        <button class="btn btn-secondary remove-talk" data-talk-id="{t.talk.id}" title="Eliminar">üóëÔ∏è</button>
      </div>
    </div>
  {/for}
{/for}
{/if}
<script>
(function() {
  const updateTalk = async (id, data) => {
    try {
      const res = await fetch('/private/profile/update/' + id, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify(data)
      });
      if (!res.ok) {
        showNotification('error', 'Error al guardar los cambios');
      }
    } catch (e) {
      showNotification('error', 'Error al guardar los cambios');
    }
  };

  document.querySelectorAll('.attended-checkbox').forEach(cb => {
    cb.addEventListener('change', () => {
      const id = cb.dataset.talkId;
      const attended = cb.checked;
      const row = cb.closest('.talk-row');
      if (row) {
        row.dataset.attended = attended ? 'true' : 'false';
      }
      updateTalk(id, { attended });
    });
  });

  document.querySelectorAll('.rating-select').forEach(sel => {
    sel.addEventListener('change', () => {
      const id = sel.dataset.talkId;
      const rating = sel.value ? parseInt(sel.value) : null;
      const row = sel.closest('.talk-row');
      if (row) {
        row.dataset.rated = rating ? 'true' : 'false';
      }
      updateTalk(id, { rating });
    });
  });

  document.querySelectorAll('.remove-talk').forEach(btn => {
    btn.addEventListener('click', async () => {
      if (!confirm('¬øEst√°s seguro?')) return;
      const id = btn.dataset.talkId;
      btn.disabled = true;
      try {
        const res = await fetch('/private/profile/remove/' + id, {
          method: 'POST',
          headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
          body: '{}'
        });
        if (res.ok) {
          const row = btn.closest('.talk-row');
          if (row) row.remove();
          showNotification('success', 'Charla eliminada de tu agenda');
        } else {
          showNotification('error', 'Ocurri√≥ un error al eliminar la charla');
        }
      } catch (e) {
        showNotification('error', 'Ocurri√≥ un error al eliminar la charla');
      } finally {
        btn.disabled = false;
      }
    });
  });
})();
</script>
{/main}
{/include}
