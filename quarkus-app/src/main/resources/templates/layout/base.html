<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{#insert title}EventFlow{/}</title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/css/notifications.css">
    <script src="/js/app.js" defer></script>
    <script src="/js/notifications.js" defer></script>
</head>
<body>
<a href="#main-content" class="skip-link">Ir al contenido principal</a>
<header class="nav-menu" id="nav-menu" aria-label="Principal">
    <a href="/" class="nav-logo"><h2 class="title">EventFlow</h2></a>
    <button id="menuToggle" class="menu-toggle" data-menu-toggle aria-label="MenÃº" aria-controls="primary-navigation" aria-expanded="false">&#9776;</button>
    <div class="nav-links" id="primary-navigation" data-primary-navigation hidden>
        <a href="/" data-nav-link>Inicio</a>
        {#if app:isAuthenticated()}
            {#if app:isAdmin()}
                <a href="/private/admin" data-nav-link>Admin</a>
            {/if}
            <a href="/notifications/center" class="notifications-bell" aria-label="Notificaciones" aria-controls="notifications-center" data-nav-link>
                <span class="icon" aria-hidden="true">ðŸ””</span>
                <span class="badge" data-notifications-badge aria-hidden="true" hidden></span>
                <span class="sr-only" data-notifications-sr aria-live="polite"></span>
            </a>
            <div class="user-menu" data-user-menu>
                <button id="userMenuBtn" class="user-menu-btn" data-user-menu-btn aria-label="Usuario" aria-expanded="false" aria-controls="userDropdown">
                    {#if app:userAvatar()}
                        <img src="{app:userAvatar()}" alt="{app:userName()}" class="avatar" />
                    {#else}
                        <span class="avatar placeholder">ðŸ‘¤</span>
                    {/if}
                    <span class="user-name">{app:userName()}</span>
                </button>
                <div class="dropdown" id="userDropdown" hidden>
                    <a href="/private/profile">Perfil</a>
                    <a href="/logout">Salir</a>
                </div>
            </div>
        {#else}
            <a href="/login" class="btn" data-nav-link>Ingresar</a>
        {/if}
    </div>
</header>
<nav class="breadcrumbs" aria-label="Ruta de navegaciÃ³n">{#insert breadcrumbs}{/}</nav>
<div id="notification" class="notification hidden" role="alert"></div>
<div id="loading" class="loading hidden"><div class="spinner"></div></div>
<main id="main-content" class="container">
    {#if version?? || links??}
        {#include partials/project-header version=version stats=stats links=links /}
    {/if}
    {#insert main}{/}
</main>
<footer>
    <div class="container">
        <p>&copy; {app:currentYear()} EventFlow &ndash; v{app:version()}</p>
    </div>
</footer>

{#include fragments/toasts.qute.html/}
<script>
window.addEventListener('DOMContentLoaded', () => {
  if (!{app:isAuthenticated()}) return;
  (function(){
  const useSSE = !!window.EventSource;
  let since = Date.now();

  function onDTO(dto){
    since = Math.max(since, dto.createdAt || Date.now());
    if (window.EventFlowNotifications && typeof window.EventFlowNotifications.accept === 'function') {
      window.EventFlowNotifications.accept(dto);
    }
    if (window.__metrics && window.__metrics.count) {
      window.__metrics.count('ui.notifications.received');
    }
  }

  function startSSE(){
    try {
      const es = new EventSource('/api/notifications/stream', { withCredentials: true });
      es.onmessage = (ev) => {
        const dto = JSON.parse(ev.data);
        if (dto && dto.type !== 'HEARTBEAT') onDTO(dto);
      };
      es.onopen = () => { if(window.__metrics) window.__metrics.count('ui.notifications.sse.connected'); };
      es.onerror = () => { es.close(); if(window.__metrics) window.__metrics.count('ui.notifications.sse.fallback_polling'); startPolling(); };
    } catch(e) { startPolling(); }
  }

  function startPolling(){
    if(window.__metrics) window.__metrics.count('ui.notifications.fallback_polling');
    const poll = async () => {
      try {
        const res = await fetch(`/api/notifications/next?since=$\{since}&limit=20`, {
          cache: 'no-store',
          credentials: 'include'
        });
        if (res.status === 401) return;
        const data = await res.json();
        (data.items || []).forEach(onDTO);
      } catch(_) {}
      setTimeout(poll, 15000);
    };
    poll();
  }

  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
      fetch(`/api/notifications/next?since=$\{since}&limit=20`, {
        cache: 'no-store',
        credentials: 'include'
      })
        .then(r => (r.ok ? r.json() : null))
        .then(d => (d?.items || []).forEach(onDTO))
        .catch(()=>{});
    }
  });

  useSSE ? startSSE() : startPolling();
})();
});
</script>
</body>
</html>
