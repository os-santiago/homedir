{#include layout/main}
{#title}Capacidad · Homedir{/title}
{#body}
<section class="page-header">
  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
      <div>
        <p class="section-subtitle"
          style="margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 2px; font-size: 0.8rem;">
          Administración</p>
        <h1 class="page-title">Control de capacidad</h1>
        <p class="section-subtitle">Monitorea el estado de memoria y disco para proteger el login.</p>
      </div>
      <div class="action-group">
        <a href="/private/admin" class="btn btn-secondary">Volver al panel</a>
      </div>
    </div>
  </div>
</section>

<div class="container">
  <div class="page-grid">
    <div class="card">
      <h2 class="card-title">Estado actual</h2>
      <table class="table">
        <tbody>
          <tr>
            <th>Modo actual</th>
            <td>{#if status.mode == 'ADMITTING'}Admitiendo{#else}Conteniendo nuevos logins{/if}</td>
          </tr>
          <tr>
            <th>Usuarios activos</th>
            <td>{status.activeUsers}</td>
          </tr>
          <tr>
            <th>Memoria usada</th>
            <td>{status.memoryPercent}%</td>
          </tr>
          <tr>
            <th>Disco libre</th>
            <td>{status.diskFreePercent}%</td>
          </tr>
          <tr>
            <th>Última evaluación</th>
            <td>{status.lastEvaluation}</td>
          </tr>
          <tr>
            <th>Tendencia</th>
            <td>{status.trendNameLower}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <h2 class="card-title">Lecturas</h2>
      <table class="table">
        <tbody>
          <tr>
            <th>Lecturas desde memoria</th>
            <td>{reads.memory}</td>
          </tr>
          <tr>
            <th>Refrescos ejecutados</th>
            <td>{reads.refreshCount}</td>
          </tr>
          <tr>
            <th>Lecturas coalescidas</th>
            <td>{reads.refreshCoalesced}</td>
          </tr>
          <tr>
            <th>Duración último refresco</th>
            <td>{reads.refreshLastDurationMs} ms</td>
          </tr>
          <tr>
            <th>Duración p95</th>
            <td>{reads.refreshP95Ms} ms</td>
          </tr>
          <tr>
            <th>Lecturas servidas en refresco</th>
            <td>{reads.staleServed}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <h2 class="card-title">Escrituras</h2>
      <table class="table">
        <tbody>
          <tr>
            <th>Cola</th>
            <td>{writes.depth}/{writes.max}</td>
          </tr>
          <tr>
            <th>Antigüedad más vieja</th>
            <td>{writes.oldestAgeMs} ms</td>
          </tr>
          <tr>
            <th>Resultados</th>
            <td>OK: {writes.writesOk} · Fallos: {writes.writesFail} · Reintentos: {writes.writesRetries}</td>
          </tr>
          <tr>
            <th>Descartados por capacidad</th>
            <td>{writes.droppedDueCapacity}</td>
          </tr>
          {#if writes.lastError}
          <tr>
            <th>Último error</th>
            <td>{writes.lastError}</td>
          </tr>
          {/if}
        </tbody>
      </table>
      <div style="margin-top: 1rem;">
        <button class="btn btn-secondary" type="button" onclick="copyState()">Copiar estado</button>
      </div>
    </div>
  </div>
</div>
<script>
  function copyState() {
    const text = `Modo: {status.mode}\nMemoria usada: {status.memoryPercent}%\nDisco libre: {status.diskFreePercent}%\nLecturas: {reads.memory}\nCola escrituras: {writes.depth}/{writes.max}`;
    navigator.clipboard.writeText(text);
  }
</script>
{/body}
{/include}