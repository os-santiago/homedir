{#include layout/base}
{#title}Métricas{/title}
{#breadcrumbs}<a href="/private/admin">Admin</a><span class="sep">/</span><span>Métricas</span>{/breadcrumbs}
{#main}
<section class="admin-metrics">
  <h1 class="page-title">Métricas</h1>
  <form method="get" class="metrics-toolbar" data-testid="metrics-toolbar">
    <div class="range-chips">
      <button type="submit" name="range" value="today" class="chip {#if data.range == 'today'}active{/if}" data-testid="range-today">Hoy</button>
      <button type="submit" name="range" value="7" class="chip {#if data.range == '7'}active{/if}" data-testid="range-7">7 días</button>
      <button type="submit" name="range" value="30" class="chip {#if data.range == '30'}active{/if}" data-testid="range-30">30 días</button>
      <button type="submit" name="range" value="all" class="chip {#if data.range == 'all'}active{/if}" data-testid="range-all">Todo</button>
    </div>
    <select name="event" data-testid="filter-event">
      <option value=""{#if !data.eventId} selected{/if}>Todos los eventos</option>
      {#for ev in data.events}
        <option value="{ev.id}"{#if data.eventId == ev.id} selected{/if}>{ev.title}</option>
      {/for}
    </select>
    <input type="search" name="speaker" list="speakers" placeholder="Buscar…" value="{data.speakerId}" data-testid="filter-speaker">
    <datalist id="speakers">
      {#for sp in data.speakers}
        <option value="{sp.id}">{sp.name}</option>
      {/for}
    </datalist>
    <a href="/private/admin/metrics/export?table=talks&amp;range={data.range}{#if data.eventId}&amp;event={data.eventId}{/if}" class="btn btn-secondary" data-testid="export-csv">Exportar CSV</a>
    <a href="/private/admin/metrics/registrations" class="btn btn-secondary">Registros por charla</a>
  </form>

  <div class="cards-grid">
    <div class="card">
      <h2 class="card-title">Resumen</h2>
      <div class="kpi-grid">
        <div class="kpi"><span class="label">Eventos vistos</span><span class="value">{data.eventsViewed}</span></div>
        <div class="kpi"><span class="label">Charlas vistas</span><span class="value">{data.talksViewed}</span></div>
        <div class="kpi"><span class="label">Registros</span><span class="value">{data.talksRegistered}</span></div>
        <div class="kpi"><span class="label">Visitas escenario</span><span class="value">{data.stageVisits}</span></div>
        <div class="kpi"><span class="label">Conversión</span><span class="value">{data.globalConversion}</span></div>
      </div>
    </div>

    <div class="card">
      <h2 class="card-title">Top Charlas</h2>
      {#if data.topTalks.isEmpty}
        <p>Sin datos.</p>
      {#else}
      <div class="list list-table">
        <div class="list-header">
          <span>Título</span><span>Vistas</span><span>Registros</span><span>Conv%</span>
        </div>
        {#for row in data.topTalks}
        <div class="list-row">
          <span class="title"><a href="/private/admin/metrics/registrants?talk={row.id}">{row.name}</a></span>
          <span class="metric">{row.views}</span>
          <span class="metric">{row.registrations}</span>
          <span class="metric">{row.conversion}</span>
        </div>
        {/for}
      </div>
      {/if}
    </div>

    <div class="card">
      <h2 class="card-title">Eventos</h2>
      {#if data.eventRows.isEmpty}
        <p>Sin datos.</p>
      {#else}
      <div class="list list-table">
        <div class="list-header">
          <span>Evento</span><span>Vistas</span><span>Charlas vistas</span><span>Registros</span>
        </div>
        {#for row in data.eventRows}
        <div class="list-row">
          <span class="title">{row.name}</span>
          <span class="metric">{row.eventViews}</span>
          <span class="metric">{row.talkViews}</span>
          <span class="metric">{row.registrations}</span>
        </div>
        {/for}
      </div>
      {/if}
    </div>

    <div class="card">
      <h2 class="card-title">Calidad de datos</h2>
      <div class="list">
        <div class="list-row"><span class="label">dedupe</span><span class="metric">{data.discards.get('dedupe')}</span></div>
        <div class="list-row"><span class="label">bot</span><span class="metric">{data.discards.get('bot')}</span></div>
        <div class="list-row"><span class="label">burst</span><span class="metric">{data.discards.get('burst')}</span></div>
        <div class="list-row"><span class="label">buffer_full</span><span class="metric">{data.discards.get('buffer_full')}</span></div>
      </div>
    </div>

    <div class="card">
      <h2 class="card-title">Mantenimiento</h2>
      <div class="list">
        <div class="list-row"><span class="label">schemaVersion</span><span class="metric">{data.schemaVersion}</span></div>
        <div class="list-row"><span class="label">fileSizeBytes</span><span class="metric">{data.fileSizeBytes}</span></div>
      </div>
    </div>

    <div class="card">
      <h2 class="card-title">Salud</h2>
      <div class="status">
        <span class="badge metrics-health {data.dataHealth.css}" aria-live="polite" data-testid="metrics-health-badge">{data.dataHealth.state}</span>
      </div>
      <div class="list">
        <div class="list-row"><span class="label">lastFlush</span><span class="metric">{data.health.lastFlush}</span></div>
        <div class="list-row"><span class="label">flushInterval</span><span class="metric">{data.health.flushIntervalMillis} ms</span></div>
        <div class="list-row"><span class="label">buffer</span><span class="metric">{data.health.bufferCurrentSize}/{data.health.bufferMaxSize}</span></div>
      </div>
    </div>
  </div>
</section>
{/main}
{/include}
