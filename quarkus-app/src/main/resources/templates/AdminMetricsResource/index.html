{#include layout/base}
{#title}Métricas{/title}
{#breadcrumbs}<a href="/private/admin">Admin</a><span class="sep">/</span><span>Métricas</span>{/breadcrumbs}
{#main}
<section class="admin-metrics">
    <h1 class="page-title">Métricas</h1>
    {#if data.empty}
        <p>Sin datos suficientes todavía. Navega por eventos y registra charlas para generar métricas.</p>
    {#else}
    <form method="get" class="metrics-filter">
        <label>Rango:
            <select name="range">
                <option value="all"{#if data.range == 'all'} selected{/if}>Todo el evento</option>
                <option value="today"{#if data.range == 'today'} selected{/if}>Hoy</option>
                <option value="7"{#if data.range == '7'} selected{/if}>Últimos 7 días</option>
                <option value="30"{#if data.range == '30'} selected{/if}>Últimos 30 días</option>
            </select>
        </label>
        {#if data.eventId}
        <input type="hidden" name="event" value="{data.eventId}">
        {/if}
        <button type="submit">Aplicar</button>
    </form>
    {#if data.eventId}
    <p><a href="talks?event={data.eventId}" class="btn btn-secondary">Reporte charlas registradas</a></p>
    {/if}
    <div class="cards">
        <div class="card">Eventos vistos: {data.eventsViewed}</div>
        <div class="card">Charlas vistas: {data.talksViewed}</div>
        <div class="card">Charlas registradas: {data.talksRegistered}</div>
        <div class="card">Visitas a escenarios: {data.stageVisits}</div>
        <div class="card">Conversión global: {data.globalConversion}</div>
        <div class="card">Asistentes esperados: {data.expectedAttendees}</div>
        <div class="card">Última actualización: {data.lastUpdate}</div>
    </div>
    <p>Umbral mínimo de vistas para ranking: {data.minViews}. Política de conversión de evento: promedio ponderado (A).</p>

    <h2>Salud del sistema de métricas</h2>
    <div class="health health-{data.health.estado}">
        <strong>{data.health.estado}</strong>
        {#if data.health.estado == 'OK'}<span>Todo en orden</span>{/if}
        {#if data.health.estado == 'DEGRADADO'}<span>Revisar espacio en disco o ajustar flush/buffer</span>{/if}
        {#if data.health.estado == 'ERROR'}<span>Ver guía operativa y revisar logs</span>{/if}
    </div>
    <ul>
        <li>lastFlush: {data.health.lastFlush}</li>
        <li>flushInterval: {data.health.flushIntervalMillis} ms</li>
        <li>buffer: {data.health.bufferCurrentSize}/{data.health.bufferMaxSize}</li>
        <li>writes ok/fail: {data.health.writesOk}/{data.health.writesFail}</li>
        <li>fileSizeBytes: {data.health.fileSizeBytes}</li>
        <li>Último error: {#if data.health.lastError}{data.health.lastError}{#else}—{/if}</li>
        <li>Descartes: dedupe {data.discards.get('dedupe')}, bot {data.discards.get('bot')}, burst {data.discards.get('burst')}, invalid {data.discards.get('invalid')}, buffer_full {data.discards.get('buffer_full')}</li>
    </ul>
    <p><a href="guide">Guía rápida de operación</a></p>
    <h2>Calidad de datos</h2>
    <ul>
        <li>Ventana talk_view: {data.config.talkViewWindowSeconds}s</li>
        <li>Ventana event_view: {data.config.eventViewWindowSeconds}s</li>
        <li>Ventana stage_visit: {data.config.stageVisitWindowMinutes}min</li>
        <li>Límite ráfaga: {data.config.burstPerSecond}/s, {data.config.burstPerMinute}/min</li>
    </ul>
    <p>Descartes por motivo:</p>
    <ul>
        <li>dedupe: {data.discards.get('dedupe')}</li>
        <li>bot: {data.discards.get('bot')}</li>
        <li>burst: {data.discards.get('burst')}</li>
        <li>invalid: {data.discards.get('invalid')}</li>
        <li>buffer_full: {data.discards.get('buffer_full')}</li>
    </ul>

    <h2>Mantenimiento de métricas</h2>
    <ul>
        <li>Versión de esquema: {data.schemaVersion}</li>
        <li>Tamaño actual: {data.fileSizeBytes} bytes</li>
    </ul>

    <h2>Charlas con mejor conversión</h2>
    <form method="get" class="table-search">
        <input type="hidden" name="range" value="{data.range}">
        {#if data.eventId}<input type="hidden" name="event" value="{data.eventId}">{/if}
        <input type="hidden" name="speakerQ" value="{data.speakerQ}">
        <input type="hidden" name="scenarioQ" value="{data.scenarioQ}">
        <input type="text" name="talkQ" placeholder="Buscar…" value="{data.talkQ}" data-testid="table-talks-search">
    </form>
    <table>
        <thead><tr><th>Charla</th><th>Vistas</th><th>Registros</th><th>Conv.</th><th>Acciones</th></tr></thead>
        <tbody>
        {#for row in data.topTalks}
            <tr>
                <td>{row.name}</td><td>{row.views}</td><td>{row.registrations}</td><td>{row.conversion}</td>
                <td><a href="/private/admin/events/{app:eventIdByTalk(row.id)}/edit" aria-label="Ver charla {row.name}" data-testid="table-talks-view-{row.id}">Ver</a></td>
            </tr>
        {/for}
        </tbody>
    </table>
    {#if !data.topTalks.isEmpty}
    <a href="export?table=talks&amp;range={data.range}{#if data.eventId}&amp;event={data.eventId}{/if}{#if data.talkQ}&amp;q={data.talkQ}{/if}" class="btn btn-secondary" data-testid="table-talks-export">Exportar CSV</a>
    {#else}
    <button class="btn btn-secondary" disabled data-testid="table-talks-export">Exportar CSV</button>
    <p>Sin datos para exportar en este rango.</p>
    {/if}

    <h2>Oradores con mejor conversión</h2>
    <form method="get" class="table-search">
        <input type="hidden" name="range" value="{data.range}">
        {#if data.eventId}<input type="hidden" name="event" value="{data.eventId}">{/if}
        <input type="hidden" name="talkQ" value="{data.talkQ}">
        <input type="hidden" name="scenarioQ" value="{data.scenarioQ}">
        <input type="text" name="speakerQ" placeholder="Buscar…" value="{data.speakerQ}" data-testid="table-speakers-search">
    </form>
    <table>
        <thead><tr><th>Orador</th><th>Vistas</th><th>Registros</th><th>Conv.</th><th>Acciones</th></tr></thead>
        <tbody>
        {#for row in data.topSpeakers}
            <tr>
                <td>{row.name}</td><td>{row.views}</td><td>{row.registrations}</td><td>{row.conversion}</td>
                <td><a href="/private/admin/speakers" aria-label="Ver orador {row.name}" data-testid="table-speakers-view-{row.id}">Ver</a></td>
            </tr>
        {/for}
        </tbody>
    </table>
    {#if !data.topSpeakers.isEmpty}
    <a href="export?table=speakers&amp;range={data.range}{#if data.eventId}&amp;event={data.eventId}{/if}{#if data.speakerQ}&amp;q={data.speakerQ}{/if}" class="btn btn-secondary" data-testid="table-speakers-export">Exportar CSV</a>
    {#else}
    <button class="btn btn-secondary" disabled data-testid="table-speakers-export">Exportar CSV</button>
    <p>Sin datos para exportar en este rango.</p>
    {/if}

    <h2>Escenarios con mejor conversión</h2>
    <form method="get" class="table-search">
        <input type="hidden" name="range" value="{data.range}">
        {#if data.eventId}<input type="hidden" name="event" value="{data.eventId}">{/if}
        <input type="hidden" name="talkQ" value="{data.talkQ}">
        <input type="hidden" name="speakerQ" value="{data.speakerQ}">
        <input type="text" name="scenarioQ" placeholder="Buscar…" value="{data.scenarioQ}" data-testid="table-scenarios-search">
    </form>
    <table>
        <thead><tr><th>Escenario</th><th>Vistas</th><th>Registros</th><th>Conv.</th><th>Acciones</th></tr></thead>
        <tbody>
        {#for row in data.topScenarios}
            <tr>
                <td>{row.name}</td><td>{row.views}</td><td>{row.registrations}</td><td>{row.conversion}</td>
                <td><a href="/private/admin/events/{app:eventIdByScenario(row.id)}/edit" aria-label="Ver escenario {row.name}" data-testid="table-scenarios-view-{row.id}">Ver</a></td>
            </tr>
        {/for}
        </tbody>
    </table>
    {#if !data.topScenarios.isEmpty}
    <a href="export?table=scenarios&amp;range={data.range}{#if data.eventId}&amp;event={data.eventId}{/if}{#if data.scenarioQ}&amp;q={data.scenarioQ}{/if}" class="btn btn-secondary" data-testid="table-scenarios-export">Exportar CSV</a>
    {#else}
    <button class="btn btn-secondary" disabled data-testid="table-scenarios-export">Exportar CSV</button>
    <p>Sin datos para exportar en este rango.</p>
    {/if}
    {/if}
    <a href="/private/admin" class="btn btn-secondary">Volver</a>
</section>
{/main}
{/include}
