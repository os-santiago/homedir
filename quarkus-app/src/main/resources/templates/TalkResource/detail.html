{#include layout/base}
{#title}
{#if talk && talk.name}{talk.name}{#else}Charla{/if}
{/title}
{#breadcrumbs}
{#if talk}
<a href="/">Inicio</a>
{#if event}<span class="sep">/</span><a href="/event/{event.id}">{event.title}</a>{/if}
{#if talk.location && event}<span class="sep">/</span><a href="/scenario/{talk.location}">{event.getScenarioName(talk.location)}</a>{/if}
<span class="sep">/</span><span>Charla: {talk.name ?: talk.id}</span>
{/if}
{/breadcrumbs}
{#main}
{#if talk}
<section class="talk-detail">
  <h1 class="page-title">{talk.name ?: 'Charla'}</h1>
  {#if !talk.description || talk.speakers.isEmpty() || !talk.location || !talk.startTime || !event}
    <p>Charla en preparación. Pronto estará disponible</p>
  {/if}
  {#if talk.description}<p>{talk.description}</p>{/if}
  {#if !talk.speakers.isEmpty()}
    <p><strong>Orador{#if talk.speakers.size > 1}es{/if}:</strong>
      {#for s in talk.speakers}
        <a href="/speaker/{s.id}">{s.name}</a>{#if s_hasNext} & {/if}
      {/for}
    </p>
  {/if}
  <p><strong>Horario:</strong> {#if talk.startTimeStr}{talk.startTimeStr}{#else}Por confirmar{/if}</p>
  <p><strong>Ubicación:</strong>
    {#if talk.location}
      {#if event}{event.getScenarioName(talk.location)}{#else}{talk.location}{/if}
    {#else}
      Por confirmar
    {/if}
  </p>
  {#if talk.durationMinutes > 0}<p><strong>Duración:</strong> {talk.durationMinutes} min</p>{/if}
  {#if app:isAuthenticated()}
  <p>
    <button id="addTalkBtn" class="btn">
      {#if inSchedule}<span class="icon">✔</span> Agregada{#else}<span class="icon">➕</span> Agregar a mis charlas{/if}
    </button>
  </p>
  <script>
  (function() {
    const btn = document.getElementById('addTalkBtn');
    if (!btn) return;
    if ({inSchedule}) {
      btn.disabled = true;
      btn.classList.add('btn-secondary');
    }
    btn.addEventListener('click', async () => {
      if (btn.disabled) return;
      btn.disabled = true;
      try {
        const res = await fetch('/private/profile/add/{talk.id}', {
          method: 'POST',
          headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: '{}'
        });
        const contentType = res.headers.get('content-type') || '';
        if (res.ok && contentType.includes('application/json')) {
          const data = await res.json();
          if (data.status === 'added') {
            showNotification('success', 'Charla agregada a tu agenda');
            btn.classList.add('btn-secondary');
            btn.innerHTML = '<span class="icon">✔</span> Agregada';
          } else if (data.status === 'exists') {
            showNotification('info', 'La charla ya estaba registrada. <a href="/private/profile">Ver en Mis Charlas</a>');
            btn.classList.add('btn-secondary');
            btn.innerHTML = '<span class="icon">✔</span> Agregada';
          } else if (data.status === 'error') {
            showNotification('error', data.message || 'Ocurrió un error');
            btn.disabled = false;
            return;
          }
        } else if (res.status === 401) {
          showNotification('info', 'Debe iniciar sesión para agregar la charla');
          btn.disabled = false;
          return;
        } else {
          showNotification('error', 'Ocurrió un error al registrar la charla');
          btn.disabled = false;
          return;
        }
      } catch (e) {
        showNotification('error', 'Ocurrió un error al registrar la charla');
        btn.disabled = false;
        return;
      }
    });
  })();
  </script>
  {/if}
  {#if !occurrences.isEmpty()}
  <div class="card">
    <h2 class="card-title"><span class="icon">⏰</span>Horarios</h2>
    <ul class="agenda-list">
    {#for t in occurrences}
        <li class="agenda-item">
          <span class="icon">⏰</span>Día {t.day} - {t.startTimeStr} ({t.durationMinutes} min) -
          {#if t.location}
            {#if event}
              <a href="/scenario/{t.location}">{event.getScenarioName(t.location)}</a>
            {#else}
              <span>{t.location}</span>
            {/if}
          {#else}
            <span>Ubicación por confirmar</span>
          {/if}
        </li>
    {/for}
    </ul>
  </div>
  {/if}
  <div class="action-group">
    {#if talk.location}<a href="/scenario/{talk.location}" class="btn btn-secondary">Volver al escenario</a>{/if}
    {#if event}<a href="/event/{event.id}" class="btn">Volver al evento</a>{/if}
  </div>
</section>
{#else}
<p>Charla no encontrada.</p>
{/if}
{/main}
{/include}
