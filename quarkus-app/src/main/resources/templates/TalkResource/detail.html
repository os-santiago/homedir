{#include layout/base}
{#title}
{#if talk && talk.name}{talk.name}{#else}{i18n:talk_title_default}{/if}
{/title}
{#breadcrumbs}
{#if talk}
<a href="/">{i18n:talk_breadcrumb_home}</a>
{#if event}<span class="sep">/</span><a href="/event/{event.id}">{event.title}</a>{/if}
{#if talk.location && event}<span class="sep">/</span><a
  href="/event/{event.id}/scenario/{talk.location}">{event.getScenarioName(talk.location)}</a>{/if}
<span class="sep">/</span><span>{i18n:talk_breadcrumb_label(talk.name ?: talk.id)}</span>
{/if}
{/breadcrumbs}
{#main}
{#if talk}
<section class="talk-detail">
  <h1 class="page-title talk-title">{talk.name ?: i18n.talk_title_default}</h1>
  <div class="chips">
    <span class="chip">{i18n:talk_chip_day(talk.day)}</span>
    {#if talk.location && event}<span class="chip">{event.getScenarioName(talk.location)}</span>{/if}
  </div>
  {#if !talk.description || talk.speakers.isEmpty() || !talk.location || !talk.startTime || !event}
  <p>{i18n:talk_preparing_message}</p>
  {/if}
  {#if talk.description}<p class="talk-description">{talk.description}</p>{/if}
  {#if !talk.speakers.isEmpty()}
  <div class="speaker-avatars">
    {#for s in talk.speakers}
    <a href="/speaker/{s.id}" title="{s.name}">
      {#if app:validUrl(s.photoUrl)}
      <img src="{s.photoUrl}" alt="{s.name}" class="avatar" width="48" height="48">
      {#else}
      <span class="avatar placeholder"><span class="material-symbols-outlined">person</span></span>
      {/if}
    </a>
    {/for}
  </div>
  <p><strong>{i18n:talk_label_speaker}:</strong> <a href="/speaker/{talk.speakers[0].id}">{talk.speakers[0].name}</a></p>
  {#if talk.speakers.size > 1}
  <p><strong>{i18n:talk_label_co_speaker}:</strong> <a href="/speaker/{talk.speakers[1].id}">{talk.speakers[1].name}</a></p>
  {/if}
  {/if}
  <p><strong>{i18n:talk_label_schedule}:</strong> {#if talk.startTimeStr}{talk.startTimeStr}{#else}{i18n:talk_tbd}{/if}</p>
  <p><strong>{i18n:talk_label_location}:</strong>
    {#if talk.location}
    {#if event}{event.getScenarioName(talk.location)}{#else}{talk.location}{/if}
    {#else}
    {i18n:talk_tbd}
    {/if}
  </p>
  {#if talk.durationMinutes > 0}<p><strong>{i18n:talk_label_duration}:</strong> {i18n:talk_duration_minutes(talk.durationMinutes)}</p>{/if}
  {#if app:isAuthenticated()}
  <p>
    <button id="addTalkBtn" class="btn">
      {#if inSchedule}<span class="icon"><span class="material-symbols-outlined">check</span></span> {i18n:talk_btn_view_profile}
      {#else}<span class="icon"><span class="material-symbols-outlined">add</span></span> {i18n:talk_btn_add_to_profile}{/if}
    </button>
  </p>
  <script>
    (function () {
      const btn = document.getElementById('addTalkBtn');
      if (!btn) return;
      const profileLabel = "{i18n:talk_btn_view_profile}";
      const messages = {
        added: "{i18n:talk_js_added}",
        exists: "{i18n:talk_js_exists}",
        loginRequired: "{i18n:talk_js_login_required}",
        genericError: "{i18n:talk_js_error}"
      };
      if ({ inSchedule }) {
        btn.classList.add('btn-secondary');
        btn.dataset.state = 'profile';
      }
      btn.addEventListener('click', async () => {
        if (btn.disabled) return;
        if (btn.dataset.state === 'profile') {
          window.location.href = '/private/profile';
          return;
        }
        btn.disabled = true;
        try {
          const res = await fetch('/private/profile/add/{talk.id}', {
            method: 'POST',
            headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: '{}'
          });
          const contentType = res.headers.get('content-type') || '';
          if (res.ok && contentType.includes('application/json')) {
            const data = await res.json();
            if (data.status === 'added') {
              showNotification('success', messages.added);
              btn.classList.add('btn-secondary');
              btn.innerHTML = '<span class="icon"><span class="material-symbols-outlined">check</span></span> ' + profileLabel;
              btn.disabled = false;
              btn.dataset.state = 'profile';
            } else if (data.status === 'exists') {
              showNotification('info', messages.exists);
              btn.classList.add('btn-secondary');
              btn.innerHTML = '<span class="icon"><span class="material-symbols-outlined">check</span></span> ' + profileLabel;
              btn.disabled = false;
              btn.dataset.state = 'profile';
            } else if (data.status === 'error') {
              showNotification('error', data.message || messages.genericError);
              btn.disabled = false;
              return;
            }
          } else if (res.status === 401) {
            showNotification('info', messages.loginRequired);
            btn.disabled = false;
            return;
          } else {
            showNotification('error', messages.genericError);
            btn.disabled = false;
            return;
          }
        } catch (e) {
          showNotification('error', messages.genericError);
          btn.disabled = false;
          return;
        }
      });
    })();
  </script>
  {/if}
  {#if !occurrences.isEmpty()}
  <div class="card">
    <h2 class="card-title"><span class="icon"><span class="material-symbols-outlined">schedule</span></span>{i18n:talk_schedule_slots}
    </h2>
    <ul class="agenda-list">
      {#for t in occurrences}
      <li class="agenda-item">
        <span class="icon"><span class="material-symbols-outlined">schedule</span></span>{i18n:talk_occurrence_line(t.day, t.startTimeStr, t.durationMinutes)}
        -
        {#if t.location}
        {#if event}
        <a href="/event/{event.id}/scenario/{t.location}">{event.getScenarioName(t.location)}</a>
        {#else}
        <span>{t.location}</span>
        {/if}
        {#else}
        <span>{i18n:talk_location_tbd}</span>
        {/if}
      </li>
      {/for}
    </ul>
  </div>
  {/if}
  <div class="action-group">
    {#if talk.location && event}<a href="/event/{event.id}/scenario/{talk.location}" class="btn btn-secondary">{i18n:talk_back_to_scenario}</a>{/if}
    {#if event}<a href="/event/{event.id}" class="btn">{i18n:talk_back_to_event}</a>{/if}
  </div>
</section>
{#else}
<p>{i18n:talk_not_found}</p>
{/if}
{/main}
{/include}
