{#include layout/base}
{#title}
{#if talk && talk.name}{talk.name}{#else}Charla{/if}
{/title}
{#breadcrumbs}
{#if talk}
<a href="/">Inicio</a>
{#if event}<span class="sep">/</span><a href="/event/{event.id}">{event.title}</a>{/if}
{#if talk.location && event}<span class="sep">/</span><a href="/event/{event.id}/scenario/{talk.location}">{event.getScenarioName(talk.location)}</a>{/if}
<span class="sep">/</span><span>Charla: {talk.name ?: talk.id}</span>
{/if}
{/breadcrumbs}
{#main}
{#if talk}
<section class="talk-detail">
  <h1 class="page-title">{talk.name ?: 'Charla'}</h1>
  {#if !talk.description || talk.speakers.isEmpty() || !talk.location || !talk.startTime || !event}
    <p>Charla en preparaci√≥n. Pronto estar√° disponible</p>
  {/if}
  {#if talk.description}<p>{talk.description}</p>{/if}
  {#if !talk.speakers.isEmpty()}
    <div class="speaker-avatars">
      {#for s in talk.speakers}
        <a href="/speaker/{s.id}" title="{s.name}">
          {#if app:validUrl(s.photoUrl)}
            <img src="{s.photoUrl}" alt="{s.name}" class="avatar">
          {#else}
            <span class="avatar placeholder">üë§</span>
          {/if}
        </a>
      {/for}
    </div>
    <p><strong>Orador:</strong> <a href="/speaker/{talk.speakers[0].id}">{talk.speakers[0].name}</a></p>
    {#if talk.speakers.size > 1}
      <p><strong>Co-Speaker:</strong> <a href="/speaker/{talk.speakers[1].id}">{talk.speakers[1].name}</a></p>
    {/if}
  {/if}
  <p><strong>Horario:</strong> {#if talk.startTimeStr}{talk.startTimeStr}{#else}Por confirmar{/if}</p>
  <p><strong>Ubicaci√≥n:</strong>
    {#if talk.location}
      {#if event}{event.getScenarioName(talk.location)}{#else}{talk.location}{/if}
    {#else}
      Por confirmar
    {/if}
  </p>
  {#if talk.durationMinutes > 0}<p><strong>Duraci√≥n:</strong> {talk.durationMinutes} min</p>{/if}
  {#if app:isAuthenticated()}
  <p>
    <button id="addTalkBtn" class="btn">
      {#if inSchedule}<span class="icon">‚úî</span> Ver en mi perfil{#else}<span class="icon">‚ûï</span> Agregar a mis charlas{/if}
    </button>
  </p>
  <script>
  (function() {
    const btn = document.getElementById('addTalkBtn');
    if (!btn) return;
    if ({inSchedule}) {
      btn.classList.add('btn-secondary');
      btn.dataset.state = 'profile';
    }
    btn.addEventListener('click', async () => {
      if (btn.disabled) return;
      if (btn.dataset.state === 'profile') {
        window.location.href = '/private/profile';
        return;
      }
      btn.disabled = true;
      try {
        const res = await fetch('/private/profile/add/{talk.id}', {
          method: 'POST',
          headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: '{}'
        });
        const contentType = res.headers.get('content-type') || '';
        if (res.ok && contentType.includes('application/json')) {
          const data = await res.json();
          if (data.status === 'added') {
            showNotification('success', 'Agregado a mi perfil');
            btn.classList.add('btn-secondary');
            btn.innerHTML = '<span class="icon">‚úî</span> Ver en mi perfil';
            btn.disabled = false;
            btn.dataset.state = 'profile';
          } else if (data.status === 'exists') {
            showNotification('info', 'La charla ya estaba registrada. <a href="/private/profile">Ver en mi perfil</a>');
            btn.classList.add('btn-secondary');
            btn.innerHTML = '<span class="icon">‚úî</span> Ver en mi perfil';
            btn.disabled = false;
            btn.dataset.state = 'profile';
          } else if (data.status === 'error') {
            showNotification('error', data.message || 'Ocurri√≥ un error');
            btn.disabled = false;
            return;
          }
        } else if (res.status === 401) {
          showNotification('info', 'Debe iniciar sesi√≥n para agregar la charla');
          btn.disabled = false;
          return;
        } else {
          showNotification('error', 'Ocurri√≥ un error al registrar la charla');
          btn.disabled = false;
          return;
        }
      } catch (e) {
        showNotification('error', 'Ocurri√≥ un error al registrar la charla');
        btn.disabled = false;
        return;
      }
    });
  })();
  </script>
  {/if}
  {#if fromQr}
    {#if details}
      {#if canEdit}
      <div id="feedback">
        <h2 class="card-title">Eval√∫a esta charla</h2>
        <label for="rating-select">Calificaci√≥n:</label>
        <select id="rating-select">
          <option value="">‚òÖ</option>
          <option value="1" {#if details.rating == 1}selected{/if}>1</option>
          <option value="2" {#if details.rating == 2}selected{/if}>2</option>
          <option value="3" {#if details.rating == 3}selected{/if}>3</option>
          <option value="4" {#if details.rating == 4}selected{/if}>4</option>
          <option value="5" {#if details.rating == 5}selected{/if}>5</option>
        </select>
        <label for="comment-box">Comentario (opcional):</label>
        <textarea id="comment-box" maxlength="200">{details.comment ?: ''}</textarea>
        <button id="save-feedback" class="btn">Enviar</button>
      </div>
      <script>
      (function(){
        const talkId = '{talk.id}';
        if (!{details.attended}) {
          fetch('/private/profile/update/' + talkId, {
            method:'POST',
            headers:{'Content-Type':'application/json','Accept':'application/json'},
            body: JSON.stringify({ attended: true })
          });
        }
        document.getElementById('save-feedback').addEventListener('click', async () => {
          const rating = document.getElementById('rating-select').value;
          const comment = document.getElementById('comment-box').value;
          if (!rating) {
            showNotification('info', 'Seleccione una calificaci√≥n');
            return;
          }
          try {
            const res = await fetch('/private/profile/update/' + talkId, {
              method:'POST',
              headers:{'Content-Type':'application/json','Accept':'application/json'},
              body: JSON.stringify({ rating: parseInt(rating), comment })
            });
            if (res.ok) {
              showNotification('success', 'Gracias por tu evaluaci√≥n');
            } else {
              showNotification('error', 'No se pudo guardar');
            }
          } catch(e){
            showNotification('error', 'No se pudo guardar');
          }
        });
      })();
      </script>
      {#else}
      <p>Gracias por tu evaluaci√≥n.</p>
      {/if}
    {/if}
  {/if}
  {#if !occurrences.isEmpty()}
  <div class="card">
    <h2 class="card-title"><span class="icon">‚è∞</span>Horarios</h2>
    <ul class="agenda-list">
    {#for t in occurrences}
        <li class="agenda-item">
          <span class="icon">‚è∞</span>D√≠a {t.day} - {t.startTimeStr} ({t.durationMinutes} min) -
          {#if t.location}
            {#if event}
              <a href="/event/{event.id}/scenario/{t.location}">{event.getScenarioName(t.location)}</a>
            {#else}
              <span>{t.location}</span>
            {/if}
          {#else}
            <span>Ubicaci√≥n por confirmar</span>
          {/if}
          {#if event && t.id}
            <span class="sep">|</span>
            <a href="/event/{event.id}/talk/{t.id}" class="btn btn-link">Ver charla</a>
          {/if}
        </li>
    {/for}
    </ul>
  </div>
  {/if}
  <div class="action-group">
    {#if talk.location && event}<a href="/event/{event.id}/scenario/{talk.location}" class="btn btn-secondary">Volver al escenario</a>{/if}
    {#if event}<a href="/event/{event.id}" class="btn">Volver al evento</a>{/if}
  </div>
</section>
{#else}
<p>Charla no encontrada.</p>
{/if}
{/main}
{/include}
