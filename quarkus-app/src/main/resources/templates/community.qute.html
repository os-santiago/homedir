{#include layout/main activePage="community"}
{#title}{i18n.community_title}{/title}
{#body}
<nav class="breadcrumbs"><span>{i18n.nav_home}</span> / <strong>{i18n.nav_community}</strong></nav>

<header class="page-header">
  <div class="section-header">
    <p class="section-subtitle">{i18n.community_subtitle}</p>
    <h1>{i18n.community_hero_title}</h1>
  </div>
  <p class="section-subtitle">{i18n.community_hero_desc}</p>

  {#if prError}
  <div class="retro-box" style="margin-top: 1rem; border-color: #ff4444; background: rgba(255, 68, 68, 0.1);">
    <h3 style="color: #ff4444; margin-bottom: 0.5rem;">{i18n.community_error_title}</h3>
    <p>{i18n.community_error_desc}</p>
    <p style="font-size: 0.8rem; margin-top: 0.5rem;">{i18n.community_error_detail(prError)}</p>
  </div>
  {/if}

  {#if githubLinked}
  <div class="retro-box" style="margin-top: 1rem; border-color: #00fa9a; background: rgba(0, 250, 154, 0.1);">
    <h3 style="color: #00fa9a; margin-bottom: 0.5rem;">{i18n.community_linked_title}</h3>
    <p>{i18n.community_linked_desc}</p>
  </div>
  {/if}

  {#if joined}
  <div class="retro-box" style="margin-top: 1rem; border-color: #00fa9a; background: rgba(0, 250, 154, 0.1);">
    <h3 style="color: #00fa9a; margin-bottom: 0.5rem;">{i18n.community_joined_title}</h3>
    <p>{i18n.community_joined_desc}</p>
    {#if prUrl}<a href="{prUrl}" target="_blank" class="retro-btn-small">{i18n.btn_view_pr}</a>{/if}
  </div>
  {/if}

  <div class="main-sections" style="margin-top: 2rem;">
    {#if needsGithubLink && isAuthenticated}
    <div class="section-card" style="background: rgba(255, 215, 0, 0.1); border-color: #ffd700;">
      <p class="eyebrow" style="color: #ffd700;">{i18n.community_join_card_eyebrow}</p>
      <h2 style="font-size: 1.5rem;">{i18n.community_join_card_title}</h2>
      <p>{i18n.community_join_card_desc}</p>
      <a href="/private/github/start?redirect=/comunidad" class="btn-primary"
        style="margin-top: 1rem; font-size: 0.8rem;">{i18n.btn_connect_now}</a>
    </div>
    {#else}
    <div class="section-card">
      <p class="eyebrow">{i18n.community_members_eyebrow}</p>
      <h2>{totalMembers}</h2>
      <p>{i18n.community_members_desc}</p>
    </div>
    {/if}

    <div class="section-card">
      <p class="eyebrow">{i18n.community_top_contributors}</p>
      <div class="leaderboard-mini" style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
        {#for leader in leaderboard}
        <a href="{leader.profileUrl}" target="_blank" title="{leader.name} (Lvl {leader.level})"
          style="display: block;">
          <img src="{leader.avatarUrl}"
            style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid #ffd700;">
        </a>
        {/for}
      </div>
    </div>
  </div>

  <div style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap;">
    {#if !isAuthenticated}
    <a class="btn-primary" href="/private/profile">{i18n.btn_login_join}</a>
    {#else if needsGithubLink}
    <a class="btn-primary" href="/private/github/start?redirect=/comunidad">{i18n.btn_link_github}</a>
    {#else if joined}
    <button disabled class="btn-primary" style="opacity: 0.7; cursor: default;">{i18n.btn_request_processing}</button>
    {#else if !alreadyMember}
    <form action="/comunidad/join" method="POST" style="display:inline;">
      <button type="submit" class="btn-primary" style="cursor: pointer;">{i18n.btn_join_community}</button>
    </form>
    {#else}
    <button disabled class="btn-primary" style="opacity: 0.7; cursor: default;">{i18n.btn_already_member}</button>
    {/if}

    <a class="btn-primary" href="#directorio"
      style="background: transparent; border: 1px solid white; color: white;">{i18n.btn_view_directory}</a>
  </div>
</header>

<section class="page-grid">
  <div class="section-header" style="grid-column: 1 / -1; margin-top: 2rem;" id="directorio">
    <div style="display: flex; justify-content: space-between; align-items: flex-end; flex-wrap: wrap; gap: 1rem;">
      <div>
        <h2 class="page-title">{i18n.directory_title}</h2>
      </div>
      <form class="search-form" method="get" action="/comunidad" style="display: flex; gap: 0.5rem;">
        <input type="search" name="q" value="{query ?: ''}" placeholder="{i18n.search_placeholder}"
          aria-label="{i18n.search_aria_label}"
          style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 0.5rem; font-family: var(--font-body);">
        <button class="btn-primary" type="submit" style="padding: 0.5rem 1rem;">{i18n.btn_search}</button>
      </form>
    </div>
  </div>

  {#if members.isEmpty()}
  <div class="section-card" style="grid-column: 1 / -1;">
    <p>{i18n.directory_empty}</p>
  </div>
  {#else}
  {#for member in members}
  <div class="section-card member-card" style="position: relative;">
    <div style="display: flex; align-items: center; gap: 1rem; mb-2">
      <img src="{member.avatarUrl}" alt="{member.name}" style="width: 48px; height: 48px; border-radius: 50%;">
      <div>
        <h3 style="margin: 0; font-size: 1.1rem;">{member.name}</h3>
        {#if member.github}<a href="{member.profileUrl}" target="_blank"
          style="color: #888; text-decoration: none; font-size: 0.8rem;">@{member.github}</a>{/if}
      </div>
      <div style="margin-left: auto; text-align: right;">
        <div class="member-badge" title="{i18n.badge_official_member}">
          <span style="font-size: 1.2rem;">üèÖ</span>
        </div>
        <span style="display: block; font-weight: bold; color: #ffd700;">Lvl {member.level}</span>
        <span style="font-size: 0.7rem; color: #666;">{member.role}</span>
      </div>
    </div>

    <div style="margin-top: 1rem;">
      <div
        style="display: flex; justify-content: space-between; font-size: 0.7rem; color: #aaa; margin-bottom: 0.25rem;">
        <span>{i18n.xp_progress}</span>
        <span>{member.xp} / 100</span>
      </div>
      <div style="background: rgba(255,255,255,0.1); height: 4px; border-radius: 2px;">
        <div style="background: var(--accent-color); height: 100%; width: {member.xp}%; border-radius: 2px;"></div>
      </div>
    </div>

    <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
      {#for badge in member.badges}
      <span
        style="background: rgba(255,255,255,0.1); padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem;">{badge}</span>
      {/for}
      <span style="background: rgba(0,0,0,0.3); padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem;">
        {i18n.contribution_score(member.contributions)}</span>
    </div>
  </div>
  {/for}
  {/if}
</section>
{/body}
{/include}