{#include layout/main activePage="comunidad"}
{#title}Comunidad - HomeDir{/title}
{#body}


<header class="page-header events-page-header">
  <div class="section-header">
    <p class="section-subtitle">Personas ¬∑ Comunidad</p>
    <h1>Construimos Homedir juntos</h1>
  </div>
  <p class="section-subtitle">Explora el directorio de integrantes, conecta con la comunidad y √∫nete usando tu cuenta
    vinculada de GitHub.</p>

  {#if prError}
  <div class="retro-box retro-box-error">
    <h3 class="text-error-header">Error al procesar solicitud</h3>
    <p>Hubo un problema al crear tu Pull Request. El equipo ha sido notificado.</p>
    <p class="text-status-msg">Detalle: {prError}</p>
  </div>
  {/if}

  {#if githubLinked}
  <div class="retro-box retro-box-success">
    <h3 class="text-success-header">¬°Cuenta vinculada!</h3>
    <p>Tu cuenta de GitHub ha sido conectada exitosamente. Ahora puedes unirte a la comunidad.</p>
  </div>
  {/if}

  {#if joined}
  <div class="retro-box retro-box-success">
    <h3 class="text-success-header">Solicitud Enviada</h3>
    <p>Se ha creado un Pull Request para agregarte al directorio.</p>
    {#if prUrl}<a href="{prUrl}" target="_blank" class="retro-btn-small">Ver Pull Request</a>{/if}
  </div>
  {/if}

  <div class="main-sections">
    {#if needsGithubLink && isAuthenticated}
    <div class="section-card section-card-join">
      <p class="eyebrow text-join-highlight">√önete</p>
      <h2 class="header-platform-name">Vincula tu GitHub</h2>
      <p>Para aparecer en el directorio y acumular XP.</p>
      <a href="/private/github/start?redirect=/comunidad" class="btn-primary join-btn-margin">Conectar
        ahora</a>
    </div>
    {#else}
    <div class="section-card">
      <p class="eyebrow">Integrantes</p>
      <h2>{totalMembers}</h2>
      <p>Activos en la comunidad</p>
    </div>
    {/if}

    <div class="section-card">
      <p class="eyebrow">Top Contributors</p>
      <div class="leaderboard-mini leaderboard-mini-container">
        {#for leader in leaderboard}
        <a href="{leader.profileUrl}" target="_blank" title="{leader.name} (Lvl {leader.level})"
          class="community-member-card">
          <img src="{leader.avatarUrl}" class="leaderboard-mini-avatar">
        </a>
        {/for}
      </div>
    </div>
  </div>

  <div class="header-actions">
    {#if !isAuthenticated}
    <a class="btn-primary" href="/private/profile">Ingresar y unirme</a>
    {#else if needsGithubLink}
    <a class="btn-primary" href="/private/github/start?redirect=/comunidad">Vincular GitHub</a>
    {#else if joined}
    <button disabled class="btn-primary btn-disabled">Solicitud en proceso</button>
    {#else if !alreadyMember}
    <form action="/comunidad/join" method="POST" class="form-inline">
      <button type="submit" class="btn-primary btn-cursor-pointer">Unirme a la comunidad</button>
    </form>
    {#else}
    <button disabled class="btn-primary btn-disabled">Ya eres miembro</button>
    {/if}

    <a class="btn-primary" href="#directorio">Ver directorio</a>
  </div>
</header>

<section class="page-grid">
  <div class="section-header events-section-margin" style="grid-column: 1 / -1;" id="directorio">
    <div class="community-directory-header">
      <div>
        <h2 class="page-title">Directorio de la Comunidad</h2>
      </div>
      <form class="search-form community-search-form" method="get" action="/comunidad">
        <input type="search" name="q" value="{query ?: ''}" placeholder="Buscar..." aria-label="Buscar integrante"
          class="community-search-input">
        <button class="btn-primary btn-search-submit" type="submit">Buscar</button>
      </form>
    </div>
  </div>

  {#if members.isEmpty()}
  <div class="section-card events-full-width">
    <p>A√∫n no hay integrantes visibles con este filtro.</p>
  </div>
  {#else}
  {#for member in members}
  <div class="section-card member-card member-card-wrapper">
    <div class="member-card-header">
      <img src="{member.avatarUrl}" alt="{member.name}" class="member-card-avatar">
      <div>
        <h3 class="member-name">{member.name}</h3>
        {#if member.github}<a href="{member.profileUrl}" target="_blank"
          class="member-github-link-small">@{member.github}</a>{/if}
      </div>
      <div class="member-status-container">
        <div class="member-badge" title="Miembro Oficial">
          <span class="community-user-icon">üèÖ</span>
        </div>
        <span class="member-lvl-text">Lvl {member.level}</span>
        <span class="member-role-text">{member.role}</span>
      </div>
    </div>

    <div class="xp-progress-container">
      <div class="xp-progress-labels">
        <span>XP Progress</span>
        <span>{member.xp} / 100</span>
      </div>
      <div class="xp-progress-bg">
        <div class="xp-progress-bar" style="--xp-percent: {member.xp}%;"></div>
      </div>
    </div>

    <div class="member-badges-container">
      {#for badge in member.badges}
      <span class="member-badge-pill">{badge}</span>
      {/for}
      <span class="member-score-pill">Contribution
        Score: {member.contributions}</span>
    </div>
  </div>
  {/for}
  {/if}
</section>
{/body}
{/include}