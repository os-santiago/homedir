{#include layout/main activePage="comunidad"}
{#title}Comunidad - HomeDir{/title}
{#body}


<header class="page-header">
  <div class="section-header">
    <p class="section-subtitle">Personas ¬∑ Comunidad</p>
    <h1>Construimos Homedir juntos</h1>
  </div>
  <p class="section-subtitle">Explora el directorio de integrantes, conecta con la comunidad y √∫nete usando tu cuenta
    vinculada de GitHub.</p>

  {#if prError}
  <div class="retro-box" style="margin-top: 1rem; border-color: #ff4444; background: rgba(255, 68, 68, 0.1);">
    <h3 style="color: #ff4444; margin-bottom: 0.5rem;">Error al procesar solicitud</h3>
    <p>Hubo un problema al crear tu Pull Request. El equipo ha sido notificado.</p>
    <p style="font-size: 0.8rem; margin-top: 0.5rem;">Detalle: {prError}</p>
  </div>
  {/if}

  {#if githubLinked}
  <div class="retro-box" style="margin-top: 1rem; border-color: #00fa9a; background: rgba(0, 250, 154, 0.1);">
    <h3 style="color: #00fa9a; margin-bottom: 0.5rem;">¬°Cuenta vinculada!</h3>
    <p>Tu cuenta de GitHub ha sido conectada exitosamente. Ahora puedes unirte a la comunidad.</p>
  </div>
  {/if}

  {#if joined}
  <div class="retro-box" style="margin-top: 1rem; border-color: #00fa9a; background: rgba(0, 250, 154, 0.1);">
    <h3 style="color: #00fa9a; margin-bottom: 0.5rem;">Solicitud Enviada</h3>
    <p>Se ha creado un Pull Request para agregarte al directorio.</p>
    {#if prUrl}<a href="{prUrl}" target="_blank" class="retro-btn-small">Ver Pull Request</a>{/if}
  </div>
  {/if}

  <div class="main-sections" style="margin-top: 2rem;">
    {#if needsGithubLink && isAuthenticated}
    <div class="section-card" style="background: rgba(255, 215, 0, 0.1); border-color: #ffd700;">
      <p class="eyebrow" style="color: #ffd700;">√önete</p>
      <h2 style="font-size: 1.5rem;">Vincula tu GitHub</h2>
      <p>Para aparecer en el directorio y acumular XP.</p>
      <a href="/private/github/start?redirect=/comunidad" class="btn-primary"
        style="margin-top: 1rem; font-size: 0.8rem;">Conectar
        ahora</a>
    </div>
    {#else}
    <div class="section-card">
      <p class="eyebrow">Integrantes</p>
      <h2>{totalMembers}</h2>
      <p>Activos en la comunidad</p>
    </div>
    {/if}

    <div class="section-card">
      <p class="eyebrow">Top Contributors</p>
      <div class="leaderboard-mini" style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
        {#for leader in leaderboard}
        <a href="{leader.profileUrl}" target="_blank" title="{leader.name} (Lvl {leader.level})"
          style="display: block;">
          <img src="{leader.avatarUrl}"
            style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid #ffd700;">
        </a>
        {/for}
      </div>
    </div>
  </div>

  <div style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap;">
    {#if !isAuthenticated}
    <a class="btn-primary" href="/private/profile">Ingresar y unirme</a>
    {#else if needsGithubLink}
    <a class="btn-primary" href="/private/github/start?redirect=/comunidad">Vincular GitHub</a>
    {#else if joined}
    <button disabled class="btn-primary" style="opacity: 0.7; cursor: default;">Solicitud en proceso</button>
    {#else if !alreadyMember}
    <form action="/comunidad/join" method="POST" style="display:inline;">
      <button type="submit" class="btn-primary" style="cursor: pointer;">Unirme a la comunidad</button>
    </form>
    {#else}
    <button disabled class="btn-primary" style="opacity: 0.7; cursor: default;">Ya eres miembro</button>
    {/if}

    <a class="btn-primary" href="#directorio"
      style="background: transparent; border: 1px solid white; color: white;">Ver directorio</a>
  </div>
</header>

<section class="page-grid">
  <div class="section-header" style="grid-column: 1 / -1; margin-top: 2rem;" id="directorio">
    <div style="display: flex; justify-content: space-between; align-items: flex-end; flex-wrap: wrap; gap: 1rem;">
      <div>
        <h2 class="page-title">Directorio de la Comunidad</h2>
      </div>
      <form class="search-form" method="get" action="/comunidad" style="display: flex; gap: 0.5rem;">
        <input type="search" name="q" value="{query ?: ''}" placeholder="Buscar..." aria-label="Buscar integrante"
          style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 0.5rem; font-family: var(--font-body);">
        <button class="btn-primary" type="submit" style="padding: 0.5rem 1rem;">Buscar</button>
      </form>
    </div>
  </div>

  {#if members.isEmpty()}
  <div class="section-card" style="grid-column: 1 / -1;">
    <p>A√∫n no hay integrantes visibles con este filtro.</p>
  </div>
  {#else}
  {#for member in members}
  <div class="section-card member-card" style="position: relative;">
    <div style="display: flex; align-items: center; gap: 1rem; mb-2">
      <img src="{member.avatarUrl}" alt="{member.name}" style="width: 48px; height: 48px; border-radius: 50%;">
      <div>
        <h3 style="margin: 0; font-size: 1.1rem;">{member.name}</h3>
        {#if member.github}<a href="{member.profileUrl}" target="_blank"
          style="color: #888; text-decoration: none; font-size: 0.8rem;">@{member.github}</a>{/if}
      </div>
      <div style="margin-left: auto; text-align: right;">
        <div class="member-badge" title="Miembro Oficial">
          <span style="font-size: 1.2rem;">üèÖ</span>
        </div>
        <span style="display: block; font-weight: bold; color: #ffd700;">Lvl {member.level}</span>
        <span style="font-size: 0.7rem; color: #666;">{member.role}</span>
      </div>
    </div>

    <div style="margin-top: 1rem;">
      <div
        style="display: flex; justify-content: space-between; font-size: 0.7rem; color: #aaa; margin-bottom: 0.25rem;">
        <span>XP Progress</span>
        <span>{member.xp} / 100</span>
      </div>
      <div style="background: rgba(255,255,255,0.1); height: 4px; border-radius: 2px;">
        <div style="background: var(--accent-color); height: 100%; width: {member.xp}%; border-radius: 2px;"></div>
      </div>
    </div>

    <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
      {#for badge in member.badges}
      <span
        style="background: rgba(255,255,255,0.1); padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem;">{badge}</span>
      {/for}
      <span
        style="background: rgba(0,0,0,0.3); padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem;">Contribution
        Score: {member.contributions}</span>
    </div>
  </div>
  {/for}
  {/if}
</section>
{/body}
{/include}