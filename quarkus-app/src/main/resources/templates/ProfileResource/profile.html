{#include layout/main activePage="profile"}
{#title}{i18n:profile_title}{/title}

{#head}
<meta property="og:title" content="{ogTitle}" />
<meta property="og:description" content="{ogDescription}" />
<meta property="og:image" content="https://homedir-d48e2.web.app/images/og-default.png" />
<meta property="og:type" content="profile" />
{/head}

{#body}
<section class="hd-section hd-section-dashboard">

    <div class="hd-page">
        <div class="hd-dashboard-header">
            <div>
                <p class="hd-eyebrow">{i18n:profile_eyebrow}</p>
                <h1 class="hd-page-title">{name}</h1>
                <p class="hd-page-intro">{i18n:profile_intro}</p>
            </div>
            <div class="hd-panel-actions">
                <a class="hd-btn hd-btn-primary" href="/private/profile">{i18n:btn_refresh}</a>
                <a class="hd-btn" href="/logout">{i18n:btn_logout}</a>
            </div>
        </div>

        <div class="hd-panel centered">
            <div class="hd-panel-actions hd-panel-actions-margin">
                {#if githubLinked}
                <div class="hd-alert hd-alert-success">{i18n:msg_github_linked}</div>
                {/if}
                {#if githubError??}
                <div class="hd-alert hd-alert-warning">{i18n:msg_github_error(githubError)}</div>
                {/if}
                {#if discordLinked}
                <div class="hd-alert hd-alert-success">{i18n:msg_discord_linked}</div>
                {/if}
                {#if discordUnlinked}
                <div class="hd-alert hd-alert-success">{i18n:msg_discord_unlinked}</div>
                {/if}
                {#if discordError??}
                <div class="hd-alert hd-alert-warning">{i18n:msg_discord_error(discordError)}</div>
                {/if}
                {#if githubRequired && github == null}
                <div class="hd-alert hd-alert-danger">{i18n:msg_github_required}</div>
                {/if}
            </div>

            <div class="hd-grid-details">
                <div class="hd-detail-item">
                    <span class="hd-detail-label">{i18n:label_email}</span>
                    <span class="hd-detail-value">{email}</span>
                </div>
                <!-- Add more user details here -->
            </div>
        </div>

        <section class="hd-panel centered">
            <h2 class="hd-panel-title">Integrations</h2>

            <div class="hd-integration-card">
                <div class="hd-integration-header">
                    <h3>{i18n:section_gitHub}</h3>
                    {#if githubLinked}
                    <span class="hd-badge hd-badge-success">{i18n:msg_linked}</span>
                    {/if}
                </div>
                {#if github == null}
                <p>{i18n:msg_no_github}</p>
                <a href="/private/github/start?redirect=/private/profile" class="btn-primary btn-github-dark">
                    <img src="https://cdn.simpleicons.org/github/white" width="20" height="20" alt="GitHub"
                        class="icon-github" style="margin-right: 8px;">
                    {i18n:btn_link_github}
                </a>
                {#else}
                <div class="hd-github-user">
                    <img src="{github.avatarUrl}" alt="GitHub Avatar" class="hd-avatar">
                    <div class="hd-github-info">
                        <strong>{github.login}</strong>
                        <a href="{github.profileUrl}" target="_blank" class="hd-link">{i18n:btn_view_profile}</a>
                    </div>
                </div>
                {/if}
            </div>

            <div class="hd-integration-card">
                <div class="hd-integration-header">
                    <h3>{i18n:section_discord}</h3>
                    {#if discord != null}
                    <span class="hd-badge hd-badge-success">{i18n:msg_linked}</span>
                    {/if}
                </div>
                {#if discord == null}
                <p>{i18n:msg_no_discord}</p>
                <a href="/private/discord/start?redirect=/private/profile" class="btn-primary">
                    {i18n:btn_claim_discord_from_board}
                </a>
                {#else}
                <div class="hd-github-user">
                    {#if discord.avatarUrl}
                    <img src="{discord.avatarUrl}" alt="Discord Avatar" class="hd-avatar">
                    {/if}
                    <div class="hd-github-info">
                        <strong>{discord.handle ?: discord.id}</strong>
                        {#if discord.profileUrl}
                        <a href="{discord.profileUrl}" target="_blank" class="hd-link">{i18n:btn_view_profile}</a>
                        {/if}
                    </div>
                </div>
                <form action="/private/profile/unlink-discord" method="POST" class="hd-panel-actions">
                    <input type="hidden" name="redirect" value="/private/profile">
                    <button type="submit" class="hd-btn hd-btn-secondary">{i18n:btn_unlink_discord}</button>
                </form>
                {/if}
            </div>
        </section>

        <!-- Gamification Section -->
        <section class="hd-panel centered">
            <div class="hd-dashboard-header">
                <div>
                    <p class="hd-eyebrow">{i18n:section_resume}</p>
                    <h2 class="hd-panel-title">{i18n:resume_level(questProfile.level)}</h2>
                    <p class="hd-page-intro">{i18n:resume_exp(questProfile.currentXp, questProfile.nextLevelXp)}</p>
                </div>
                {#if publicProfileHandle??}
                <div class="hd-panel-actions">
                    <a class="hd-btn hd-btn-secondary" href="/u/{publicProfileHandle}" target="_blank"
                        rel="noopener noreferrer">
                        <span class="material-symbols-outlined">open_in_new</span> {i18n:btn_view_profile}
                    </a>
                    <button class="hd-btn hd-btn-secondary" onclick="shareProfile('{publicProfileHandle}')">
                        <span class="material-symbols-outlined">share</span> {i18n:btn_share_profile}
                    </button>
                </div>
                {/if}
            </div>

            <h3 class="hd-section-subtitle">{i18n:section_progress}</h3>
            <!-- Progress Bar -->
            <!-- Progress Bar -->
            <div class="progress-bar-container">
                <div class="progress-bar-fill js-progress-fill" data-progress="{questProgressPercent}">
                </div>
            </div>

            <div class="hd-dashboard-header">
                <div>
                    <h2 class="hd-panel-title">{i18n:resume_history}</h2>
                </div>
            </div>
            {#if questProfile.history.isEmpty()}
            <p>{i18n:resume_no_history}</p>
            {#else}
            <ul class="hd-list hd-list-log" role="list">
                {#for item in questProfile.history}
                <li class="hd-list-item hd-log-entry">
                    <div class="hd-list-content">
                        <strong>{item.title}</strong>
                        <span class="hd-list-meta">{item.date}</span>
                    </div>
                    <span class="hd-badge">+{item.xp} XP</span>
                </li>
                {/for}
            </ul>
            {#if resumeHistoryHasMore}
            <div class="hd-panel-actions">
                {#if resumeHistoryAtLimit}
                <span class="hd-detail-label">{i18n:resume_history_limit_notice(resumeHistoryLimit)}</span>
                {#else}
                <a class="hd-btn hd-btn-secondary" href="/private/profile?historyLimit={resumeHistoryNextLimit}">
                    {i18n:resume_history_load_more}
                </a>
                {/if}
            </div>
            {/if}
            {/if}

            <div class="profile-progress-tree-section">
                <h3 class="hd-section-subtitle">{i18n:progress_tree}</h3>
                <p>{i18n:progress_intro}</p>

                <div class="hd-skill-tree">
                    <div class="hd-skill-node {#if questProfile.level >= 1}unlocked{/if}">
                        <div class="hd-skill-icon"><span class="material-symbols-outlined">spa</span></div>
                        <div class="hd-skill-label">{i18n:progress_novice}</div>
                    </div>
                    <div class="hd-skill-connector {#if questProfile.level >= 5}active{/if}"></div>
                    <div class="hd-skill-node {#if questProfile.level >= 5}unlocked{/if}">
                        <div class="hd-skill-icon"><span class="material-symbols-outlined">build</span></div>
                        <div class="hd-skill-label">{i18n:progress_contributor}</div>
                    </div>
                    <div class="hd-skill-connector {#if questProfile.level >= 10}active{/if}"></div>
                    <div class="hd-skill-node {#if questProfile.level >= 10}unlocked{/if}">
                        <div class="hd-skill-icon"><span class="material-symbols-outlined">school</span></div>
                        <div class="hd-skill-label">{i18n:progress_mentor}</div>
                    </div>
                    <div class="hd-skill-connector {#if questProfile.level >= 20}active{/if}"></div>
                    <div class="hd-skill-node {#if questProfile.level >= 20}unlocked{/if}">
                        <div class="hd-skill-icon"><span class="material-symbols-outlined">emoji_events</span></div>
                        <div class="hd-skill-label">{i18n:progress_legend}</div>
                    </div>
                </div>
            </div>

        </section>

        <section class="hd-panel centered">
            <div class="hd-dashboard-header">
                <div>
                    <p class="hd-eyebrow">{i18n:section_identity}</p>
                    <h2 class="hd-panel-title">{i18n:identity_guild}</h2>
                    <p class="hd-page-intro">{i18n:identity_intro}</p>
                </div>
            </div>
            {#if dominantClassMessage??}
            <p class="hd-page-intro">{dominantClassMessage}</p>
            {/if}
            <div class="hd-grid-classes hd-grid-classes-layout">
                {#for cls in classProgress}
                <article class="hd-card hd-class-option {#if cls.dominant}selected{/if}">
                    <div class="class-emoji">
                        {#switch cls.value}
                        {#case 'ENGINEER'}<span class="material-symbols-outlined">engineering</span>{/case}
                        {#case 'SCIENTIST'}<span class="material-symbols-outlined">science</span>{/case}
                        {#case 'WARRIOR'}<span class="material-symbols-outlined">security</span>{/case}
                        {#case 'MAGE'}<span class="material-symbols-outlined">auto_fix_high</span>{/case}
                        {#else}{cls.emoji}{/else}
                        {/switch}
                    </div>
                    <h3 class="class-title">{cls.displayName}</h3>
                    <p class="class-desc">{cls.description}</p>
                    <p class="class-xp-meta">{i18n:profile_class_xp_level(cls.xp, cls.level, cls.percentage)}</p>
                    <div class="progress-bar-container class-progress-bar">
                        <div class="progress-bar-fill js-progress-fill" data-progress="{cls.percentage}"></div>
                    </div>
                </article>
                {/for}
            </div>

            <div class="hd-dashboard-header class-map-header">
                <div>
                    <h3 class="hd-section-subtitle">{i18n:profile_activity_map_title}</h3>
                    <p class="hd-page-intro">{i18n:profile_activity_map_intro}</p>
                </div>
            </div>
            <div class="hd-grid-details activity-class-map">
                <div class="hd-detail-item">
                    <span class="hd-detail-label">{i18n:profile_activity_col_activity}</span>
                </div>
                <div class="hd-detail-item">
                    <span class="hd-detail-label">{i18n:profile_activity_col_examples}</span>
                </div>
                <div class="hd-detail-item">
                    <span class="hd-detail-label">{i18n:profile_activity_col_class}</span>
                </div>
                <div class="hd-detail-item">
                    <span class="hd-detail-label">{i18n:profile_activity_col_action}</span>
                </div>
                {#for row in activityClassMap}
                <div class="hd-detail-item">
                    <span class="hd-detail-value">{row.category}</span>
                </div>
                <div class="hd-detail-item">
                    <span class="hd-detail-value">{row.examples}</span>
                </div>
                <div class="hd-detail-item">
                    <span class="hd-detail-value">{row.className}</span>
                </div>
                <div class="hd-detail-item">
                    <a class="hd-link" href="{row.actionPath}">{i18n:profile_activity_action_open}</a>
                </div>
                {/for}
            </div>
        </section>

        <section class="hd-panel centered" id="economy-panel" data-economy-panel>
            <div class="hd-dashboard-header">
                <div>
                    <p class="hd-eyebrow">{i18n:section_economy}</p>
                    <h2 class="hd-panel-title">{i18n:section_economy}</h2>
                    <p class="hd-page-intro">{i18n:economy_intro}</p>
                </div>
                <div class="hd-panel-actions">
                    <a class="hd-btn hd-btn-secondary" href="/private/profile/catalog">{i18n:economy_btn_open_catalog}</a>
                </div>
            </div>

            <div class="hd-card hd-economy-balance-card">
                <span class="hd-detail-label">{i18n:economy_balance_label}</span>
                <strong class="hd-economy-balance-value" id="economy-balance-value">0 HCoin</strong>
                <span class="hd-detail-value" id="economy-balance-meta">{i18n:economy_loading}</span>
            </div>

            <div class="hd-economy-grid">
                <article class="hd-card hd-economy-card">
                    <h3 class="hd-section-subtitle">{i18n:economy_store_title}</h3>
                    <div class="hd-economy-summary" id="economy-store-summary">
                        <div class="hd-economy-summary-item">
                            <span class="hd-economy-summary-label">{i18n:economy_balance_label}</span>
                            <strong class="hd-economy-summary-value" id="economy-summary-balance">0 HCoin</strong>
                        </div>
                        <div class="hd-economy-summary-item">
                            <span class="hd-economy-summary-label">{i18n:economy_summary_level_label}</span>
                            <strong class="hd-economy-summary-value" id="economy-summary-level">0</strong>
                        </div>
                        <div class="hd-economy-summary-item">
                            <span class="hd-economy-summary-label">{i18n:economy_summary_reachable_label}</span>
                            <strong class="hd-economy-summary-value" id="economy-summary-reachable">0</strong>
                        </div>
                        <div class="hd-economy-summary-item">
                            <span class="hd-economy-summary-label">{i18n:economy_summary_stock_label}</span>
                            <strong class="hd-economy-summary-value" id="economy-summary-stock">0</strong>
                        </div>
                    </div>
                    <div id="economy-store-list" class="hd-economy-list"></div>
                </article>

                <article class="hd-card hd-economy-card">
                    <h3 class="hd-section-subtitle">{i18n:economy_inventory_title}</h3>
                    <div id="economy-inventory-list" class="hd-economy-list"></div>
                </article>
            </div>

            <article class="hd-card hd-economy-card">
                <h3 class="hd-section-subtitle">{i18n:economy_transactions_title}</h3>
                <p class="hd-page-intro hd-economy-partial-hint" id="economy-transactions-hint" hidden>
                    {i18n:economy_tx_partial_hint}
                </p>
                <div id="economy-transactions-list" class="hd-economy-list"></div>
                <div class="hd-panel-actions">
                    <button class="hd-btn hd-btn-secondary" id="economy-load-more-btn" hidden>
                        {i18n:economy_btn_load_more}
                    </button>
                </div>
            </article>
        </section>

        <section class="hd-panel centered">
            <div class="hd-dashboard-header">
                <div>
                    <p class="hd-eyebrow">{i18n:section_settings}</p>
                    <h2 class="hd-panel-title">{i18n:settings_language}</h2>
                    <p class="hd-page-intro">{i18n:settings_language_intro}</p>
                </div>
            </div>
            <form action="/private/profile/update-locale" method="POST" class="profile-settings-form">
                <div class="form-group-margin form-actions-centered">
                    <select name="locale" class="hd-form-input">
                        <option value="en" {#if currentLanguage eq 'en' }selected{/if}>English</option>
                        <option value="es" {#if currentLanguage eq 'es' }selected{/if}>Español</option>
                    </select>
                </div>
                <div class="form-actions-centered">
                    <button type="submit" class="hd-btn hd-btn-primary">{i18n:settings_save}</button>
                </div>
            </form>
        </section>



        <section class="hd-panel centered">
            <div class="hd-dashboard-header">
                <div>
                    <p class="hd-eyebrow">{i18n:section_agenda}</p>
                    <h2 class="hd-panel-title">{i18n:section_agenda}</h2>
                    <p class="hd-page-intro">{i18n:agenda_intro(totalTalks, attendedTalks, ratedTalks)}</p>
                </div>
            </div>

            <div class="hd-tabs">
                <button class="hd-tab active" data-filter="all">{i18n:btn_all}</button>
                <button class="hd-tab" data-filter="attended">{i18n:btn_attended}</button>
                <button class="hd-tab" data-filter="pending">{i18n:btn_pending}</button>
            </div>

            {#if groups.isEmpty()}
            <div class="hd-empty-state">
                <p>{i18n:agenda_no_talks}</p>
                <a href="/eventos" class="hd-btn">{i18n:btn_quest_board}</a>
            </div>
            {#else}
            {#for group in groups}
            <div class="hd-event-group">
                <h3 class="hd-event-title">{group.event.title}</h3>
                <p class="hd-event-meta">{i18n:agenda_days_speakers(group.days.size, group.speakers.size)}</p>

                {#for dayGroup in group.days}
                <h4 class="hd-day-header">{i18n:agenda_day(dayGroup.day)}</h4>
                <div class="hd-grid-schedule">
                    {#for talk in dayGroup.talks}
                    {#let details = info.get(talk.id)}
                    <div class="hd-card hd-talk-card talk-row" data-talk-id="{talk.id}"
                        data-attended="{details.attended}" data-rated="{#if details.rating}true{#else}false{/if}">
                        <div class="hd-talk-header">
                            <span class="hd-talk-time">{talk.startTimeStr}</span>
                        </div>
                        <h4 class="hd-talk-title">
                            <a href="/eventos/{group.event.id}/talks/{talk.id}">{talk.name}</a>
                        </h4>
                        <p class="hd-talk-speaker">{talk.speakerNames}</p>

                        <div class="talk-actions">
                            <div class="motivation-list">
                                {#for m in details.motivations}
                                <span class="badge motivation-badge" data-value="{m}">{m}</span>
                                {/for}
                            </div>
                            <select class="motivation-select hd-form-input" data-talk-id="{talk.id}">
                                <option value="">{i18n:motivation_placeholder}</option>
                                <option>{i18n:motivation_work}</option>
                                <option>{i18n:motivation_learning}</option>
                                <option>{i18n:motivation_speaker}</option>
                                <option>{i18n:motivation_interesting}</option>
                            </select>
                            <label class="attended-label" title="Asistí">
                                <input type="checkbox" class="attended-checkbox" data-talk-id="{talk.id}" {#if
                                    details.attended}checked{/if}>
                            </label>
                            <select id="rating-{talk.id}" class="rating-select hd-form-input" data-talk-id="{talk.id}"
                                title="Valorar">
                                <option value="">-</option>
                                <option value="1" {#if details.rating eq 1}selected{/if}>1</option>
                                <option value="2" {#if details.rating eq 2}selected{/if}>2</option>
                                <option value="3" {#if details.rating eq 3}selected{/if}>3</option>
                                <option value="4" {#if details.rating eq 4}selected{/if}>4</option>
                                <option value="5" {#if details.rating eq 5}selected{/if}>5</option>
                            </select>
                            <button class="hd-btn hd-btn-secondary remove-talk" data-talk-id="{talk.id}"
                                title="Eliminar"><span class="material-symbols-outlined">delete</span></button>
                        </div>
                    </div>
                    {/let}
                    {/for}
                </div>
                {/for}
            </div>
            {/for}
            {/if}
        </section>
        <!-- TODO: ajustar colores/espaciados exactos según maqueta Canva -->
    </div>
</section>

<style>
    .class-xp-meta {
        margin: 0.5rem 0 0.4rem;
        font-size: 0.82rem;
        opacity: 0.88;
    }

    .class-progress-bar {
        margin-top: 0.25rem;
    }

    .class-map-header {
        margin-top: 1.1rem;
    }

    .activity-class-map {
        display: grid;
        grid-template-columns: 1.05fr 1.7fr 0.8fr 0.45fr;
        gap: 0.45rem;
    }

    .hd-economy-balance-card {
        display: grid;
        gap: 0.35rem;
        margin-bottom: 0.9rem;
    }

    .hd-economy-balance-value {
        font-size: 1.5rem;
        line-height: 1.2;
    }

    .hd-economy-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 0.7rem;
        margin-bottom: 0.7rem;
    }

    .hd-economy-card {
        padding: 0.95rem;
    }

    .hd-economy-summary {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 0.45rem;
        margin: 0.15rem 0 0.5rem;
    }

    .hd-economy-summary-item {
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 8px;
        background: rgba(12, 18, 22, 0.35);
        padding: 0.45rem 0.5rem;
        display: grid;
        gap: 0.15rem;
    }

    .hd-economy-summary-label {
        font-size: 0.68rem;
        opacity: 0.78;
        text-transform: uppercase;
        letter-spacing: 0.04em;
    }

    .hd-economy-summary-value {
        font-size: 0.92rem;
        line-height: 1.2;
    }

    .hd-economy-list {
        display: grid;
        gap: 0.55rem;
        margin-top: 0.35rem;
    }

    .hd-economy-item {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 0.65rem;
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 10px;
        padding: 0.6rem 0.7rem;
        background: rgba(12, 18, 22, 0.45);
    }

    .hd-economy-item-main {
        min-width: 0;
        display: grid;
        gap: 0.2rem;
    }

    .hd-economy-item-main strong {
        font-size: 0.95rem;
        line-height: 1.2;
    }

    .hd-economy-item-main p {
        margin: 0;
        font-size: 0.82rem;
        opacity: 0.85;
    }

    .hd-economy-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 0.3rem;
        margin-top: 0.2rem;
    }

    .hd-economy-chip {
        font-size: 0.7rem;
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 999px;
        padding: 0.11rem 0.45rem;
        background: rgba(15, 25, 30, 0.45);
        white-space: nowrap;
    }

    .hd-economy-chip-status {
        border-color: rgba(88, 214, 141, 0.55);
        color: #58d68d;
    }

    .hd-economy-chip-status.locked {
        border-color: rgba(255, 195, 113, 0.55);
        color: #ffc371;
    }

    .hd-economy-chip-status.empty {
        border-color: rgba(241, 148, 138, 0.55);
        color: #f1948a;
    }

    .hd-economy-meta {
        font-size: 0.76rem;
        opacity: 0.72;
    }

    .hd-economy-actions {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        margin-left: auto;
    }

    .hd-economy-partial-hint {
        margin-top: 0;
        margin-bottom: 0.35rem;
        opacity: 0.8;
    }

    @media (max-width: 900px) {
        .activity-class-map {
            grid-template-columns: 1fr;
        }

        .hd-economy-grid {
            grid-template-columns: 1fr;
        }

        .hd-economy-summary {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
    }
</style>

<script>
    function shareProfile(handle) {
        const url = window.location.origin + '/u/' + handle;
        const text = 'Check out my developer profile on HomeDir!';

        if (navigator.share) {
            navigator.share({
                title: 'My HomeDir Profile',
                text: text,
                url: url
            }).catch(console.error);
        } else {
            navigator.clipboard.writeText(url).then(() => {
                alert('Profile link copied to clipboard: ' + url);
            });
        }
    }
    (function () {
        document.querySelectorAll('.js-progress-fill').forEach((bar) => {
            const raw = Number.parseFloat(bar.dataset.progress || '0');
            const progress = Number.isFinite(raw) ? Math.max(0, Math.min(100, raw)) : 0;
            bar.style.setProperty('--xp-percent', progress + '%');
            if (progress > 0 && progress < 2) {
                bar.style.minWidth = '2px';
            }
        });

        const economyPanel = document.querySelector('[data-economy-panel]');
        const economyBalanceValue = document.getElementById('economy-balance-value');
        const economyBalanceMeta = document.getElementById('economy-balance-meta');
        const economySummaryBalance = document.getElementById('economy-summary-balance');
        const economySummaryLevel = document.getElementById('economy-summary-level');
        const economySummaryReachable = document.getElementById('economy-summary-reachable');
        const economySummaryStock = document.getElementById('economy-summary-stock');
        const economyStoreList = document.getElementById('economy-store-list');
        const economyInventoryList = document.getElementById('economy-inventory-list');
        const economyTransactionsList = document.getElementById('economy-transactions-list');
        const economyTransactionsHint = document.getElementById('economy-transactions-hint');
        const economyLoadMoreBtn = document.getElementById('economy-load-more-btn');

        const ECONOMY_TX_PAGE_SIZE = 10;
        const economyState = {
            wallet: null,
            catalog: [],
            inventory: [],
            transactions: [],
            txOffset: 0,
            loadingTransactions: false,
            hasMoreTransactions: false
        };

        const economyText = {
            buy: '{i18n:economy_btn_buy}',
            buying: '{i18n:economy_btn_buying}',
            loading: '{i18n:economy_loading}',
            errorLoading: '{i18n:economy_error_loading}',
            purchaseSuccess: '{i18n:economy_purchase_success_simple}',
            purchaseError: '{i18n:economy_purchase_error_simple}',
            emptyInventory: '{i18n:economy_empty_inventory}',
            emptyTransactions: '{i18n:economy_empty_transactions}',
            inventoryOwnedLabel: '{i18n:economy_inventory_owned(0)}',
            lockedLabel: '{i18n:economy_locked_label}',
            stockLeftLabel: '{i18n:economy_stock_left(0)}',
            requireLevelLabel: '{i18n:economy_require_level(0)}',
            requireTotalXpLabel: '{i18n:economy_require_total_xp(0)}',
            requireClassXpLabel: '{i18n:economy_require_class_xp(0, "Class")}',
            viewCatalog: '{i18n:economy_btn_view_catalog}',
            availableNow: '{i18n:economy_status_available}',
            outOfStock: '{i18n:economy_status_out_of_stock}'
        };

        const formatHcoin = (value) => {
            const amount = Number.isFinite(Number(value)) ? Number(value) : 0;
            return amount.toLocaleString() + ' HCoin';
        };

        const extractErrorCode = async (response) => {
            try {
                const body = await response.json();
                if (body && typeof body.error === 'string' && body.error) {
                    return body.error;
                }
                if (body && typeof body.detail === 'string' && body.detail) {
                    return body.detail;
                }
            } catch (_) {
                // ignore non-json payloads
            }
            return 'unknown';
        };

        const economyFetchJson = async (url, options = {}) => {
            const response = await fetch(url, {
                ...options,
                headers: {
                    Accept: 'application/json',
                    ...(options.headers || {})
                }
            });
            if (!response.ok) {
                const code = await extractErrorCode(response);
                const error = new Error(code);
                error.code = code;
                throw error;
            }
            return response.json();
        };

        const setEconomyBalance = (wallet) => {
            const balance = wallet && Number.isFinite(Number(wallet.balance_hcoin))
                ? Number(wallet.balance_hcoin)
                : 0;
            economyBalanceValue.textContent = formatHcoin(balance);
            economyBalanceMeta.textContent = '{i18n:economy_balance_amount(0)}'.replace('0', balance.toLocaleString());
            if (economySummaryBalance) {
                economySummaryBalance.textContent = formatHcoin(balance);
            }
        };

        const buildEconomyItem = (title, description, metaText) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'hd-economy-item';
            const main = document.createElement('div');
            main.className = 'hd-economy-item-main';
            const strong = document.createElement('strong');
            strong.textContent = title;
            main.appendChild(strong);
            if (description) {
                const desc = document.createElement('p');
                desc.textContent = description;
                main.appendChild(desc);
            }
            if (metaText) {
                const meta = document.createElement('span');
                meta.className = 'hd-economy-meta';
                meta.textContent = metaText;
                main.appendChild(meta);
            }
            wrapper.appendChild(main);
            return wrapper;
        };

        const renderStore = () => {
            if (!economyStoreList) return;
            economyStoreList.replaceChildren();
            const balance = economyState.wallet && Number.isFinite(Number(economyState.wallet.balance_hcoin))
                ? Number(economyState.wallet.balance_hcoin)
                : 0;
            if (!Array.isArray(economyState.catalog) || economyState.catalog.length === 0) {
                const empty = document.createElement('p');
                empty.className = 'hd-page-intro';
                empty.textContent = economyText.loading;
                economyStoreList.appendChild(empty);
                if (economySummaryLevel) economySummaryLevel.textContent = '0';
                if (economySummaryReachable) economySummaryReachable.textContent = '0';
                if (economySummaryStock) economySummaryStock.textContent = '0';
                return;
            }
            const toInt = (value) => Number.isFinite(Number(value)) ? Number(value) : 0;
            const formatStockLeft = (value) =>
                economyText.stockLeftLabel.replace('0', Math.max(0, toInt(value)).toLocaleString());
            const createChip = (text, extraClass) => {
                const chip = document.createElement('span');
                chip.className = 'hd-economy-chip' + (extraClass ? (' ' + extraClass) : '');
                chip.textContent = text;
                return chip;
            };
            const lockReasonText = (item) => {
                const lockReason = item.lock_reason || '';
                if (lockReason === 'requires_level') {
                    const requiredLevel = toInt(item.required_level);
                    return economyText.requireLevelLabel.replace('0', requiredLevel.toLocaleString());
                }
                if (lockReason === 'requires_total_xp') {
                    const requiredXp = toInt(item.required_total_xp);
                    return economyText.requireTotalXpLabel.replace('0', requiredXp.toLocaleString());
                }
                if (lockReason === 'requires_class_xp') {
                    const requiredClassXp = toInt(item.required_class_xp);
                    const requiredClass = item.required_class || 'Class';
                    return economyText.requireClassXpLabel
                        .replace('0', requiredClassXp.toLocaleString())
                        .replace('Class', requiredClass);
                }
                return economyText.lockedLabel;
            };
            let currentLevel = 0;
            let reachableCount = 0;
            let inStockCount = 0;
            economyState.catalog.forEach((item) => {
                const unlocked = item.unlocked !== false;
                const remainingStock = toInt(item.remaining_stock);
                const tier = item.tier ? String(item.tier).toUpperCase() : '';
                const currentItemLevel = toInt(item.current_level);
                const requiredLevel = toInt(item.required_level);
                const priceHcoin = toInt(item.price_hcoin);
                const noStock = unlocked && Number.isFinite(remainingStock) && remainingStock <= 0;
                const cannotAfford = priceHcoin > balance;
                currentLevel = Math.max(currentLevel, currentItemLevel);
                if (unlocked && !noStock) {
                    inStockCount++;
                }
                if (unlocked && !noStock && !cannotAfford) {
                    reachableCount++;
                }
                const card = buildEconomyItem(
                    item.name || item.id,
                    item.description || '',
                    ''
                );
                const main = card.querySelector('.hd-economy-item-main');
                if (main) {
                    const chips = document.createElement('div');
                    chips.className = 'hd-economy-chips';
                    if (tier) {
                        chips.appendChild(createChip(tier));
                    }
                    chips.appendChild(createChip(formatHcoin(priceHcoin)));
                    chips.appendChild(createChip('L' + currentItemLevel + '/' + requiredLevel));
                    chips.appendChild(createChip(formatStockLeft(remainingStock)));
                    if (!unlocked) {
                        chips.appendChild(createChip(economyText.lockedLabel, 'hd-economy-chip-status locked'));
                        chips.appendChild(createChip(lockReasonText(item)));
                    } else if (noStock) {
                        chips.appendChild(createChip(economyText.outOfStock, 'hd-economy-chip-status empty'));
                    } else {
                        chips.appendChild(createChip(economyText.availableNow, 'hd-economy-chip-status'));
                    }
                    main.appendChild(chips);
                }
                const actions = document.createElement('div');
                actions.className = 'hd-economy-actions';
                const previewLink = document.createElement('a');
                previewLink.className = 'hd-btn hd-btn-secondary';
                previewLink.href = '/private/profile/catalog#' + encodeURIComponent(item.id || '');
                previewLink.textContent = economyText.viewCatalog;
                actions.appendChild(previewLink);
                const button = document.createElement('button');
                button.className = 'hd-btn hd-btn-secondary economy-buy-btn';
                button.dataset.itemId = item.id;
                button.textContent = economyText.buy;
                if (cannotAfford || !unlocked || noStock) {
                    button.disabled = true;
                }
                actions.appendChild(button);
                card.appendChild(actions);
                economyStoreList.appendChild(card);
            });
            if (economySummaryLevel) economySummaryLevel.textContent = currentLevel.toLocaleString();
            if (economySummaryReachable) {
                economySummaryReachable.textContent =
                    reachableCount.toLocaleString() + '/' + economyState.catalog.length.toLocaleString();
            }
            if (economySummaryStock) {
                economySummaryStock.textContent =
                    inStockCount.toLocaleString() + '/' + economyState.catalog.length.toLocaleString();
            }
        };

        const renderInventory = () => {
            if (!economyInventoryList) return;
            economyInventoryList.replaceChildren();
            if (!Array.isArray(economyState.inventory) || economyState.inventory.length === 0) {
                const empty = document.createElement('p');
                empty.className = 'hd-page-intro';
                empty.textContent = economyText.emptyInventory;
                economyInventoryList.appendChild(empty);
                return;
            }
            economyState.inventory.forEach((item) => {
                const qty = Number(item.quantity || 0);
                const meta = economyText.inventoryOwnedLabel.replace('0', qty.toLocaleString());
                const entry = buildEconomyItem(
                    item.name || item.item_id || 'Item',
                    item.category || '',
                    meta
                );
                economyInventoryList.appendChild(entry);
            });
        };

        const renderTransactions = () => {
            if (!economyTransactionsList) return;
            economyTransactionsList.replaceChildren();
            if (!Array.isArray(economyState.transactions) || economyState.transactions.length === 0) {
                const empty = document.createElement('p');
                empty.className = 'hd-page-intro';
                empty.textContent = economyText.emptyTransactions;
                economyTransactionsList.appendChild(empty);
                return;
            }
            economyState.transactions.forEach((tx) => {
                const amount = Number(tx.amount_hcoin || 0);
                const signedAmount = amount > 0 ? '+' + formatHcoin(amount) : formatHcoin(amount);
                const date = tx.created_at ? new Date(tx.created_at) : null;
                const metaDate = date && !Number.isNaN(date.getTime()) ? date.toLocaleString() : '';
                const entry = buildEconomyItem(
                    tx.description || tx.type || 'Transaction',
                    tx.item_id || '',
                    signedAmount + ' · ' + metaDate
                );
                economyTransactionsList.appendChild(entry);
            });
        };

        const updateEconomyLoadMoreButton = () => {
            if (!economyLoadMoreBtn) return;
            economyLoadMoreBtn.hidden = !economyState.hasMoreTransactions || economyState.loadingTransactions;
            economyLoadMoreBtn.disabled = economyState.loadingTransactions;
        };

        const loadWallet = async () => {
            const payload = await economyFetchJson('/api/economy/wallet');
            economyState.wallet = payload.wallet || { balance_hcoin: 0 };
            setEconomyBalance(economyState.wallet);
            renderStore();
        };

        const loadCatalog = async () => {
            const payload = await economyFetchJson('/api/economy/catalog');
            economyState.catalog = Array.isArray(payload.items) ? payload.items : [];
            renderStore();
        };

        const loadInventory = async () => {
            const payload = await economyFetchJson('/api/economy/inventory?limit=20&offset=0');
            economyState.inventory = Array.isArray(payload.items) ? payload.items : [];
            renderInventory();
        };

        const loadTransactions = async (reset = false) => {
            if (economyState.loadingTransactions) return;
            economyState.loadingTransactions = true;
            updateEconomyLoadMoreButton();
            try {
                const offset = reset ? 0 : economyState.txOffset;
                const payload =
                    await economyFetchJson('/api/economy/transactions?limit=' + ECONOMY_TX_PAGE_SIZE + '&offset=' + offset);
                const items = Array.isArray(payload.items) ? payload.items : [];
                if (reset) {
                    economyState.transactions = items;
                } else {
                    economyState.transactions = economyState.transactions.concat(items);
                }
                economyState.txOffset = offset + items.length;
                const hasTotal = Number.isFinite(Number(payload.total));
                const total = hasTotal ? Number(payload.total) : economyState.transactions.length;
                economyState.hasMoreTransactions =
                    items.length === ECONOMY_TX_PAGE_SIZE || payload.partial === true || economyState.txOffset < total;
                if (items.length === 0) {
                    economyState.hasMoreTransactions = false;
                }
                if (economyTransactionsHint) {
                    economyTransactionsHint.hidden = payload.partial !== true;
                }
                renderTransactions();
            } finally {
                economyState.loadingTransactions = false;
                updateEconomyLoadMoreButton();
            }
        };

        const refreshEconomy = async () => {
            if (!economyPanel) return;
            try {
                if (economyBalanceMeta) {
                    economyBalanceMeta.textContent = economyText.loading;
                }
                await Promise.all([loadWallet(), loadCatalog(), loadInventory()]);
                await loadTransactions(true);
            } catch (_) {
                if (economyBalanceMeta) {
                    economyBalanceMeta.textContent = economyText.errorLoading;
                }
                const renderError = (container) => {
                    if (!container) return;
                    container.replaceChildren();
                    const node = document.createElement('p');
                    node.className = 'hd-page-intro';
                    node.textContent = economyText.errorLoading;
                    container.appendChild(node);
                };
                renderError(economyStoreList);
                renderError(economyInventoryList);
                renderError(economyTransactionsList);
                showNotification('error', economyText.errorLoading);
            }
        };

        if (economyLoadMoreBtn) {
            economyLoadMoreBtn.addEventListener('click', async () => {
                await loadTransactions(false);
            });
        }

        if (economyStoreList) {
            economyStoreList.addEventListener('click', async (event) => {
                const button = event.target.closest('.economy-buy-btn');
                if (!button) return;
                const itemId = button.dataset.itemId;
                if (!itemId) return;
                const originalText = button.textContent;
                button.disabled = true;
                button.textContent = economyText.buying;
                try {
                    await economyFetchJson('/api/economy/purchase', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ itemId })
                    });
                    await Promise.all([loadWallet(), loadInventory()]);
                    await loadTransactions(true);
                    renderStore();
                    showNotification('success', economyText.purchaseSuccess + ' (' + itemId + ')');
                } catch (error) {
                    const code = (error && error.code) ? error.code : 'unknown';
                    showNotification('error', economyText.purchaseError + ' (' + code + ')');
                } finally {
                    button.textContent = originalText;
                    renderStore();
                }
            });
        }

        if (economyPanel) {
            refreshEconomy();
        }

        const updateTalk = async (id, data) => {
            try {
                const res = await fetch('/private/profile/update/' + id, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!res.ok) {
                    showNotification('error', '{i18n:msg_error_saving}');
                }
            } catch (e) {
                showNotification('error', '{i18n:msg_error_saving}');
            }
        };

        const updateSummary = () => {
            const total = document.querySelectorAll('.talk-row').length;
            const attended = document.querySelectorAll('.talk-row[data-attended="true"]').length;
            const rated = document.querySelectorAll('.talk-row[data-rated="true"]').length;
            const summary = document.getElementById('summary');
            if (summary) {
                summary.textContent = 'Has agregado ' + total + ' charlas a tu agenda, has asistido a ' + attended + ' y calificado ' + rated + '.';
            }
        };

        document.querySelectorAll('.remove-talk').forEach(btn => {
            btn.addEventListener('click', async () => {
                if (!confirm('{i18n:msg_confirm_delete}')) return;
                const id = btn.dataset.talkId;
                btn.disabled = true;
                try {
                    const res = await fetch('/private/profile/remove/' + id, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                        body: JSON.stringify({})
                    });
                    if (res.ok) {
                        btn.closest('.talk-row').remove();
                        updateSummary();
                    } else {
                        showNotification('error', '{i18n:msg_error_removing}');
                    }
                } catch (e) {
                    showNotification('error', '{i18n:msg_error_removing}');
                }
            });
        });

        document.querySelectorAll('.motivation-select').forEach(select => {
            select.addEventListener('change', async () => {
                const id = select.dataset.talkId;
                const motivation = select.value;
                if (!motivation) return;
                await updateTalk(id, { motivation });
            });
        });

        document.querySelectorAll('.attended-checkbox').forEach(cb => {
            cb.addEventListener('change', async () => {
                const id = cb.dataset.talkId;
                const attended = cb.checked;
                const row = cb.closest('.talk-row');
                row.dataset.attended = attended;
                await updateTalk(id, { attended });
                updateSummary();
            });
        });

        document.querySelectorAll('.rating-select').forEach(sel => {
            sel.addEventListener('change', async () => {
                const id = sel.dataset.talkId;
                const rating = sel.value ? parseInt(sel.value, 10) : null;
                const row = sel.closest('.talk-row');
                row.dataset.rated = rating != null;
                await updateTalk(id, { rating });
                updateSummary();
            });
        });

        const filterButtons = document.querySelectorAll('[data-filter]');
        const rows = document.querySelectorAll('.talk-row');
        filterButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                // Toggle active state
                filterButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                const filter = btn.dataset.filter;
                rows.forEach(row => {
                    const attended = row.dataset.attended === 'true';
                    if (filter === 'attended') row.hidden = !attended;
                    else if (filter === 'pending') row.hidden = attended;
                    else row.hidden = false;
                });
            });
        });
    })();
</script>
{/body}
