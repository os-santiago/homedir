{#include layout/base}
{#title}Mi perfil{/title}
{#main}
<h1>Perfil de usuario</h1>
<p><strong>Nombre completo:</strong> {name}</p>
<p><strong>Email:</strong> {email}</p>

<h2 class="page-title">Tus Charlas Registradas</h2>
{#if groups.isEmpty()}
<p>Aún no hay charlas.</p>
{#else}
<p id="summary">Has agregado {totalTalks} charlas a tu agenda, has asistido a {attendedTalks} y calificado {ratedTalks}.</p>
<div class="filter">
  <button type="button" class="btn filter-btn" data-filter="all">Todas</button>
  <button type="button" class="btn filter-btn" data-filter="attended">Asistidas</button>
  <button type="button" class="btn filter-btn" data-filter="pending">No asistidas</button>
</div>
{#for g in groups}
  <div class="event-group">
    <h3 class="event-title">{g.event.title}</h3>
    {#for d in g.days}
      <h4 class="day-title">Día {d.day}</h4>
      <div class="talks-day">
        {#for t in d.talks}
        <div class="card talk-card" data-talk-id="{t.id}" data-attended="{info.get(t.id).attended}" data-rated="{info.get(t.id).rating??}">
          <h5>
            <span class="attendance-icon">{#if info.get(t.id).attended}✅{#else}❌{/if}</span>
            <a href="/talk/{t.id}">{t.name}</a>
            <span class="state-icon">
              {#if app:talkState(t) == 'Pronto'}⏰{/if}
              {#if app:talkState(t) == 'Finalizada'}🕓{/if}
            </span>
          </h5>
          <p class="talk-speaker">{#if t.speaker}{t.speaker.name}{/if}</p>
          <p class="talk-time">{t.startTimeStr} ({t.durationMinutes} min)</p>
          <p class="talk-scenario">{g.event.getScenarioName(t.location)}</p>
          <div class="motivation-list">
            {#for m in info.get(t.id).motivations}
              <span class="badge motivation-badge" data-value="{m}">{m}</span>
            {/for}
          </div>
          <select class="motivation-select" data-talk-id="{t.id}">
            <option value="">Añadir motivo...</option>
            <option>⭐ Relevante para mi trabajo</option>
            <option>🧠 Quiero aprender sobre esto</option>
            <option>🎤 Conozco al speaker</option>
            <option>🎯 Me pareció interesante</option>
          </select>
          <div class="attendance">
            <label><input type="checkbox" class="attended-checkbox" data-talk-id="{t.id}" {#if info.get(t.id).attended}checked{/if}> Asistí</label>
          </div>
          <div class="rating">
            <select class="rating-select" data-talk-id="{t.id}">
              <option value="">Calificación</option>
              <option value="1" {#if info.get(t.id).rating == 1}selected{/if}>1</option>
              <option value="2" {#if info.get(t.id).rating == 2}selected{/if}>2</option>
              <option value="3" {#if info.get(t.id).rating == 3}selected{/if}>3</option>
              <option value="4" {#if info.get(t.id).rating == 4}selected{/if}>4</option>
              <option value="5" {#if info.get(t.id).rating == 5}selected{/if}>5</option>
            </select>
          </div>
          <button class="btn btn-secondary remove-talk" data-talk-id="{t.id}">Eliminar</button>
        </div>
        {/for}
      </div>
    {/for}
  </div>
{/for}
{/if}
  <p><a href="/private/admin">Admin Panel</a></p>
  <p><a href="/logout">Salir</a></p>
  <script>
  (function() {
    const updateTalk = async (id, data) => {
      try {
        const res = await fetch('/private/profile/update/' + id, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify(data)
        });
        if (!res.ok) {
          showNotification('error', 'Error al guardar los cambios');
        }
      } catch (e) {
        showNotification('error', 'Error al guardar los cambios');
      }
    };

    const updateSummary = () => {
      const total = document.querySelectorAll('.talk-card').length;
      const attended = document.querySelectorAll('.talk-card[data-attended="true"]').length;
      const rated = document.querySelectorAll('.talk-card[data-rated="true"]').length;
      const summary = document.getElementById('summary');
      if (summary) {
        summary.textContent = `Has agregado ${total} charlas a tu agenda, has asistido a ${attended} y calificado ${rated}.`;
      }
    };

    document.querySelectorAll('.remove-talk').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!confirm('¿Estás seguro?')) return;
        const id = btn.dataset.talkId;
        try {
          const res = await fetch('/private/profile/remove/' + id, { method: 'POST', headers: { 'Accept': 'application/json' } });
          if (res.ok) {
            const data = await res.json();
            if (data.status === 'removed') {
              const card = btn.closest('.talk-card');
              if (card) card.remove();
              updateSummary();
              showNotification('success', 'Charla eliminada');
            } else {
              showNotification('error', 'Charla no encontrada');
            }
          } else {
            showNotification('error', 'Ocurrió un error al eliminar la charla');
          }
        } catch (e) {
          showNotification('error', 'Ocurrió un error al eliminar la charla');
        }
      });
    });

    document.querySelectorAll('.attended-checkbox').forEach(cb => {
      cb.addEventListener('change', () => {
        const id = cb.dataset.talkId;
        const attended = cb.checked;
        const card = cb.closest('.talk-card');
        if (card) {
          card.dataset.attended = attended ? 'true' : 'false';
          card.querySelector('.attendance-icon').textContent = attended ? '✅' : '❌';
        }
        updateTalk(id, { attended });
        updateSummary();
      });
    });

    document.querySelectorAll('.rating-select').forEach(sel => {
      sel.addEventListener('change', () => {
        const id = sel.dataset.talkId;
        const rating = sel.value ? parseInt(sel.value) : null;
        const card = sel.closest('.talk-card');
        if (card) {
          card.dataset.rated = rating ? 'true' : 'false';
        }
        updateTalk(id, { rating });
        updateSummary();
      });
    });

    document.querySelectorAll('.motivation-select').forEach(sel => {
      sel.addEventListener('change', () => {
        const value = sel.value;
        if (!value) return;
        const card = sel.closest('.talk-card');
        const list = card.querySelector('.motivation-list');
        if ([...list.children].some(b => b.dataset.value === value)) {
          sel.value = '';
          return;
        }
        const badge = document.createElement('span');
        badge.className = 'badge motivation-badge';
        badge.dataset.value = value;
        badge.textContent = value;
        badge.addEventListener('click', () => {
          badge.remove();
          saveMotivations(card);
        });
        list.appendChild(badge);
        sel.value = '';
        saveMotivations(card);
      });
    });

    const saveMotivations = (card) => {
      const id = card.dataset.talkId;
      const motivations = [...card.querySelectorAll('.motivation-badge')].map(b => b.dataset.value);
      updateTalk(id, { motivations });
    };

    document.querySelectorAll('.motivation-badge').forEach(badge => {
      badge.addEventListener('click', () => {
        const card = badge.closest('.talk-card');
        badge.remove();
        saveMotivations(card);
      });
    });

    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const filter = btn.dataset.filter;
        document.querySelectorAll('.talk-card').forEach(card => {
          const attended = card.dataset.attended === 'true';
          if (filter === 'all' || (filter === 'attended' && attended) || (filter === 'pending' && !attended)) {
            card.style.display = '';
          } else {
            card.style.display = 'none';
          }
        });
      });
    });

    updateSummary();
  })();
    </script>
  {/main}
  {/include}
