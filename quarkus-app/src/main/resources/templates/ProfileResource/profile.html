{#include layout/main activePage="profile"}
{#title}{i18n.profile_title}{/title}

{#head}
<meta property="og:title" content="{ogTitle}" />
<meta property="og:description" content="{ogDescription}" />
<meta property="og:image" content="https://homedir-d48e2.web.app/images/og-default.png" />
<meta property="og:type" content="profile" />
{/head}

{#body}
<section class="hd-section hd-section-dashboard">

    <div class="hd-page">
        <div class="hd-dashboard-header">
            <div>
                <p class="hd-eyebrow">{i18n.profile_eyebrow}</p>
                <h1 class="hd-page-title">{name}</h1>
                <p class="hd-page-intro">{i18n.profile_intro}</p>
            </div>
            <div class="hd-panel-actions">
                <a class="hd-btn hd-btn-primary" href="/private/profile">{i18n.btn_refresh}</a>
                <a class="hd-btn" href="/logout">{i18n.btn_logout}</a>
            </div>
        </div>

        <div class="hd-panel">
            <div class="hd-panel-actions hd-panel-actions-margin">
                {#if githubLinked}
                <div class="hd-alert hd-alert-success">{i18n.msg_github_linked}</div>
                {/if}
                {#if githubError??}
                <div class="hd-alert hd-alert-warning">{i18n.msg_github_error(githubError)}</div>
                {/if}
                {#if githubRequired && github == null}
                <div class="hd-alert hd-alert-danger">{i18n.msg_github_required}</div>
                {/if}
            </div>

            <div class="hd-grid-details">
                <div class="hd-detail-item">
                    <span class="hd-detail-label">{i18n.label_email}</span>
                    <span class="hd-detail-value">{email}</span>
                </div>
                <!-- Add more user details here -->
            </div>
        </div>

        <section class="hd-panel">
            <h2 class="hd-panel-title">Integrations</h2>

            <div class="hd-integration-card">
                <div class="hd-integration-header">
                    <h3>{i18n.section_gitHub}</h3>
                    {#if githubLinked}
                    <span class="hd-badge hd-badge-success">{i18n.msg_linked}</span>
                    {/if}
                </div>
                {#if github == null}
                <p>{i18n.msg_no_github}</p>
                <a href="/private/github/start?redirect=/private/profile" class="btn-primary btn-github-dark">
                    <img src="https://cdn.simpleicons.org/github/white" width="20" height="20" alt="GitHub"
                        class="icon-github" style="margin-right: 8px;">
                    {i18n.btn_link_github}
                </a>
                {#else}
                <div class="hd-github-user">
                    <img src="{github.avatarUrl}" alt="GitHub Avatar" class="hd-avatar">
                    <div class="hd-github-info">
                        <strong>{github.login}</strong>
                        <a href="{github.profileUrl}" target="_blank" class="hd-link">{i18n.btn_view_profile}</a>
                    </div>
                </div>
                {/if}
            </div>
        </section>

        <!-- Gamification Section -->
        <section class="hd-panel">
            <div class="hd-dashboard-header">
                <div>
                    <p class="hd-eyebrow">{i18n.section_resume}</p>
                    <h2 class="hd-panel-title">{i18n.resume_level(questProfile.level)}</h2>
                    <p class="hd-page-intro">{i18n.resume_exp(questProfile.currentXp, questProfile.nextLevelXp)}</p>
                </div>
                {#if githubLinked}
                <div class="hd-panel-actions">
                    <button class="hd-btn hd-btn-secondary" onclick="shareProfile('{github.login}')">
                        <span class="material-symbols-outlined">share</span> {i18n.btn_share_profile}
                    </button>
                </div>
                {/if}
            </div>

            <h3 class="hd-section-subtitle">{i18n.section_progress}</h3>
            <!-- Progress Bar -->
            <!-- Progress Bar -->
            <div class="progress-bar-container">
                <div class="progress-bar-fill"
                    style="--xp-percent: {(questProfile.currentXp / questProfile.nextLevelXp) * 100}%">
                </div>
            </div>

            <div class="hd-dashboard-header">
                <div>
                    <h2 class="hd-panel-title">{i18n.resume_history}</h2>
                </div>
            </div>
            {#if questProfile.history.isEmpty()}
            <p>{i18n.resume_no_history}</p>
            {#else}
            <ul class="hd-list">
                {#for item in questProfile.history}
                <li class="hd-list-item">
                    <div class="hd-list-content">
                        <strong>{item.title}</strong>
                        <span class="hd-list-meta">{item.date}</span>
                    </div>
                    <span class="hd-badge">+{item.xp} XP</span>
                </li>
                {/for}
            </ul>
            {/if}

            <div class="profile-progress-tree-section">
                <h3 class="hd-section-subtitle">{i18n.progress_tree}</h3>
                <p>{i18n.progress_intro}</p>

                <div class="hd-skill-tree">
                    <div class="hd-skill-node {#if questProfile.level >= 1}unlocked{/if}">
                        <div class="hd-skill-icon"><span class="material-symbols-outlined">sprout</span></div>
                        <div class="hd-skill-label">{i18n.progress_novice}</div>
                    </div>
                    <div class="hd-skill-connector {#if questProfile.level >= 5}active{/if}"></div>
                    <div class="hd-skill-node {#if questProfile.level >= 5}unlocked{/if}">
                        <div class="hd-skill-icon"><span class="material-symbols-outlined">build</span></div>
                        <div class="hd-skill-label">{i18n.progress_contributor}</div>
                    </div>
                    <div class="hd-skill-connector {#if questProfile.level >= 10}active{/if}"></div>
                    <div class="hd-skill-node {#if questProfile.level >= 10}unlocked{/if}">
                        <div class="hd-skill-icon"><span class="material-symbols-outlined">school</span></div>
                        <div class="hd-skill-label">{i18n.progress_mentor}</div>
                    </div>
                    <div class="hd-skill-connector {#if questProfile.level >= 20}active{/if}"></div>
                    <div class="hd-skill-node {#if questProfile.level >= 20}unlocked{/if}">
                        <div class="hd-skill-icon"><span class="material-symbols-outlined">emoji_events</span></div>
                        <div class="hd-skill-label">{i18n.progress_legend}</div>
                    </div>
                </div>
            </div>

        </section>

        <section class="hd-panel">
            <div class="hd-dashboard-header">
                <div>
                    <p class="hd-eyebrow">{i18n.section_identity}</p>
                    <h2 class="hd-panel-title">{i18n.identity_guild}</h2>
                    <p class="hd-page-intro">{i18n.identity_intro}</p>
                </div>
            </div>

            <form action="/private/profile/update-class" method="POST" class="profile-class-form">
                <div class="hd-grid-classes hd-grid-classes-layout">
                    {#for opt in classOptions}
                    <label class="hd-card hd-class-option {#if opt.checked}selected{/if} hd-card-option-label">
                        <input type="radio" name="questClass" value="{opt.value}" class="hd-radio-input" {#if
                            opt.checked}checked{/if}>
                        <div class="class-emoji">{opt.emoji}</div>
                        <h3 class="class-title">{opt.displayName}</h3>
                        <p class="class-desc">{opt.description}</p>
                    </label>
                    {/for}
                </div>
                <div class="form-actions-centered">
                    <button type="submit" class="hd-btn hd-btn-primary">{i18n.btn_save_class}</button>
                </div>
            </form>
        </section>

        <section class="hd-panel">
            <div class="hd-dashboard-header">
                <div>
                    <p class="hd-eyebrow">{i18n.section_settings}</p>
                    <h2 class="hd-panel-title">{i18n.settings_language}</h2>
                    <p class="hd-page-intro">{i18n.settings_language_intro}</p>
                </div>
            </div>
            <form action="/private/profile/update-locale" method="POST" class="profile-settings-form">
                <div class="form-group-margin form-actions-centered">
                    <select name="locale" class="hd-form-input">
                        <option value="en" {#if currentLanguage eq 'en' }selected{/if}>English</option>
                        <option value="es" {#if currentLanguage eq 'es' }selected{/if}>Español</option>
                    </select>
                </div>
                <div class="form-actions-centered">
                    <button type="submit" class="hd-btn hd-btn-primary">{i18n.settings_save}</button>
                </div>
            </form>
        </section>

        <section class="hd-panel">
            <div class="hd-dashboard-header">
                <div>
                    <p class="hd-eyebrow">{i18n.section_community}</p>
                    <h2 class="hd-panel-title">{i18n.btn_explore_community}</h2>
                    <p class="hd-page-intro">{i18n.community_initiatives(5)}</p>
                </div>
                <div class="hd-panel-actions">
                    <a class="hd-btn" href="/comunidad">{i18n.btn_explore_community}</a>
                </div>
            </div>
        </section>

        <section class="hd-panel">
            <div class="hd-dashboard-header">
                <div>
                    <p class="hd-eyebrow">{i18n.section_agenda}</p>
                    <h2 class="hd-panel-title">{i18n.section_agenda}</h2>
                    <p class="hd-page-intro">{i18n.agenda_intro(totalTalks, attendedTalks, ratedTalks)}</p>
                </div>
            </div>

            <div class="hd-tabs">
                <button class="hd-tab active">{i18n.btn_all}</button>
                <button class="hd-tab">{i18n.btn_attended}</button>
                <button class="hd-tab">{i18n.btn_pending}</button>
            </div>

            {#if groups.isEmpty()}
            <div class="hd-empty-state">
                <p>{i18n.agenda_no_talks}</p>
                <a href="/eventos" class="hd-btn">{i18n.btn_quest_board}</a>
            </div>
            {#else}
            {#for group in groups}
            <div class="hd-event-group">
                <h3 class="hd-event-title">{group.event.title}</h3>
                <p class="hd-event-meta">{i18n.agenda_days_speakers(group.days.size, group.speakers.size)}</p>

                {#for dayGroup in group.days}
                <h4 class="hd-day-header">{i18n.agenda_day(dayGroup.day)}</h4>
                <div class="hd-grid-schedule">
                    {#for talk in dayGroup.talks}
                    {#let details = info.get(talk.id)}
                    <div class="hd-card hd-talk-card talk-row" data-talk-id="{talk.id}"
                        data-attended="{details.attended}" data-rated="{#if details.rating}true{#else}false{/if}">
                        <div class="hd-talk-header">
                            <span class="hd-talk-time">{talk.startTimeStr}</span>
                        </div>
                        <h4 class="hd-talk-title">
                            <a href="/eventos/{group.event.id}/talks/{talk.id}">{talk.name}</a>
                        </h4>
                        <p class="hd-talk-speaker">{talk.speakerNames}</p>

                        <div class="talk-actions">
                            <div class="motivation-list">
                                {#for m in details.motivations}
                                <span class="badge motivation-badge" data-value="{m}">{m}</span>
                                {/for}
                            </div>
                            <select class="motivation-select hd-form-input" data-talk-id="{talk.id}">
                                <option value="">{i18n.motivation_placeholder}</option>
                                <option>{i18n.motivation_work}</option>
                                <option>{i18n.motivation_learning}</option>
                                <option>{i18n.motivation_speaker}</option>
                                <option>{i18n.motivation_interesting}</option>
                            </select>
                            <label class="attended-label" title="Asistí">
                                <input type="checkbox" class="attended-checkbox" data-talk-id="{talk.id}" {#if
                                    details.attended}checked{/if}>
                            </label>
                            <select id="rating-{talk.id}" class="rating-select hd-form-input" data-talk-id="{talk.id}"
                                title="Valorar">
                                <option value="">-</option>
                                <option value="1" {#if details.rating eq 1}selected{/if}>1</option>
                                <option value="2" {#if details.rating eq 2}selected{/if}>2</option>
                                <option value="3" {#if details.rating eq 3}selected{/if}>3</option>
                                <option value="4" {#if details.rating eq 4}selected{/if}>4</option>
                                <option value="5" {#if details.rating eq 5}selected{/if}>5</option>
                            </select>
                            <button class="hd-btn hd-btn-secondary remove-talk" data-talk-id="{talk.id}"
                                title="Eliminar"><span class="material-symbols-outlined">delete</span></button>
                        </div>
                    </div>
                    {/let}
                    {/for}
                </div>
                {/for}
            </div>
            {/for}
            {/if}
        </section>
        <!-- TODO: ajustar colores/espaciados exactos según maqueta Canva -->
    </div>
</section>

<script>
    function shareProfile(handle) {
        const url = window.location.origin + '/u/' + handle;
        const text = 'Check out my developer profile on HomeDir!';

        if (navigator.share) {
            navigator.share({
                title: 'My HomeDir Profile',
                text: text,
                url: url
            }).catch(console.error);
        } else {
            navigator.clipboard.writeText(url).then(() => {
                alert('Profile link copied to clipboard: ' + url);
            });
        }
    }
    (function () {
        const updateTalk = async (id, data) => {
            try {
                const res = await fetch('/private/profile/update/' + id, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!res.ok) {
                    showNotification('error', '{i18n.msg_error_saving}');
                }
            } catch (e) {
                showNotification('error', '{i18n.msg_error_saving}');
            }
        };

        const updateSummary = () => {
            const total = document.querySelectorAll('.talk-row').length;
            const attended = document.querySelectorAll('.talk-row[data-attended="true"]').length;
            const rated = document.querySelectorAll('.talk-row[data-rated="true"]').length;
            const summary = document.getElementById('summary');
            if (summary) {
                summary.textContent = 'Has agregado ' + total + ' charlas a tu agenda, has asistido a ' + attended + ' y calificado ' + rated + '.';
            }
        };

        document.querySelectorAll('.remove-talk').forEach(btn => {
            btn.addEventListener('click', async () => {
                if (!confirm('{i18n.msg_confirm_delete}')) return;
                const id = btn.dataset.talkId;
                btn.disabled = true;
                try {
                    const res = await fetch('/private/profile/remove/' + id, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                        body: JSON.stringify({})
                    });
                    if (res.ok) {
                        btn.closest('.talk-row').remove();
                        updateSummary();
                    } else {
                        showNotification('error', '{i18n.msg_error_removing}');
                    }
                } catch (e) {
                    showNotification('error', '{i18n.msg_error_removing}');
                }
            });
        });

        document.querySelectorAll('.motivation-select').forEach(select => {
            select.addEventListener('change', async () => {
                const id = select.dataset.talkId;
                const motivation = select.value;
                if (!motivation) return;
                await updateTalk(id, { motivation });
            });
        });

        document.querySelectorAll('.attended-checkbox').forEach(cb => {
            cb.addEventListener('change', async () => {
                const id = cb.dataset.talkId;
                const attended = cb.checked;
                const row = cb.closest('.talk-row');
                row.dataset.attended = attended;
                await updateTalk(id, { attended });
                updateSummary();
            });
        });

        document.querySelectorAll('.rating-select').forEach(sel => {
            sel.addEventListener('change', async () => {
                const id = sel.dataset.talkId;
                const rating = sel.value ? parseInt(sel.value, 10) : null;
                const row = sel.closest('.talk-row');
                row.dataset.rated = rating != null;
                await updateTalk(id, { rating });
                updateSummary();
            });
        });

        const filterButtons = document.querySelectorAll('[data-filter]');
        const rows = document.querySelectorAll('.talk-row');
        filterButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const filter = btn.dataset.filter;
                rows.forEach(row => {
                    const attended = row.dataset.attended === 'true';
                    if (filter === 'attended') row.hidden = !attended;
                    else if (filter === 'pending') row.hidden = attended;
                    else row.hidden = false;
                });
            });
        });
    })();
</script>
{/body}