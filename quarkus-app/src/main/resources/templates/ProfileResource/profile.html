{#include layout/base}
{#title}Mi perfil{/title}
{#main}
<div class="profile-page">
  <div class="profile-banners">
    {#if githubLinked}
      <div class="banner success">Cuenta de GitHub vinculada correctamente.</div>
    {/if}
    {#if githubError??}
      <div class="banner warning">No se pudo vincular GitHub ({githubError}). Int√©ntalo nuevamente.</div>
    {/if}
    {#if githubRequired && github == null}
      <div class="banner info">Vincula GitHub para aparecer en Comunidad y unirte con tu usuario.</div>
    {/if}
  </div>

  <section class="profile-hero">
    <div class="hero-content">
      <p class="eyebrow">Perfil digital</p>
      <h1>{name}</h1>
      <p class="hero-subtitle">Gestiona tu agenda, elige tus charlas favoritas y mantente al d√≠a con la comunidad.</p>
      <div class="hero-actions">
        <a class="btn btn-primary" href="/private/profile">Ver Mi Perfil</a>
        <a class="btn btn-ghost" href="/private/github/start?redirect=/private/profile">Vincular GitHub</a>
      </div>
      <div class="hero-meta">
        <span class="meta-label">Correo</span>
        <strong>{email}</strong>
      </div>
      <p id="summary" class="hero-summary">
        Has agregado {totalTalks} charlas a tu agenda, has asistido a {attendedTalks} y calificado {ratedTalks}.
      </p>
    </div>
    <div class="hero-panel">
      <div class="stat-card">
        <p class="stat-label">Charlas registradas</p>
        <p class="stat-value">{totalTalks}</p>
        <p class="stat-hint">Agregaste {totalTalks} charlas en tu agenda</p>
      </div>
      <div class="stat-card">
        <p class="stat-label">Asistidas</p>
        <p class="stat-value">{attendedTalks}</p>
        <p class="stat-hint">Confirmaste asistencia a {attendedTalks} charlas</p>
      </div>
      <div class="stat-card">
        <p class="stat-label">Calificaciones</p>
        <p class="stat-value">{ratedTalks}</p>
        <p class="stat-hint">Has valorado {ratedTalks} experiencias</p>
      </div>
    </div>
  </section>

  <section class="profile-panels">
    <article class="panel github-panel">
      <div>
        <p class="section-subtitle">Integraciones</p>
        <h2>GitHub</h2>
        {#if github != null}
          <p class="muted">@{github.login} ¬∑ ID {github.id}</p>
          <div class="panel-actions">
            <a class="btn btn-ghost" href="{github.profileUrl}" target="_blank" rel="noopener">Ver perfil</a>
            <a class="btn" href="/private/github/start?redirect=/private/profile">Actualizar v√≠nculo</a>
          </div>
        {#else}
          <p class="muted">A√∫n no vinculado.</p>
          <a class="btn" href="/private/github/start?redirect=/private/profile">Vincular con GitHub</a>
        {/if}
      </div>
    </article>
    <article class="panel schedule-panel">
      <p class="section-subtitle">Comunidad</p>
      <h2>{groups.size()} eventos</h2>
      <p class="muted">{groups.size()} iniciativas activas y colaboraciones abiertas.</p>
      <a class="btn btn-primary" href="/comunidad">Explorar Comunidad</a>
    </article>
  </section>

  <section class="talks-section">
    <div class="talks-heading">
      <div>
        <p class="eyebrow">Agenda</p>
        <h2>Charlas registradas</h2>
      </div>
      <div class="filter">
        <button type="button" class="btn filter-btn" data-filter="all">Todas</button>
        <button type="button" class="btn filter-btn" data-filter="attended">Asistidas</button>
        <button type="button" class="btn filter-btn" data-filter="pending">No asistidas</button>
      </div>
    </div>

    {#if groups.isEmpty()}
      <p class="empty-state">A√∫n no has agregado charlas. Explora eventos y agr√©galos a tu agenda.</p>
    {#else}
      <div class="talk-groups">
        {#for g in groups}
          <div class="talk-group">
            <div class="talk-group-header">
              <h3>{g.event.title}</h3>
              <span class="muted">{g.days.size()} d√≠as ¬∑ {g.event.speakers.size()} speakers</span>
            </div>
            {#for d in g.days}
              <div class="day-block">
                <h4>D√≠a {d.day}</h4>
                <div class="talks-day">
                  {#for t in d.talks}
                    <div class="talk-row" data-talk-id="{t.id}" data-attended="{info.get(t.id).attended}" data-rated="{info.get(t.id).rating??}">
                      <div class="talk-time">
                        <span class="attendance-icon">{#if info.get(t.id).attended}‚úÖ{#else}‚ùå{/if}</span>
                        <span>{t.startTimeStr} ¬∑ {t.endTimeStr}</span>
                      </div>
                      <div class="talk-info">
                        <span class="talk-title"><a href="/event/{g.event.id}/talk/{t.id}">{t.name}</a></span>
                        <div class="speaker-avatars">
                          {#for s in t.speakers}
                            <a href="/speaker/{s.id}" title="{s.name}">
                              {#if app:validUrl(s.photoUrl)}
                                <img src="{s.photoUrl}" alt="{s.name}" class="avatar" />
                              {#else}
                                <span class="avatar placeholder">üë§</span>
                              {/if}
                            </a>
                          {/for}
                        </div>
                        <span class="badge talk-state {app:talkStateClass(t, g.event)}">{app:talkState(t, g.event)}</span>
                      </div>
                      <div class="talk-actions">
                        <div class="motivation-list">
                          {#for m in info.get(t.id).motivations}
                            <span class="badge motivation-badge" data-value="{m}">{m}</span>
                          {/for}
                        </div>
                        <select class="motivation-select" data-talk-id="{t.id}">
                          <option value="">Motivo...</option>
                          <option>‚≠ê Relevante para mi trabajo</option>
                          <option>üß† Quiero aprender sobre esto</option>
                          <option>üé§ Conozco al speaker</option>
                          <option>üéØ Me pareci√≥ interesante</option>
                        </select>
                        <label class="attended-label" title="Asist√≠">
                          <input type="checkbox" class="attended-checkbox" data-talk-id="{t.id}" {#if info.get(t.id).attended}checked{/if}>
                        </label>
                        <select id="rating-{t.id}" class="rating-select" data-talk-id="{t.id}" title="Valorar">
                          <option value="">‚òÖ</option>
                          <option value="1" {#if info.get(t.id).rating == 1}selected{/if}>1</option>
                          <option value="2" {#if info.get(t.id).rating == 2}selected{/if}>2</option>
                          <option value="3" {#if info.get(t.id).rating == 3}selected{/if}>3</option>
                          <option value="4" {#if info.get(t.id).rating == 4}selected{/if}>4</option>
                          <option value="5" {#if info.get(t.id).rating == 5}selected{/if}>5</option>
                        </select>
                        <button class="btn btn-secondary remove-talk" data-talk-id="{t.id}" title="Eliminar">üóëÔ∏è</button>
                      </div>
                    </div>
                  {/for}
                </div>
              </div>
            {/for}
          </div>
        {/for}
      </div>
    {/if}
  </section>

  <p><a href="/logout">Salir</a></p>
</div>

<script>
  (function() {
    const updateTalk = async (id, data) => {
      try {
        const res = await fetch('/private/profile/update/' + id, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify(data)
        });
        if (!res.ok) {
          showNotification('error', 'Error al guardar los cambios');
        }
      } catch (e) {
        showNotification('error', 'Error al guardar los cambios');
      }
    };

    const updateSummary = () => {
      const total = document.querySelectorAll('.talk-row').length;
      const attended = document.querySelectorAll('.talk-row[data-attended="true"]').length;
      const rated = document.querySelectorAll('.talk-row[data-rated="true"]').length;
      const summary = document.getElementById('summary');
      if (summary) {
        summary.textContent = 'Has agregado ' + total + ' charlas a tu agenda, has asistido a ' + attended + ' y calificado ' + rated + '.';
      }
    };

    document.querySelectorAll('.remove-talk').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!confirm('¬øEst√°s seguro?')) return;
        const id = btn.dataset.talkId;
        btn.disabled = true;
        try {
          const res = await fetch('/private/profile/remove/' + id, {
            method: 'POST',
            headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
            body: '{}'
          });
          const contentType = res.headers.get('content-type') || '';
          if (res.ok && contentType.includes('application/json')) {
            const data = await res.json();
            if (data.status === 'removed') {
              const row = btn.closest('.talk-row');
              if (row) row.remove();
              updateSummary();
              showNotification('success', 'Charla eliminada de tu agenda');
              return;
            } else if (data.status === 'error') {
              showNotification('error', data.message || 'Ocurri√≥ un error');
            } else {
              showNotification('error', 'Charla no encontrada');
            }
          } else if (res.status === 401) {
            showNotification('info', 'Debe iniciar sesi√≥n');
          } else {
            showNotification('error', 'Ocurri√≥ un error al eliminar la charla');
          }
        } catch (e) {
          showNotification('error', 'Ocurri√≥ un error al eliminar la charla');
        } finally {
          btn.disabled = false;
        }
      });
    });

    document.querySelectorAll('.attended-checkbox').forEach(cb => {
      cb.addEventListener('change', () => {
        const id = cb.dataset.talkId;
        const attended = cb.checked;
        const row = cb.closest('.talk-row');
        if (row) {
          row.dataset.attended = attended ? 'true' : 'false';
          row.querySelector('.attendance-icon').textContent = attended ? '‚úÖ' : '‚ùå';
        }
        updateTalk(id, { attended });
        updateSummary();
      });
    });

    document.querySelectorAll('.rating-select').forEach(sel => {
      sel.addEventListener('change', () => {
        const id = sel.dataset.talkId;
        const rating = sel.value ? parseInt(sel.value) : null;
        const row = sel.closest('.talk-row');
        if (row) {
          row.dataset.rated = rating ? 'true' : 'false';
        }
        updateTalk(id, { rating });
        updateSummary();
      });
    });

    document.querySelectorAll('.motivation-select').forEach(sel => {
      sel.addEventListener('change', () => {
        const value = sel.value;
        if (!value) return;
        const row = sel.closest('.talk-row');
        const list = row.querySelector('.motivation-list');
        if ([...list.children].some(b => b.dataset.value === value)) {
          sel.value = '';
          return;
        }
        const badge = document.createElement('span');
        badge.className = 'badge motivation-badge';
        badge.dataset.value = value;
        badge.textContent = value;
        badge.addEventListener('click', () => {
          badge.remove();
          saveMotivations(row);
        });
        list.appendChild(badge);
        sel.value = '';
        saveMotivations(row);
      });
    });

    const saveMotivations = (row) => {
      const id = row.dataset.talkId;
      const motivations = [...row.querySelectorAll('.motivation-badge')].map(b => b.dataset.value);
      updateTalk(id, { motivations });
    };

    document.querySelectorAll('.motivation-badge').forEach(badge => {
      badge.addEventListener('click', () => {
        const row = badge.closest('.talk-row');
        badge.remove();
        saveMotivations(row);
      });
    });

    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const filter = btn.dataset.filter;
        document.querySelectorAll('.talk-row').forEach(row => {
          const attended = row.dataset.attended === 'true';
          if (filter === 'all' || (filter === 'attended' && attended) || (filter === 'pending' && !attended)) {
            row.style.display = '';
          } else {
            row.style.display = 'none';
          }
        });
      });
    });

    updateSummary();
  })();
</script>
{/main}
