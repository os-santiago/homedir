{#include layout/main}
{#title}
Moderacion CFP · {event.title}
{/title}
{#body}
<section class="page-header">
  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
      <div>
        <p class="section-subtitle" style="margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 2px; font-size: 0.8rem;">CFP</p>
        <h1 class="page-title">Moderacion CFP</h1>
        <p class="section-subtitle">Evento: {event.title}</p>
      </div>
      <div class="action-group admin-nav-strip">
        <a href="/private/admin" class="btn btn-secondary">Panel admin</a>
        <a href="/private/admin/events" class="btn btn-secondary">Eventos</a>
        <a href="/private/admin/events/{event.id}/edit" class="btn btn-secondary">Editar evento</a>
        <a href="/event/{event.id}/cfp" class="btn btn-secondary">CFP publico</a>
      </div>
    </div>
  </div>
</section>

<div class="container">
  <div class="card" style="margin-bottom: 1rem;">
    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.8rem;">
      <div>
        <h2 class="card-title" style="margin: 0;">Cola de propuestas</h2>
        <p class="form-hint" style="margin-top: 0.35rem;">Evalua propuestas con rating tecnico y prioriza con score ponderado.</p>
      </div>
      <div class="action-group" style="gap: 0.5rem;">
        <button id="reloadCfpBtn" type="button" class="btn btn-secondary">Actualizar</button>
        <a id="exportCsvBtn" href="#" class="btn btn-secondary">Exportar CSV</a>
      </div>
    </div>
    <div class="cfp-toolbar-grid">
      <div class="cfp-toolbar-row">
        <span class="form-hint">Estado:</span>
        <button type="button" class="btn btn-ghost cfp-filter-btn" data-status="all">Todos</button>
        <button type="button" class="btn btn-ghost cfp-filter-btn" data-status="pending">Pendiente</button>
        <button type="button" class="btn btn-ghost cfp-filter-btn" data-status="under_review">En revision</button>
        <button type="button" class="btn btn-ghost cfp-filter-btn" data-status="accepted">Aceptadas</button>
        <button type="button" class="btn btn-ghost cfp-filter-btn" data-status="rejected">Rechazadas</button>
      </div>
      <div class="cfp-toolbar-row">
        <span class="form-hint">Orden:</span>
        <button type="button" class="btn btn-ghost cfp-sort-btn" data-sort="created">Mas recientes</button>
        <button type="button" class="btn btn-ghost cfp-sort-btn" data-sort="score">Mayor score</button>
      </div>
    </div>
  </div>

  <div id="cfpQueueList"></div>
</div>

<style>
  .admin-nav-strip {
    gap: 0.45rem;
  }

  .cfp-toolbar-grid {
    margin-top: 1rem;
    display: grid;
    gap: 0.65rem;
  }

  .cfp-toolbar-row {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.45rem;
  }

  .cfp-filter-btn.is-active,
  .cfp-sort-btn.is-active {
    border-color: rgba(255, 215, 0, 0.7);
    background: rgba(255, 215, 0, 0.12);
  }

  .cfp-admin-card {
    margin-bottom: 0.9rem;
    border: 1px solid rgba(255, 255, 255, 0.16);
    border-radius: var(--radius-sm);
    padding: 0.9rem;
    background: rgba(255, 255, 255, 0.03);
  }

  .cfp-admin-card h3 {
    margin: 0;
    font-size: 1.1rem;
  }

  .cfp-admin-meta {
    font-size: 0.82rem;
    opacity: 0.8;
    margin-top: 0.3rem;
  }

  .cfp-admin-summary {
    margin-top: 0.55rem;
  }

  .cfp-admin-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.75rem;
    align-items: center;
  }

  .cfp-admin-note {
    width: 100%;
    margin-top: 0.55rem;
  }

  .cfp-status-chip {
    display: inline-flex;
    border-radius: 999px;
    border: 1px solid rgba(255, 255, 255, 0.25);
    padding: 0.15rem 0.55rem;
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .cfp-score-chip {
    border-color: rgba(120, 185, 255, 0.7);
    background: rgba(120, 185, 255, 0.14);
    margin-left: 0.35rem;
  }

  .cfp-status-chip--pending {
    border-color: rgba(255, 215, 0, 0.7);
    background: rgba(255, 215, 0, 0.14);
  }

  .cfp-status-chip--under_review {
    border-color: rgba(120, 185, 255, 0.7);
    background: rgba(120, 185, 255, 0.14);
  }

  .cfp-status-chip--accepted {
    border-color: rgba(114, 255, 159, 0.7);
    background: rgba(114, 255, 159, 0.14);
  }

  .cfp-status-chip--rejected {
    border-color: rgba(255, 126, 126, 0.75);
    background: rgba(255, 126, 126, 0.14);
  }

  .cfp-rating-grid {
    margin-top: 0.7rem;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 0.5rem;
  }

  .cfp-rating-item {
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
  }

  .cfp-rating-item label {
    font-size: 0.75rem;
    opacity: 0.85;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .cfp-rating-item select {
    width: 100%;
  }
</style>

<script>
  (() => {
    const eventId = "{event.id}";
    const baseEndpoint = "/api/events/" + encodeURIComponent(eventId) + "/cfp/submissions";
    const listEl = document.getElementById("cfpQueueList");
    const reloadBtn = document.getElementById("reloadCfpBtn");
    const exportBtn = document.getElementById("exportCsvBtn");
    const filterButtons = Array.from(document.querySelectorAll(".cfp-filter-btn"));
    const sortButtons = Array.from(document.querySelectorAll(".cfp-sort-btn"));
    let activeStatus = "pending";
    let activeSort = "created";

    const statusLabel = {
      pending: "Pendiente",
      under_review: "En revision",
      accepted: "Aceptada",
      rejected: "Rechazada",
      withdrawn: "Retirada"
    };

    function setActiveFilter(status) {
      activeStatus = status;
      filterButtons.forEach((button) => {
        button.classList.toggle("is-active", button.dataset.status === status);
      });
      refreshExportUrl();
    }

    function setActiveSort(sort) {
      activeSort = sort;
      sortButtons.forEach((button) => {
        button.classList.toggle("is-active", button.dataset.sort === sort);
      });
      refreshExportUrl();
    }

    function refreshExportUrl() {
      if (!exportBtn) return;
      const params = new URLSearchParams();
      if (activeStatus) params.set("status", activeStatus);
      if (activeSort) params.set("sort", activeSort);
      exportBtn.href = baseEndpoint + "/export.csv?" + params.toString();
    }

    function fmtDate(value) {
      if (!value) return "";
      const dt = new Date(value);
      if (Number.isNaN(dt.getTime())) return "";
      return dt.toLocaleString();
    }

    function row(text) {
      const p = document.createElement("p");
      p.className = "cfp-admin-meta";
      p.textContent = text;
      return p;
    }

    function renderEmpty(message) {
      listEl.innerHTML = "";
      const card = document.createElement("article");
      card.className = "card";
      const p = document.createElement("p");
      p.className = "form-hint";
      p.textContent = message;
      card.appendChild(p);
      listEl.appendChild(card);
    }

    async function updateStatus(submissionId, nextStatus, noteField) {
      const note = noteField ? String(noteField.value || "").trim() : "";
      const response = await fetch(baseEndpoint + "/" + encodeURIComponent(submissionId) + "/status", {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          Accept: "application/json"
        },
        body: JSON.stringify({ status: nextStatus, note: note })
      });
      if (!response.ok) {
        let detail = "";
        try {
          const payload = await response.json();
          if (payload && payload.error) {
            detail = " (" + payload.error + ")";
          }
        } catch (e) {
        }
        throw new Error("No fue posible actualizar estado" + detail);
      }
    }

    async function updateRating(submissionId, rating) {
      const response = await fetch(baseEndpoint + "/" + encodeURIComponent(submissionId) + "/rating", {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          Accept: "application/json"
        },
        body: JSON.stringify(rating)
      });
      if (!response.ok) {
        let detail = "";
        try {
          const payload = await response.json();
          if (payload && payload.error) {
            detail = " (" + payload.error + ")";
          }
        } catch (e) {
        }
        throw new Error("No fue posible guardar rating" + detail);
      }
      return response.json();
    }

    async function promoteSubmission(submissionId) {
      const response = await fetch(baseEndpoint + "/" + encodeURIComponent(submissionId) + "/promote", {
        method: "POST",
        headers: { Accept: "application/json" }
      });
      if (!response.ok) {
        let detail = "";
        try {
          const payload = await response.json();
          if (payload && payload.error) {
            detail = " (" + payload.error + ")";
          }
        } catch (e) {
        }
        throw new Error("No fue posible promover propuesta" + detail);
      }
      return response.json();
    }

    function buildRatingSelect(id, label, value) {
      const wrap = document.createElement("div");
      wrap.className = "cfp-rating-item";

      const lbl = document.createElement("label");
      lbl.setAttribute("for", id);
      lbl.textContent = label;
      wrap.appendChild(lbl);

      const select = document.createElement("select");
      select.className = "form-select";
      select.id = id;
      select.name = id;
      for (let i = 0; i <= 5; i += 1) {
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = String(i);
        if (Number(value) === i) {
          opt.selected = true;
        }
        select.appendChild(opt);
      }
      wrap.appendChild(select);

      return { wrap, select };
    }

    function scoreLabel(item) {
      if (typeof item.rating_weighted === "number") {
        return "Score: " + item.rating_weighted.toFixed(2);
      }
      return "Score: n/a";
    }

    function buildSubmissionCard(item) {
      const article = document.createElement("article");
      article.className = "cfp-admin-card";

      const top = document.createElement("div");
      top.style.display = "flex";
      top.style.justifyContent = "space-between";
      top.style.alignItems = "center";
      top.style.gap = "0.6rem";
      top.style.flexWrap = "wrap";

      const title = document.createElement("h3");
      title.textContent = item.title || "(Sin titulo)";
      top.appendChild(title);

      const chipWrap = document.createElement("div");
      chipWrap.style.display = "flex";
      chipWrap.style.alignItems = "center";
      chipWrap.style.gap = "0.3rem";

      const currentStatus = item.status || "pending";
      const chip = document.createElement("span");
      chip.className = "cfp-status-chip cfp-status-chip--" + currentStatus;
      chip.textContent = statusLabel[currentStatus] || currentStatus;
      chipWrap.appendChild(chip);

      const scoreChip = document.createElement("span");
      scoreChip.className = "cfp-status-chip cfp-score-chip";
      scoreChip.textContent = scoreLabel(item);
      chipWrap.appendChild(scoreChip);
      top.appendChild(chipWrap);
      article.appendChild(top);

      article.appendChild(
          row("Propuesto por: " + (item.proposer_name || item.proposer_user_id || "N/A") + " · " + fmtDate(item.created_at)));

      if (item.level || item.format || item.duration_min) {
        const chips = [];
        if (item.level) chips.push(item.level);
        if (item.format) chips.push(item.format);
        if (item.duration_min) chips.push(item.duration_min + " min");
        article.appendChild(row(chips.join(" · ")));
      }

      if (item.summary) {
        const summary = document.createElement("p");
        summary.className = "cfp-admin-summary";
        summary.textContent = item.summary;
        article.appendChild(summary);
      }

      if (item.abstract_text) {
        const abstractText = document.createElement("p");
        abstractText.className = "cfp-admin-summary";
        abstractText.textContent = item.abstract_text;
        article.appendChild(abstractText);
      }

      const ratings = document.createElement("div");
      ratings.className = "cfp-rating-grid";
      const technical = buildRatingSelect("rating-tech-" + item.id, "Detalle tecnico", item.rating_technical_detail ?? 0);
      const narrative = buildRatingSelect("rating-narrative-" + item.id, "Narrativa", item.rating_narrative ?? 0);
      const impact = buildRatingSelect("rating-impact-" + item.id, "Impacto", item.rating_content_impact ?? 0);
      ratings.appendChild(technical.wrap);
      ratings.appendChild(narrative.wrap);
      ratings.appendChild(impact.wrap);
      article.appendChild(ratings);

      const note = document.createElement("input");
      note.type = "text";
      note.className = "form-input cfp-admin-note";
      note.placeholder = "Nota de moderacion (opcional)";
      note.id = "moderation-note-" + item.id;
      note.name = note.id;
      article.appendChild(note);

      const actions = document.createElement("div");
      actions.className = "cfp-admin-actions";

      function actionButton(label, targetStatus, variant) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = variant;
        btn.textContent = label;
        btn.addEventListener("click", async () => {
          btn.disabled = true;
          try {
            await updateStatus(item.id, targetStatus, note);
            await loadList();
          } catch (error) {
            window.alert(error.message || "Error actualizando estado");
          } finally {
            btn.disabled = false;
          }
        });
        actions.appendChild(btn);
      }

      const saveRatingBtn = document.createElement("button");
      saveRatingBtn.type = "button";
      saveRatingBtn.className = "btn btn-secondary";
      saveRatingBtn.textContent = "Guardar rating";
      saveRatingBtn.addEventListener("click", async () => {
        saveRatingBtn.disabled = true;
        try {
          const payload = await updateRating(item.id, {
            technical_detail: Number(technical.select.value),
            narrative: Number(narrative.select.value),
            content_impact: Number(impact.select.value)
          });
          if (payload && payload.item) {
            item.rating_weighted = payload.item.rating_weighted;
            scoreChip.textContent = scoreLabel(payload.item);
          }
        } catch (error) {
          window.alert(error.message || "Error guardando rating");
        } finally {
          saveRatingBtn.disabled = false;
        }
      });
      actions.appendChild(saveRatingBtn);

      actionButton("En revision", "under_review", "btn btn-secondary");
      actionButton("Aceptar", "accepted", "btn btn-primary");
      actionButton("Rechazar", "rejected", "btn btn-danger");
      if (currentStatus === "accepted") {
        const promoteBtn = document.createElement("button");
        promoteBtn.type = "button";
        promoteBtn.className = "btn btn-secondary";
        promoteBtn.textContent = "Promover a catalogo";
        promoteBtn.addEventListener("click", async () => {
          promoteBtn.disabled = true;
          try {
            const payload = await promoteSubmission(item.id);
            window.alert("Catalogado: " + payload.speaker_id + " / " + payload.talk_id);
          } catch (error) {
            window.alert(error.message || "Error promoviendo propuesta");
          } finally {
            promoteBtn.disabled = false;
          }
        });
        actions.appendChild(promoteBtn);
      }

      article.appendChild(actions);
      return article;
    }

    async function loadList() {
      renderEmpty("Cargando propuestas...");
      try {
        const params = new URLSearchParams({
          status: activeStatus,
          sort: activeSort,
          limit: "100",
          offset: "0"
        });
        const response = await fetch(baseEndpoint + "?" + params.toString(), {
          headers: { Accept: "application/json" }
        });
        if (!response.ok) {
          throw new Error("Error de carga");
        }
        const payload = await response.json();
        const items = (payload && payload.items) ? payload.items : [];
        if (!items.length) {
          renderEmpty("No hay propuestas en este estado.");
          return;
        }
        listEl.innerHTML = "";
        items.forEach((item) => {
          listEl.appendChild(buildSubmissionCard(item));
        });
      } catch (error) {
        renderEmpty("No fue posible cargar propuestas en este momento.");
      }
    }

    filterButtons.forEach((button) => {
      button.addEventListener("click", () => {
        const status = button.dataset.status || "pending";
        setActiveFilter(status);
        loadList();
      });
    });

    sortButtons.forEach((button) => {
      button.addEventListener("click", () => {
        const sort = button.dataset.sort || "created";
        setActiveSort(sort);
        loadList();
      });
    });

    reloadBtn?.addEventListener("click", loadList);
    setActiveFilter(activeStatus);
    setActiveSort(activeSort);
    loadList();
  })();
</script>
{/body}
{/include}

